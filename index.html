<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static's Infinite Factory Tycoon</title>
  <style>
    /* ===============================
       GLOBAL & RESPONSIVE UI
    =============================== */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
      transition: background 0.5s ease;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
      position: relative;
    }
    /* ===============================
       BUTTONS
    =============================== */
    .button {
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      transition: background 0.3s, transform 0.2s;
      display: inline-block;
    }
    .button:hover {
      background-color: #0056b3;
    }
    /* When mass-buy mode is active, upgrade buttons turn baby‚Äëblue */
    .mass-buy-active {
      background-color: #89CFF0 !important;
    }
    /* Special gold style for Product Upgrade */
    .gold-button {
      background-color: #FFD700 !important;
      color: #000 !important;
      font-weight: normal;
    }
    .money-line {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .cooldown {
      font-size: 14px;
      color: #bbb;
    }
    /* ===============================
       CONTAINERS
    =============================== */
    .upgrade-container,
    .selling-container,
    .employee-container {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .upgrade, .employee {
      flex: 1 1 45%;
      margin: 5px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .upgrade:hover, .employee:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    /* ===============================
       MODAL MENUS
    =============================== */
    .modal-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(34, 34, 34, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
      z-index: 10000;
      max-width: 90%;
      font-size: 14px;
    }
    .modal-menu h2 {
      margin-top: 0;
      font-size: 20px;
    }
    /* ===============================
       NOTIFICATION (Top-Right)
    =============================== */
    .notification {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 10000;
      font-size: 16px;
    }
    /* ===============================
       QR CODE (200x200)
    =============================== */
    .qr-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 200px;
      height: 200px;
      z-index: 1500;
    }
    .qr-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* ===============================
       DISABLED BUTTON
    =============================== */
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* ===============================
       SPARKLE ANIMATION
    =============================== */
    @keyframes sparkle {
      0% { box-shadow: 0 0 5px #fff; }
      50% { box-shadow: 0 0 20px #fff; }
      100% { box-shadow: 0 0 5px #fff; }
    }
    .sparkle {
      animation: sparkle 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <!-- Notification (top-right) -->
  <div class="notification" id="notificationBox"></div>

  <div class="container">
    <p class="money-line">
      üí∞ Money: $<span id="money">0</span>
      | üåü Prestige Points: <span id="prestigePoints">0</span> ‚Ñó
    </p>
    <p>
      üîÑ Multiplier: x<span id="multiplier">1.00</span>
      | Prestige Multi: x<span id="prestigeMulti">1.00</span>
    </p>

    <h2>üè≠ Factory Production</h2>
    <p>üè≠ Factory: <span id="factoryName"></span></p>
    <p>
      üì¶ Product: <span id="productName"></span>
      (Base: <span id="productBase">0</span>, Batch: <span id="productBatch">1</span>)
    </p>
    <!-- Produce Button with tooltip showing potential earnings and cooldown -->
    <button class="button" id="produce" title="Produce Product">üöÄ Produce Product</button>
    <p class="cooldown" id="cooldown">‚è≥ Cooldown: Ready</p>

    <!-- Normal Upgrades (displayed above selling) -->
    <div class="upgrade-container">
      <h2 style="width:100%;">üìà Upgrades</h2>
      <div id="upgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Selling System (hidden until unlocked) -->
    <div class="selling-container" id="sellingArea" style="display:none;">
      <h2>üíº Selling System</h2>
      <p>Backpack: <span id="backpackUsed">0</span> / <span id="backpackCapacity">0</span></p>
      <button class="button" id="sellAll" title="Sell all stored items">Sell All</button>
      <p class="cooldown" id="sellCooldown">üïí Selling Timer: Ready</p>
      <div id="sellingUpgrades"></div>
    </div>

    <!-- Employees (positioned below selling system) -->
    <div class="employee-container">
      <h2 style="width:100%;">üë• Employees</h2>
      <div id="employees" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Buttons for Prestige, Stats, Settings -->
    <div style="margin-top:20px;">
      <button class="button" id="prestige">üîÑ Prestige</button>
      <button class="button" id="statsBtn">üìä Stats</button>
      <button class="button" id="settingsBtn">‚öô Settings</button>
    </div>

    <!-- Credits -->
    <p style="margin-top:30px;">
      Made By <a href="https://sites.google.com/view/staticquasar931" target="_blank" style="color:#00d1ff;">Static</a>
    </p>
  </div>

  <!-- QR Code (200x200) -->
  <div class="qr-container">
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
      <img src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png" alt="Qr Code linking to Static's site" title="Click to visit Static's site">
    </a>
  </div>

  <!-- Prestige Menu -->
  <div class="modal-menu" id="prestigeMenu">
    <h2>üîÑ Prestige Confirmation</h2>
    <p>
      Prestiging resets your money, normal upgrades, employees, and backpack.<br>
      Current Factory Base: <strong><span id="baseValue">0</span></strong> &nbsp;&nbsp; Next Factory Base: <strong><span id="bestValue">0</span></strong>
    </p>
    <p>Current PP: <span id="livePP">0</span> ‚Ñó &nbsp;&nbsp; Potential PP: <span id="earnedPP">0</span> ‚Ñó</p>
    <p>üè≠ Current Factory: <span id="currentFactory"></span></p>
    <p>üè≠ Next Factory: <span id="nextFactory"></span></p>
    <div id="prestigeUpgradesMenu"></div>
    <button class="button" id="confirmPrestige">‚úî Confirm</button>
    <button class="button" id="closePrestige">‚ùå Cancel</button>
  </div>

  <!-- Stats Menu -->
  <div class="modal-menu" id="statsMenu">
    <h2>üìä Stats</h2>
    <div id="statsContent"></div>
    <button class="button" id="closeStats">‚ùå Close</button>
  </div>

  <!-- Settings Menu (with keybind tips) -->
  <div class="modal-menu" id="settingsMenu">
    <h2>‚öô Settings</h2>
    <p><strong>Keybinds:</strong></p>
    <ul style="text-align:left; max-width:400px; margin:auto;">
      <li>Produce: Q, W, Up Arrow, Left Arrow</li>
      <li>Sell All: E, S, Down Arrow, Right Arrow</li>
      <li>Mass Buy: Hold Shift or Space (upgrade buttons turn baby blue and display (xN))</li>
    </ul>
    <p>Your progress is auto‚Äësaved. Selling system details remain hidden until unlocked.</p>
    <button class="button" id="resetGame">üîÅ Reset Progress</button>
    <p id="resetTimer" style="color:#f55;"></p>
    <p style="color:#f33; font-weight:bold;">Warning: The Undo may not work in all browsers if you refresh quickly.</p>
    <button class="button" id="closeSettings">‚ùå Close</button>
  </div>

  <!-- Selling Explanation Popup (after 1st Prestige) -->
  <div class="modal-menu" id="sellExplain" style="display:none;">
    <h2>üéâ Selling System Unlocked!</h2>
    <p>
      Now, producing products stores them in a backpack instead of awarding money immediately.<br>
      Use "Sell All" or the keybinds (E, S, Down/Right Arrow) to convert stored items into cash.
    </p>
    <button class="button" id="closeSellExplain">Got It</button>
  </div>

  <script>
    "use strict";
    /****************************
     * 1. NUMBER FORMATTING
     ****************************/
    const scaleUnits = [
      { v: 1e3, l: "K" },
      { v: 1e6, l: "M" },
      { v: 1e9, l: "B" },
      { v: 1e12, l: "T" },
      { v: 1e15, l: "Qa" },
      { v: 1e18, l: "Qi" },
      { v: 1e21, l: "Sx" },
      { v: 1e24, l: "Sp" },
      { v: 1e27, l: "Oc" },
      { v: 1e30, l: "No" },
      { v: 1e33, l: "De" },
      { v: 1e36, l: "Ud" },
      { v: 1e39, l: "Dd" },
      { v: 1e42, l: "Td" },
      { v: 1e45, l: "Qd" },
      { v: 1e48, l: "Pd" },
      { v: 1e51, l: "Hd" }
    ];
    function formatNumber(num) {
      if(num===0) return "0.00";
      const abs = Math.abs(num), sign = (num < 0) ? "-" : "";
      if(abs >= 1e100) return sign + abs.toExponential(3);
      for(let i = scaleUnits.length - 1; i >= 0; i--) {
        if(abs >= scaleUnits[i].v) {
          return sign + (abs / scaleUnits[i].v).toFixed(2) + " " + scaleUnits[i].l;
        }
      }
      return sign + abs.toFixed(2);
    }
    function formatCooldown(ms) {
      if(ms <= 0) return "0s";
      let s = ms / 1000;
      return s.toFixed(2) + "s";
    }

    /****************************
     * 2. GAME STATE
     ****************************/
    let money = parseFloat(localStorage.getItem("money")) || 0;
    let totalEarned = parseFloat(localStorage.getItem("totalEarned")) || 0;
    let prestigePoints = parseFloat(localStorage.getItem("prestigePoints")) || 0;
    let multiplier = parseFloat(localStorage.getItem("multiplier")) || 1;
    let prestigeMulti = parseFloat(localStorage.getItem("prestigeMulti")) || 1;
    let totalProductsProduced = parseInt(localStorage.getItem("totalProductsProduced")) || 0;
    let productBatch = parseInt(localStorage.getItem("productBatch")) || 1;
    let factoryIndex = parseInt(localStorage.getItem("factoryIndex")) || 0;
    let currentProductIndex = parseInt(localStorage.getItem("currentProductIndex")) || 0;
    let cooldownTime = parseFloat(localStorage.getItem("cooldownTime")) || 5000;
    let maxMoneyHeld = parseFloat(localStorage.getItem("maxMoneyHeld")) || 0;
    let vipChance = parseFloat(localStorage.getItem("vipChance")) || 0.05;
    let vipMultiplier = parseFloat(localStorage.getItem("vipMultiplier")) || 20;
    let prestigeCount = parseInt(localStorage.getItem("prestigeCount")) || 0;
    let nextPPcost = parseFloat(localStorage.getItem("nextPPcost")) || 1000;
    let challengeBonusApplied = (localStorage.getItem("challengeBonusApplied") === "true");
    let lastSaveTime = parseInt(localStorage.getItem("lastSaveTime")) || Date.now();

    // SELLING system (hidden until first prestige)
    let sellingUnlocked = (prestigeCount > 0);
    let backpackCapacity = parseInt(localStorage.getItem("backpackCapacity")) || 10;
    let backpackUsed = parseInt(localStorage.getItem("backpackUsed")) || 0;
    let sellingTime = 3000;
    let autoProduce = (localStorage.getItem("autoProduce") === "true");
    let autoSell = (localStorage.getItem("autoSell") === "true");

    // SHIFT/SPACE detection
    let shiftDown = false, spaceDown = false;
    let keyDownSet = new Set();
    let resetInProgress = false;

    // Offline production seconds
    let offlineDiffSec = Math.floor((Date.now() - lastSaveTime) / 1000);

    /****************************
     * 3. FACTORIES (ordered)
     ****************************/
    const factories = [
      {
        name: "üß∏ Children's Toys Factory",
        bg: "linear-gradient(to right, #ff9a9e, #fad0c4)",
        products: [
          { name: "Wooden Blocks", base: 10 },
          { name: "Toy Cars", base: 15 },
          { name: "Stuffed Animals", base: 20 },
          { name: "Puzzle Games", base: 25 },
          { name: "Action Figures", base: 30 },
          { name: "Dollhouses", base: 35 },
          { name: "Remote Control Cars", base: 40 },
          { name: "Educational Kits", base: 45 },
          { name: "Model Trains", base: 50 },
          { name: "Custom Playsets", base: 60 }
        ]
      },
      {
        name: "üç∞ Sweet Treats Bakery",
        bg: "linear-gradient(to right, #fbc2eb, #a6c1ee)",
        products: [
          { name: "Cupcakes", base: 12 },
          { name: "Cookies", base: 18 },
          { name: "Brownies", base: 24 },
          { name: "Donuts", base: 30 },
          { name: "Muffins", base: 36 },
          { name: "Pastries", base: 42 },
          { name: "Cakes", base: 50 },
          { name: "Macarons", base: 58 },
          { name: "Eclairs", base: 66 },
          { name: "Gourmet Pies", base: 75 }
        ]
      },
      {
        name: "üé® Artisan Crafts Workshop",
        bg: "linear-gradient(to right, #a1c4fd, #c2e9fb)",
        products: [
          { name: "Handmade Cards", base: 14 },
          { name: "Ceramic Mugs", base: 20 },
          { name: "Knitted Scarves", base: 26 },
          { name: "Wooden Toys", base: 32 },
          { name: "Painted Vases", base: 38 },
          { name: "Handcrafted Jewelry", base: 44 },
          { name: "Embroidered Pillows", base: 50 },
          { name: "Custom Furniture", base: 58 },
          { name: "Vintage Clocks", base: 66 },
          { name: "Bespoke Art Pieces", base: 75 }
        ]
      },
      {
        name: "üì± Tech Gadget Studio",
        bg: "linear-gradient(to right, #a18cd1, #fbc2eb)",
        products: [
          { name: "Smartphone Cases", base: 16 },
          { name: "Wireless Earbuds", base: 22 },
          { name: "Portable Chargers", base: 28 },
          { name: "Bluetooth Speakers", base: 34 },
          { name: "Smartwatches", base: 40 },
          { name: "Tablet Accessories", base: 46 },
          { name: "VR Headsets", base: 52 },
          { name: "Drone Kits", base: 60 },
          { name: "Gaming Controllers", base: 68 },
          { name: "Advanced Gadgets", base: 78 }
        ]
      },
      {
        name: "üíé Luxury Gift Atelier",
        bg: "linear-gradient(to right, #ffecd2, #fcb69f)",
        products: [
          { name: "Artisanal Chocolates", base: 18 },
          { name: "Designer Scarves", base: 26 },
          { name: "Luxury Candles", base: 34 },
          { name: "Fine Wines", base: 42 },
          { name: "Handcrafted Jewelry", base: 50 },
          { name: "Exclusive Perfumes", base: 58 },
          { name: "Gourmet Baskets", base: 66 },
          { name: "Limited Edition Watches", base: 74 },
          { name: "Premium Leather Goods", base: 82 },
          { name: "Custom Masterpieces", base: 90 }
        ]
      },
      {
        name: "üîû Adult Toys Factory",
        bg: "linear-gradient(to right, #4f0000, #8b0000)",
        products: [
          { name: "Basic Toys", base: 200 },
          { name: "Novelty Items", base: 500 },
          { name: "Special Editions", base: 800 },
          { name: "Themed Sets", base: 1200 },
          { name: "Remote-Controlled", base: 1800 },
          { name: "Luxury Models", base: 2500 },
          { name: "Smart Devices", base: 4000 },
          { name: "Premium Kits", base: 6000 },
          { name: "Custom Orders", base: 10000 },
          { name: "Futuristic Concepts", base: 20000 }
        ]
      }
    ];

    /****************************
     * 4. EMPLOYEES
     ****************************/
    let employees = JSON.parse(localStorage.getItem("employees")) || [
      { name: "üë∑ Worker #1", cost: 75, rate: 1, quantity: 0, description: "Generates $1/sec + ?", purchased: 0 },
      { name: "üë®‚Äçüîß Worker #2", cost: 500, rate: 5, quantity: 0, description: "Generates $5/sec + ?", purchased: 0 },
      { name: "üì¶ Porter #3", cost: 1500, rate: 0, quantity: 0, description: "Slowly increases backpack capacity? ???", purchased: 0 }
    ];
    let employeeTraining = JSON.parse(localStorage.getItem("employeeTraining")) || {
      unlocked: false,
      cost: 200,
      effect: 1.2,
      purchased: false,
      description: "All employees +20% production."
    };

    /****************************
     * 5. NORMAL UPGRADES
     ****************************/
    let upgrades = JSON.parse(localStorage.getItem("upgrades")) || [
      { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
      { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
      { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product tier.", purchased: 0 },
      { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
      { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 }
    ];

    /****************************
     * 6. PRESTIGE UPGRADES
     ****************************/
    let prestigeUpgrades = JSON.parse(localStorage.getItem("prestigeUpgrades")) || [
      {
        name: "Divine Efficiency ‚ú®",
        cost: 5,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Temporal Mastery ‚è≥",
        cost: 10,
        effect: 0.95,
        description: "Cooldown -5%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Eternal Workshop üè≠",
        cost: 25,
        effect: 1.25,
        description: "Product base value +25%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Auto Tycoon (Stage)",
        cost: 500,
        effect: "autoStage",
        description: "Stage 1 => ???, Stage 2 => ???",
        purchased: 0,
        max: 2
      },
      {
        name: "Prestige Pure Multi",
        cost: 20,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "VIP Client Order",
        cost: 30,
        effect: 0.02,
        description: "VIP chance +2% (cap 30%), VIP multi +5%.",
        purchased: 0,
        max: 500
      },
      {
        name: "Selling Speed Mastery",
        cost: 50,
        effect: 0.9,
        description: "Selling time -10%.",
        purchased: 0,
        max: 10
      }
    ];

    /****************************
     * 7. BACKPACK DATA & SELLING UPGRADES
     ****************************/
    let backpackIndex = parseInt(localStorage.getItem("backpackIndex")) || 0;
    let backpackData = JSON.parse(localStorage.getItem("backpackData"));
    if (!backpackData) {
      backpackData = [];
      for (let i = 1; i <= 30; i++) {
        backpackData.push({
          name: `Backpack #${i}`,
          cost: Math.round(100 * Math.pow(2.5, i)),
          effect: 10 * i
        });
      }
      backpackData.push({ name: "A Hole", cost: 1e8, effect: 1000 });
      backpackData.push({ name: "A Bigger Hole", cost: 5e9, effect: 5000 });
    }
    let sellMultiIndex = parseInt(localStorage.getItem("sellMultiIndex")) || 0;
    let sellMultiLevels = [40, 30, 20, 10, 5];
    let sellMultiCost = parseFloat(localStorage.getItem("sellMultiCost")) || 1000;
    let sellingUpgrades = JSON.parse(localStorage.getItem("sellingUpgrades")) || [
      {
        name: "Faster Sell",
        cost: 3000,
        effect: 0.9,
        desc: "Selling time -10% each purchase (cost doubles).",
        purchased: 0
      }
    ];

    /****************************
     * 8. OFFLINE PRODUCTION
     ****************************/
    if (offlineDiffSec > 0) {
      setTimeout(() => {
        let eRate = employees.reduce((sum, e) => sum + (e.rate * e.quantity), 0);
        if (eRate > 0) {
          let earned = eRate * multiplier * prestigeMulti * offlineDiffSec;
          money += earned;
          totalEarned += earned;
          showNotification(`While offline for ${offlineDiffSec}s, you earned $${formatNumber(earned)}!`);
          updateUI();
        }
      }, 50);
    }

    /****************************
     * 9. SAVE FUNCTION
     ****************************/
    function saveGame() {
      if (resetInProgress) return;
      localStorage.setItem("money", money);
      localStorage.setItem("totalEarned", totalEarned);
      localStorage.setItem("prestigePoints", prestigePoints);
      localStorage.setItem("multiplier", multiplier);
      localStorage.setItem("prestigeMulti", prestigeMulti);
      localStorage.setItem("cooldownTime", cooldownTime);
      localStorage.setItem("totalProductsProduced", totalProductsProduced);
      localStorage.setItem("challengeBonusApplied", challengeBonusApplied);
      localStorage.setItem("productBatch", productBatch);
      localStorage.setItem("factoryIndex", factoryIndex);
      localStorage.setItem("currentProductIndex", currentProductIndex);
      localStorage.setItem("maxMoneyHeld", maxMoneyHeld);
      localStorage.setItem("vipChance", vipChance);
      localStorage.setItem("vipMultiplier", vipMultiplier);
      localStorage.setItem("prestigeCount", prestigeCount);
      localStorage.setItem("nextPPcost", nextPPcost);
      localStorage.setItem("lastSaveTime", Date.now());

      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("employeeTraining", JSON.stringify(employeeTraining));
      localStorage.setItem("upgrades", JSON.stringify(upgrades));
      localStorage.setItem("prestigeUpgrades", JSON.stringify(prestigeUpgrades));

      localStorage.setItem("sellingUnlocked", sellingUnlocked);
      localStorage.setItem("backpackCapacity", backpackCapacity);
      localStorage.setItem("backpackUsed", backpackUsed);
      localStorage.setItem("autoProduce", autoProduce);
      localStorage.setItem("autoSell", autoSell);
      localStorage.setItem("sellMultiIndex", sellMultiIndex);
      localStorage.setItem("sellMultiCost", sellMultiCost);
      localStorage.setItem("sellingUpgrades", JSON.stringify(sellingUpgrades));
      localStorage.setItem("backpackIndex", backpackIndex);
      localStorage.setItem("backpackData", JSON.stringify(backpackData));
    }

    /****************************
     * 10. MASS BUY DETECTION & UI
     ****************************/
    // For max-buy, we now store each upgrade button‚Äôs base label in a data attribute.
    function refreshMassBuyUI() {
      // Only upgrade buttons get the mass-buy style and updated text.
      const upgradeBtns = document.querySelectorAll(".upgrade[data-upg-index]");
      upgradeBtns.forEach(btn => {
        const index = btn.getAttribute("data-upg-index");
        const upg = upgrades[index];
        let baseText = `${upg.name} ($${formatNumber(upg.cost)})`;
        if (shiftDown || spaceDown) {
          btn.classList.add("mass-buy-active");
          let count = Math.floor(money / upg.cost);
          if (count > 0) {
            btn.innerText = baseText + ` (x${count})`;
          } else {
            btn.innerText = baseText;
          }
        } else {
          btn.classList.remove("mass-buy-active");
          btn.innerText = baseText;
        }
      });
      // Repeat similar for selling upgrades
      const sellingBtns = document.querySelectorAll(".upgrade[data-sell-index]");
      sellingBtns.forEach(btn => {
        const index = btn.getAttribute("data-sell-index");
        const su = sellingUpgrades[index];
        let baseText = `${su.name} ($${formatNumber(su.cost)})`;
        if (shiftDown || spaceDown) {
          btn.classList.add("mass-buy-active");
          let count = Math.floor(money / su.cost);
          if (count > 0) {
            btn.innerText = baseText + ` (x${count})`;
          } else {
            btn.innerText = baseText;
          }
        } else {
          btn.classList.remove("mass-buy-active");
          btn.innerText = baseText;
        }
      });
      // And for the Backpack upgrade button (if present)
      const bpBtn = document.querySelector(".upgrade[data-bp-index]");
      if (bpBtn) {
        const index = bpBtn.getAttribute("data-bp-index");
        const bp = backpackData[index];
        let baseText = `${bp.name} ($${formatNumber(bp.cost)})`;
        if (shiftDown || spaceDown) {
          bpBtn.classList.add("mass-buy-active");
          let count = Math.floor(money / bp.cost);
          if (count > 0) {
            bpBtn.innerText = baseText + ` (x${count})`;
          } else {
            bpBtn.innerText = baseText;
          }
        } else {
          bpBtn.classList.remove("mass-buy-active");
          bpBtn.innerText = baseText;
        }
      }
    }

    /****************************
     * 11. NOTIFICATION & SPARKLE
     ****************************/
    function showNotification(msg) {
      const box = document.getElementById("notificationBox");
      box.innerText = msg;
      box.style.display = "block";
      setTimeout(() => { box.style.display = "none"; }, 3000);
    }
    function sparkleButton(btn) {
      btn.classList.add("sparkle");
      setTimeout(() => { btn.classList.remove("sparkle"); }, 500);
    }

    /****************************
     * 12. CLAMP TIMES
     ****************************/
    function clampTimes() {
      if (cooldownTime < 50) cooldownTime = 50;
      if (sellingTime < 50) sellingTime = 50;
    }

    /****************************
     * 13. UI UPDATE
     ****************************/
    function updateUI() {
      clampTimes();
      if (money > maxMoneyHeld) maxMoneyHeld = money;
      document.getElementById("money").innerText = formatNumber(money);
      document.getElementById("prestigePoints").innerText = formatNumber(prestigePoints);
      document.getElementById("multiplier").innerText = formatNumber(multiplier);
      document.getElementById("prestigeMulti").innerText = formatNumber(prestigeMulti);

      const f = factories[factoryIndex];
      document.getElementById("factoryName").innerText = f.name;
      const prod = f.products[currentProductIndex];
      document.getElementById("productName").innerText = prod.name;
      document.getElementById("productBase").innerText = formatNumber(prod.base);
      document.getElementById("productBatch").innerText = productBatch;

      // Produce button tooltip
      let potential = prod.base * multiplier * prestigeMulti * productBatch;
      let tip = `Potential Earn (no VIP): ~$${formatNumber(potential)}\nCooldown: ${formatCooldown(cooldownTime)}`;
      if (shiftDown || spaceDown) tip += "\n(Mass Buy Mode)";
      document.getElementById("produce").title = tip;

      // Selling system display
      const sellArea = document.getElementById("sellingArea");
      if (sellingUnlocked) {
        sellArea.style.display = "block";
        document.getElementById("backpackUsed").innerText = backpackUsed;
        document.getElementById("backpackCapacity").innerText = backpackCapacity;
      } else {
        sellArea.style.display = "none";
      }
      const produceBtn = document.getElementById("produce");
      if (sellingUnlocked && backpackUsed >= backpackCapacity) {
        produceBtn.disabled = true;
        produceBtn.classList.add("disabled");
      } else {
        produceBtn.disabled = false;
        produceBtn.classList.remove("disabled");
      }

      renderUpgrades();
      renderSellingUpgrades();
      renderEmployees();
      checkEmployeeTrainingUnlock();
      renderEmployeeTraining();
      updatePrestigeMenu();
      updateBackground();
      refreshMassBuyUI();
      saveGame();
    }
    function updateBackground() {
      document.body.style.background = factories[factoryIndex].bg;
    }

    /****************************
     * 14. NORMAL UPGRADES
     ****************************/
    function renderUpgrades() {
      const cont = document.getElementById("upgrades");
      cont.innerHTML = "";
      upgrades.forEach((upg, i) => {
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        // Store upgrade index as data attribute
        btn.setAttribute("data-upg-index", i);
        if (upg.name === "Product Upgrade") btn.classList.add("gold-button");
        let baseLabel = `${upg.name} ($${formatNumber(upg.cost)})`;
        btn.innerText = baseLabel;
        btn.title = upg.description;
        if (upg.name === "Product Upgrade") {
          const f = factories[factoryIndex];
          if (currentProductIndex >= f.products.length - 1) {
            btn.disabled = true;
            btn.innerText = `${upg.name} (Max)`;
          }
        }
        btn.onclick = () => {
          if (money >= upg.cost) {
            if (shiftDown || spaceDown) {
              while (money >= upg.cost) {
                if (!attemptUpgradePurchase(upg)) break;
              }
              sparkleButton(btn);
              updateUI();
            } else {
              attemptUpgradePurchase(upg);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptUpgradePurchase(upg) {
      if (money >= upg.cost) {
        money -= upg.cost;
        upg.purchased++;
        if (upg.name === "‚öôÔ∏è Speedy Assembly" || upg.name === "üè≠ Factory Expansion") {
          cooldownTime *= upg.effect;
        } else if (upg.name === "Product Upgrade") {
          const f = factories[factoryIndex];
          if (currentProductIndex < f.products.length - 1) currentProductIndex++;
        } else if (upg.effect === "increaseBatch") {
          productBatch++;
        } else {
          multiplier *= upg.effect;
        }
        if (upg.purchased < 5) upg.cost = Math.round(upg.cost * 1.6);
        else upg.cost = Math.round(upg.cost * 2.5);
        return true;
      }
      return false;
    }

    /****************************
     * 15. SELLING UPGRADES & BACKPACK UPGRADE
     ****************************/
    function renderSellingUpgrades() {
      const cont = document.getElementById("sellingUpgrades");
      cont.innerHTML = "";
      if (!sellingUnlocked) return;
      // Backpack Upgrade Button
      const bp = backpackData[backpackIndex];
      const bpBtn = document.createElement("button");
      bpBtn.className = "button upgrade";
      bpBtn.setAttribute("data-bp-index", backpackIndex);
      let bpLabel = `${bp.name} ($${formatNumber(bp.cost)})`;
      bpBtn.innerText = bpLabel;
      bpBtn.title = `Increase storage by +${bp.effect}`;
      bpBtn.onclick = () => {
        if (money >= bp.cost) {
          if (shiftDown || spaceDown) {
            while (money >= bp.cost) {
              if (!purchaseBackpack(bp)) break;
            }
            sparkleButton(bpBtn);
            updateUI();
          } else {
            purchaseBackpack(bp);
            sparkleButton(bpBtn);
            updateUI();
          }
        }
      };
      cont.appendChild(bpBtn);
      // Sell Multi Upgrade Button
      const smBtn = document.createElement("button");
      smBtn.className = "button upgrade";
      smBtn.setAttribute("data-sell-index", 0);
      let eff = sellMultiLevels[sellMultiIndex] || 5;
      let smLabel = `Selling Multi +${eff}% ($${formatNumber(sellMultiCost)})`;
      smBtn.innerText = smLabel;
      smBtn.title = `Boost money from sells by +${eff}% (Cost doubles each time)`;
      smBtn.onclick = () => {
        if (money >= sellMultiCost) {
          if (shiftDown || spaceDown) {
            while (money >= sellMultiCost) {
              if (!purchaseSellMulti()) break;
            }
            sparkleButton(smBtn);
            updateUI();
          } else {
            purchaseSellMulti();
            sparkleButton(smBtn);
            updateUI();
          }
        }
      };
      cont.appendChild(smBtn);
      // Additional Selling Upgrades (e.g., Faster Sell)
      sellingUpgrades.forEach((su, i) => {
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.setAttribute("data-sell-index", i + 1);
        let label = `${su.name} ($${formatNumber(su.cost)})`;
        btn.innerText = label;
        btn.title = su.desc;
        btn.onclick = () => {
          if (money >= su.cost) {
            if (shiftDown || spaceDown) {
              while (money >= su.cost) {
                if (!attemptSellingUpgrade(su)) break;
              }
              sparkleButton(btn);
              updateUI();
            } else {
              attemptSellingUpgrade(su);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function purchaseBackpack(bp) {
      if (money >= bp.cost) {
        money -= bp.cost;
        backpackCapacity += bp.effect;
        if (backpackIndex < backpackData.length - 1) {
          backpackIndex++;
        } else {
          // Infinite scaling: double cost and increase effect by 50%
          bp.cost = Math.round(bp.cost * 2);
          bp.effect = Math.round(bp.effect * 1.5);
        }
        return true;
      }
      return false;
    }
    function purchaseSellMulti() {
      if (money >= sellMultiCost) {
        money -= sellMultiCost;
        let eff = sellMultiLevels[sellMultiIndex] || 5;
        multiplier *= (1 + eff / 100);
        if (sellMultiIndex < sellMultiLevels.length - 1) sellMultiIndex++;
        sellMultiCost = Math.round(sellMultiCost * 2);
        return true;
      }
      return false;
    }
    function attemptSellingUpgrade(su) {
      if (money >= su.cost) {
        money -= su.cost;
        su.purchased++;
        if (su.name === "Faster Sell") {
          sellingTime *= su.effect;
          su.cost = Math.round(su.cost * 2);
        }
        return true;
      }
      return false;
    }

    /****************************
     * 16. EMPLOYEES
     ****************************/
    function renderEmployees() {
      const cont = document.getElementById("employees");
      cont.innerHTML = "";
      employees.forEach((emp) => {
        const btn = document.createElement("button");
        btn.className = "button employee";
        let label = `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        btn.innerText = label;
        let desc = emp.description;
        if (emp.name.includes("Porter") && sellingUnlocked) {
          desc = "Generates $0/sec. Slowly adds +1 capacity every 10s.";
        }
        let baseRate = emp.rate;
        let withMulti = (emp.rate * multiplier).toFixed(2);
        btn.title = `${desc}\nBase: $${baseRate}/sec, With Multi: $${withMulti}/sec`;
        btn.onclick = () => {
          if (money >= emp.cost) {
            if (shiftDown || spaceDown) {
              while (money >= emp.cost) {
                if (!attemptEmployeePurchase(emp)) break;
              }
              updateUI();
            } else {
              attemptEmployeePurchase(emp);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptEmployeePurchase(emp) {
      if (money >= emp.cost) {
        money -= emp.cost;
        emp.quantity++;
        emp.purchased++;
        if (emp.purchased < 5) emp.cost = Math.round(emp.cost * 1.5);
        else emp.cost = Math.round(emp.cost * 2.2);
        return true;
      }
      return false;
    }
    function renderEmployeeTraining() {
      if (employeeTraining.unlocked && !employeeTraining.purchased) {
        const cont = document.getElementById("upgrades");
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.setAttribute("data-upg-index", "training");
        let label = `Employee Training ($${formatNumber(employeeTraining.cost)})`;
        btn.innerText = label;
        btn.title = employeeTraining.description;
        btn.onclick = () => {
          if (money >= employeeTraining.cost) {
            money -= employeeTraining.cost;
            employeeTraining.purchased = true;
            employees.forEach(e => e.rate = Math.round(e.rate * employeeTraining.effect));
            updateUI();
          }
        };
        cont.appendChild(btn);
      }
    }
    function checkEmployeeTrainingUnlock() {
      let total = employees.reduce((sum, e) => sum + e.quantity, 0);
      if (total >= 10) employeeTraining.unlocked = true;
    }

    /****************************
     * 17. PASSIVE EMPLOYEE INCOME
     ****************************/
    setInterval(() => {
      let totalProd = employees.reduce((sum, e) => sum + (e.rate * e.quantity), 0);
      if (totalProd > 0) {
        let inc = totalProd * multiplier * prestigeMulti;
        money += inc;
        totalEarned += inc;
        updateUI();
      }
    }, 1000);

    /****************************
     * 18. PRODUCE & KEYBINDS
     ****************************/
    let producing = false, produceInterval = null;
    const produceKeys = ["q", "w"];
    const produceCodes = ["ArrowUp", "ArrowLeft"];
    const sellKeys = ["e", "s"];
    const sellCodes = ["ArrowDown", "ArrowRight"];
    document.getElementById("produce").addEventListener("click", () => {
      if (!producing) {
        doProduce();
        sparkleButton(document.getElementById("produce"));
      }
    });
    function doProduce() {
      producing = true;
      clampTimes();
      let cd = cooldownTime;
      if (produceInterval) clearInterval(produceInterval);
      produceInterval = setInterval(() => {
        cd -= 50;
        if (cd < 0) cd = 0;
        document.getElementById("cooldown").innerText = `‚è≥ Cooldown: ${formatCooldown(cd)}`;
        if (cd <= 0) {
          clearInterval(produceInterval);
          let f = factories[factoryIndex];
          let p = f.products[currentProductIndex];
          let totalVal = p.base * multiplier * prestigeMulti * productBatch;
          if (!sellingUnlocked) {
            if (Math.random() < vipChance) {
              totalVal *= vipMultiplier;
              showNotification(`VIP order! +${vipMultiplier}x bonus`);
            }
            money += totalVal;
            totalEarned += totalVal;
          } else {
            let space = backpackCapacity - backpackUsed;
            let actual = (productBatch > space) ? space : productBatch;
            backpackUsed += actual;
          }
          totalProductsProduced++;
          if (!challengeBonusApplied && totalProductsProduced >= 100) {
            multiplier *= 1.1;
            challengeBonusApplied = true;
            showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
          }
          producing = false;
          document.getElementById("cooldown").innerText = "‚è≥ Cooldown: Ready";
          updateUI();
        }
      }, 50);
    }
    document.getElementById("sellAll").addEventListener("click", () => {
      if (!selling && sellingUnlocked && backpackUsed > 0) {
        doSellAll();
        sparkleButton(document.getElementById("sellAll"));
      }
    });
    function doSellAll() {
      selling = true;
      clampTimes();
      let cd = sellingTime;
      let amt = backpackUsed;
      if (sellingInterval) clearInterval(sellingInterval);
      sellingInterval = setInterval(() => {
        cd -= 50;
        if (cd < 0) cd = 0;
        document.getElementById("sellCooldown").innerText = `üïí Selling Timer: ${formatCooldown(cd)}`;
        if (cd <= 0) {
          clearInterval(sellingInterval);
          let f = factories[factoryIndex];
          let p = f.products[currentProductIndex];
          let val = p.base * multiplier * prestigeMulti;
          let totalVal = val * amt;
          money += totalVal;
          totalEarned += totalVal;
          backpackUsed = 0;
          showNotification(`Sold ${amt} items for $${formatNumber(totalVal)}`);
          selling = false;
          document.getElementById("sellCooldown").innerText = "üïí Selling Timer: Ready";
          updateUI();
        }
      }, 50);
    }

    /****************************
     * 19. AUTO PRODUCE & SELL
     ****************************/
    setInterval(() => {
      if (autoProduce && !producing && sellingUnlocked && backpackUsed < backpackCapacity) {
        doProduce();
      }
      if (autoSell && !selling && sellingUnlocked && backpackUsed > 0) {
        doSellAll();
      }
    }, 200);

    /****************************
     * 20. KEYBIND HANDLERS FOR PRODUCE & SELL
     ****************************/
    window.addEventListener("keydown", (e) => {
      let key = e.key.toLowerCase();
      keyDownSet.add(key);
      keyDownSet.add(e.code);
      refreshMassBuyUI();
      if ((produceKeys.includes(key) || produceCodes.includes(e.code)) && !isAnyKeyPressed(sellKeys, sellCodes)) {
        if (!producing) {
          doProduce();
          sparkleButton(document.getElementById("produce"));
        }
      }
      if ((sellKeys.includes(key) || sellCodes.includes(e.code)) && !isAnyKeyPressed(produceKeys, produceCodes)) {
        if (!selling && sellingUnlocked && backpackUsed > 0) {
          doSellAll();
          sparkleButton(document.getElementById("sellAll"));
        }
      }
    });
    window.addEventListener("keyup", (e) => {
      keyDownSet.delete(e.key.toLowerCase());
      keyDownSet.delete(e.code);
      refreshMassBuyUI();
    });
    function isAnyKeyPressed(keyArr, codeArr) {
      for (let k of keyArr) {
        if (keyDownSet.has(k)) return true;
      }
      for (let c of codeArr) {
        if (keyDownSet.has(c)) return true;
      }
      return false;
    }

    /****************************
     * 21. MASS BUY UI UPDATE
     ****************************/
    // For every upgrade button rendered via renderUpgrades and renderSellingUpgrades,
    // we store its index in a data attribute. refreshMassBuyUI uses that to update the text.
    function refreshMassBuyUI() {
      const upgradeBtns = document.querySelectorAll(".upgrade[data-upg-index]");
      upgradeBtns.forEach(btn => {
        const index = btn.getAttribute("data-upg-index");
        const upg = upgrades[index];
        let baseText = `${upg.name} ($${formatNumber(upg.cost)})`;
        if (shiftDown || spaceDown) {
          btn.classList.add("mass-buy-active");
          let count = Math.floor(money / upg.cost);
          btn.innerText = count > 0 ? baseText + ` (x${count})` : baseText;
        } else {
          btn.classList.remove("mass-buy-active");
          btn.innerText = baseText;
        }
      });
      const sellingBtns = document.querySelectorAll(".upgrade[data-sell-index]");
      sellingBtns.forEach(btn => {
        const index = btn.getAttribute("data-sell-index");
        // For selling upgrades, use a separate array (we assume index 0 for Sell Multi and subsequent for others)
        let su;
        if (index === "0") { 
          su = { name: "Selling Multi", cost: sellMultiCost }; 
        } else {
          su = sellingUpgrades[index - 1];
        }
        let baseText = `${su.name} ($${formatNumber(su.cost)})`;
        if (shiftDown || spaceDown) {
          btn.classList.add("mass-buy-active");
          let count = Math.floor(money / su.cost);
          btn.innerText = count > 0 ? baseText + ` (x${count})` : baseText;
        } else {
          btn.classList.remove("mass-buy-active");
          btn.innerText = baseText;
        }
      });
      // Backpack button (if exists)
      const bpBtn = document.querySelector(".upgrade[data-bp-index]");
      if (bpBtn) {
        const index = bpBtn.getAttribute("data-bp-index");
        const bp = backpackData[index];
        let baseText = `${bp.name} ($${formatNumber(bp.cost)})`;
        if (shiftDown || spaceDown) {
          bpBtn.classList.add("mass-buy-active");
          let count = Math.floor(money / bp.cost);
          bpBtn.innerText = count > 0 ? baseText + ` (x${count})` : baseText;
        } else {
          bpBtn.classList.remove("mass-buy-active");
          bpBtn.innerText = baseText;
        }
      }
    }

    /****************************
     * 22. INITIALIZE NORMAL UPGRADES
     ****************************/
    function renderUpgrades() {
      const cont = document.getElementById("upgrades");
      cont.innerHTML = "";
      upgrades.forEach((upg, i) => {
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.setAttribute("data-upg-index", i);
        if (upg.name === "Product Upgrade") btn.classList.add("gold-button");
        let baseLabel = `${upg.name} ($${formatNumber(upg.cost)})`;
        btn.innerText = baseLabel;
        btn.title = upg.description;
        if (upg.name === "Product Upgrade") {
          const f = factories[factoryIndex];
          if (currentProductIndex >= f.products.length - 1) {
            btn.disabled = true;
            btn.innerText = `${upg.name} (Max)`;
          }
        }
        btn.onclick = () => {
          if (money >= upg.cost) {
            if (shiftDown || spaceDown) {
              while (money >= upg.cost) {
                if (!attemptUpgradePurchase(upg)) break;
              }
              sparkleButton(btn);
              updateUI();
            } else {
              attemptUpgradePurchase(upg);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptUpgradePurchase(upg) {
      if (money >= upg.cost) {
        money -= upg.cost;
        upg.purchased++;
        if (upg.name === "‚öôÔ∏è Speedy Assembly" || upg.name === "üè≠ Factory Expansion") {
          cooldownTime *= upg.effect;
        } else if (upg.name === "Product Upgrade") {
          const f = factories[factoryIndex];
          if (currentProductIndex < f.products.length - 1) currentProductIndex++;
        } else if (upg.effect === "increaseBatch") {
          productBatch++;
        } else {
          multiplier *= upg.effect;
        }
        if (upg.purchased < 5) upg.cost = Math.round(upg.cost * 1.6);
        else upg.cost = Math.round(upg.cost * 2.5);
        return true;
      }
      return false;
    }

    /****************************
     * 23. RENDER SELLING UPGRADES & BACKPACK UPGRADE
     ****************************/
    function renderSellingUpgrades() {
      const cont = document.getElementById("sellingUpgrades");
      cont.innerHTML = "";
      if (!sellingUnlocked) return;
      // Backpack Upgrade Button
      const bp = backpackData[backpackIndex];
      const bpBtn = document.createElement("button");
      bpBtn.className = "button upgrade";
      bpBtn.setAttribute("data-bp-index", backpackIndex);
      let bpLabel = `${bp.name} ($${formatNumber(bp.cost)})`;
      bpBtn.innerText = bpLabel;
      bpBtn.title = `Increase storage by +${bp.effect}`;
      bpBtn.onclick = () => {
        if (money >= bp.cost) {
          if (shiftDown || spaceDown) {
            while (money >= bp.cost) {
              if (!purchaseBackpack(bp)) break;
            }
            sparkleButton(bpBtn);
            updateUI();
          } else {
            purchaseBackpack(bp);
            sparkleButton(bpBtn);
            updateUI();
          }
        }
      };
      cont.appendChild(bpBtn);
      // Sell Multi Upgrade Button
      const smBtn = document.createElement("button");
      smBtn.className = "button upgrade";
      smBtn.setAttribute("data-sell-index", 0);
      let eff = sellMultiLevels[sellMultiIndex] || 5;
      let smLabel = `Selling Multi +${eff}% ($${formatNumber(sellMultiCost)})`;
      smBtn.innerText = smLabel;
      smBtn.title = `Boost money from sells by +${eff}% (Cost doubles each time)`;
      smBtn.onclick = () => {
        if (money >= sellMultiCost) {
          if (shiftDown || spaceDown) {
            while (money >= sellMultiCost) {
              if (!purchaseSellMulti()) break;
            }
            sparkleButton(smBtn);
            updateUI();
          } else {
            purchaseSellMulti();
            sparkleButton(smBtn);
            updateUI();
          }
        }
      };
      cont.appendChild(smBtn);
      // Additional selling upgrades (e.g., Faster Sell)
      sellingUpgrades.forEach((su, i) => {
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.setAttribute("data-sell-index", i + 1);
        let baseLabel = `${su.name} ($${formatNumber(su.cost)})`;
        btn.innerText = baseLabel;
        btn.title = su.desc;
        btn.onclick = () => {
          if (money >= su.cost) {
            if (shiftDown || spaceDown) {
              while (money >= su.cost) {
                if (!attemptSellingUpgrade(su)) break;
              }
              sparkleButton(btn);
              updateUI();
            } else {
              attemptSellingUpgrade(su);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function purchaseBackpack(bp) {
      if (money >= bp.cost) {
        money -= bp.cost;
        backpackCapacity += bp.effect;
        if (backpackIndex < backpackData.length - 1) {
          backpackIndex++;
        } else {
          // Infinite scaling: double cost and increase effect by 50%
          bp.cost = Math.round(bp.cost * 2);
          bp.effect = Math.round(bp.effect * 1.5);
        }
        return true;
      }
      return false;
    }
    function purchaseSellMulti() {
      if (money >= sellMultiCost) {
        money -= sellMultiCost;
        let eff = sellMultiLevels[sellMultiIndex] || 5;
        multiplier *= (1 + eff / 100);
        if (sellMultiIndex < sellMultiLevels.length - 1) sellMultiIndex++;
        sellMultiCost = Math.round(sellMultiCost * 2);
        return true;
      }
      return false;
    }
    function attemptSellingUpgrade(su) {
      if (money >= su.cost) {
        money -= su.cost;
        su.purchased++;
        if (su.name === "Faster Sell") {
          sellingTime *= su.effect;
          su.cost = Math.round(su.cost * 2);
        }
        return true;
      }
      return false;
    }

    /****************************
     * 24. RENDER EMPLOYEES
     ****************************/
    function renderEmployees() {
      const cont = document.getElementById("employees");
      cont.innerHTML = "";
      employees.forEach((emp) => {
        const btn = document.createElement("button");
        btn.className = "button employee";
        let label = `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        btn.innerText = label;
        let desc = emp.description;
        if (emp.name.includes("Porter") && sellingUnlocked) {
          desc = "Generates $0/sec. Slowly adds +1 capacity every 10s.";
        }
        let baseRate = emp.rate;
        let withMulti = (emp.rate * multiplier).toFixed(2);
        btn.title = `${desc}\nBase: $${baseRate}/sec, With Multi: $${withMulti}/sec`;
        btn.onclick = () => {
          if (money >= emp.cost) {
            if (shiftDown || spaceDown) {
              while (money >= emp.cost) {
                if (!attemptEmployeePurchase(emp)) break;
              }
              updateUI();
            } else {
              attemptEmployeePurchase(emp);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptEmployeePurchase(emp) {
      if (money >= emp.cost) {
        money -= emp.cost;
        emp.quantity++;
        emp.purchased++;
        if (emp.purchased < 5) emp.cost = Math.round(emp.cost * 1.5);
        else emp.cost = Math.round(emp.cost * 2.2);
        return true;
      }
      return false;
    }
    function renderEmployeeTraining() {
      if (employeeTraining.unlocked && !employeeTraining.purchased) {
        const cont = document.getElementById("upgrades");
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.setAttribute("data-upg-index", "training");
        let label = `Employee Training ($${formatNumber(employeeTraining.cost)})`;
        btn.innerText = label;
        btn.title = employeeTraining.description;
        btn.onclick = () => {
          if (money >= employeeTraining.cost) {
            money -= employeeTraining.cost;
            employeeTraining.purchased = true;
            employees.forEach(e => e.rate = Math.round(e.rate * employeeTraining.effect));
            updateUI();
          }
        };
        cont.appendChild(btn);
      }
    }
    function checkEmployeeTrainingUnlock() {
      let total = employees.reduce((sum, e) => sum + e.quantity, 0);
      if (total >= 10) employeeTraining.unlocked = true;
    }

    /****************************
     * 25. PASSIVE EMPLOYEE INCOME
     ****************************/
    setInterval(() => {
      let totalProd = employees.reduce((sum, e) => sum + (e.rate * e.quantity), 0);
      if (totalProd > 0) {
        let inc = totalProd * multiplier * prestigeMulti;
        money += inc;
        totalEarned += inc;
        updateUI();
      }
    }, 1000);

    /****************************
     * 26. PRODUCE & KEYBIND HANDLERS
     ****************************/
    let producing = false;
    let produceInterval = null;
    const produceKeys = ["q", "w"];
    const produceCodes = ["ArrowUp", "ArrowLeft"];
    const sellKeys = ["e", "s"];
    const sellCodes = ["ArrowDown", "ArrowRight"];
    document.getElementById("produce").addEventListener("click", () => {
      if (!producing) {
        doProduce();
        sparkleButton(document.getElementById("produce"));
      }
    });
    function doProduce() {
      producing = true;
      clampTimes();
      let cd = cooldownTime;
      if (produceInterval) clearInterval(produceInterval);
      produceInterval = setInterval(() => {
        cd -= 50;
        if (cd < 0) cd = 0;
        document.getElementById("cooldown").innerText = `‚è≥ Cooldown: ${formatCooldown(cd)}`;
        if (cd <= 0) {
          clearInterval(produceInterval);
          let f = factories[factoryIndex];
          let p = f.products[currentProductIndex];
          let totalVal = p.base * multiplier * prestigeMulti * productBatch;
          if (!sellingUnlocked) {
            if (Math.random() < vipChance) {
              totalVal *= vipMultiplier;
              showNotification(`VIP order! +${vipMultiplier}x bonus`);
            }
            money += totalVal;
            totalEarned += totalVal;
          } else {
            let space = backpackCapacity - backpackUsed;
            let actual = (productBatch > space) ? space : productBatch;
            backpackUsed += actual;
          }
          totalProductsProduced++;
          if (!challengeBonusApplied && totalProductsProduced >= 100) {
            multiplier *= 1.1;
            challengeBonusApplied = true;
            showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
          }
          producing = false;
          document.getElementById("cooldown").innerText = "‚è≥ Cooldown: Ready";
          updateUI();
        }
      }, 50);
    }
    document.getElementById("sellAll").addEventListener("click", () => {
      if (!selling && sellingUnlocked && backpackUsed > 0) {
        doSellAll();
        sparkleButton(document.getElementById("sellAll"));
      }
    });
    function doSellAll() {
      selling = true;
      clampTimes();
      let cd = sellingTime;
      let amt = backpackUsed;
      if (sellingInterval) clearInterval(sellingInterval);
      sellingInterval = setInterval(() => {
        cd -= 50;
        if (cd < 0) cd = 0;
        document.getElementById("sellCooldown").innerText = `üïí Selling Timer: ${formatCooldown(cd)}`;
        if (cd <= 0) {
          clearInterval(sellingInterval);
          let f = factories[factoryIndex];
          let p = f.products[currentProductIndex];
          let val = p.base * multiplier * prestigeMulti;
          let totalVal = val * amt;
          money += totalVal;
          totalEarned += totalVal;
          backpackUsed = 0;
          showNotification(`Sold ${amt} items for $${formatNumber(totalVal)}`);
          selling = false;
          document.getElementById("sellCooldown").innerText = "üïí Selling Timer: Ready";
          updateUI();
        }
      }, 50);
    }

    /****************************
     * 27. AUTO PRODUCE & SELL
     ****************************/
    setInterval(() => {
      if (autoProduce && !producing && sellingUnlocked && backpackUsed < backpackCapacity) {
        doProduce();
      }
      if (autoSell && !selling && sellingUnlocked && backpackUsed > 0) {
        doSellAll();
      }
    }, 200);

    /****************************
     * 28. KEYBIND HANDLERS (Produce & Sell)
     ****************************/
    window.addEventListener("keydown", (e) => {
      let key = e.key.toLowerCase();
      keyDownSet.add(key);
      keyDownSet.add(e.code);
      refreshMassBuyUI();
      if ((produceKeys.includes(key) || produceCodes.includes(e.code)) && !isAnyKeyPressed(sellKeys, sellCodes)) {
        if (!producing) {
          doProduce();
          sparkleButton(document.getElementById("produce"));
        }
      }
      if ((sellKeys.includes(key) || sellCodes.includes(e.code)) && !isAnyKeyPressed(produceKeys, produceCodes)) {
        if (!selling && sellingUnlocked && backpackUsed > 0) {
          doSellAll();
          sparkleButton(document.getElementById("sellAll"));
        }
      }
    });
    window.addEventListener("keyup", (e) => {
      keyDownSet.delete(e.key.toLowerCase());
      keyDownSet.delete(e.code);
      refreshMassBuyUI();
    });
    function isAnyKeyPressed(keyArr, codeArr) {
      for (let k of keyArr) {
        if (keyDownSet.has(k)) return true;
      }
      for (let c of codeArr) {
        if (keyDownSet.has(c)) return true;
      }
      return false;
    }

    /****************************
     * 29. MASS BUY UI INDICATOR
     ****************************/
    // The refreshMassBuyUI() function (see above) now uses data attributes set on each button.
    // (See the render functions where we call setAttribute("data-upg-index", i) or data-sell-index.)

    /****************************
     * 30. INITIALIZE (ONLOAD)
     ****************************/
    function init() {
      if (prestigeCount > 0) sellingUnlocked = true;
      updateUI();
    }
    window.onload = init;
    setInterval(() => updateUI(), 10000);

    /****************************
     * 31. PORTER SYNERGY (Backpack growth)
     ****************************/
    setInterval(() => {
      if (!sellingUnlocked) return;
      let porter = employees.find(e => e.name.includes("Porter #3"));
      if (porter && porter.quantity > 0) {
        backpackCapacity += porter.quantity;
        updateUI();
      }
    }, 10000);
  </script>
</body>
</html>
