<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static's Infinite Factory Tycoon ‚Äì Overhaul</title>
  <style>
    /* ===========================
       GLOBAL STYLES
    ============================ */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
      transition: background 0.5s ease;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
      position: relative;
    }
    /* Basic Button */
    .button {
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      transition: background 0.3s;
      display: inline-block;
    }
    .button:hover {
      background-color: #0056b3;
    }
    /* Gold background for Product Upgrade */
    .gold-button {
      background-color: #FFD700 !important;
      color: #000 !important;
      font-weight: normal;
    }
    .money-line {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .cooldown {
      font-size: 14px;
      color: #bbb;
    }
    /* Upgrades & Employees Layout */
    .upgrade-container,
    .employee-container,
    .selling-container {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .upgrade,
    .employee,
    .sell-upgrade {
      flex: 1 1 45%;
      margin: 5px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .upgrade:hover,
    .employee:hover,
    .sell-upgrade:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    /* Modal Menus (Prestige / Stats) */
    .modal-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      z-index: 1000;
      max-width: 80%;
      font-size: 14px;
    }
    .modal-menu h2 {
      margin-top: 0;
    }
    /* Notification (VIP, challenges, etc.) */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 2000;
      max-width: 70%;
      font-size: 16px;
    }
    /* QR code bottom-left, doubled in size to 200x200 */
    .qr-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 200px;
      height: 200px;
      z-index: 1500;
    }
    .qr-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* Gray-out for disabled produce button if backpack is full */
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Notification Box -->
  <div class="notification" id="notificationBox"></div>

  <div class="container">
    <!-- Money & Prestige on the same line -->
    <p class="money-line">
      üí∞ Money: $<span id="money">0.00</span>
      | üåü Prestige Points: <span id="prestigePoints">0</span>
    </p>
    <p>üîÑ Multiplier: x<span id="multiplier">1.00</span> | Prestige Multi: x<span id="prestigeMulti">1.00</span></p>

    <h2>üè≠ Factory Production</h2>
    <p>üè≠ Factory: <span id="factoryName"></span></p>
    <p>
      üì¶ Product: <span id="productName"></span>
      (Base: <span id="productBase">0</span>,
      Batch: <span id="productBatch">1</span>)
    </p>
    <button class="button" id="produce">üöÄ Produce Product</button>
    <p class="cooldown" id="cooldown">‚è≥ Cooldown: Ready</p>

    <!-- Upgrades Section -->
    <div class="upgrade-container">
      <h2 style="width:100%; margin-bottom:10px;">üìà Upgrades</h2>
      <div id="upgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Employees Section -->
    <div class="employee-container">
      <h2 style="width:100%; margin-bottom:10px;">üë• Employees</h2>
      <div id="employees" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- New Selling System (Appears after Prestige 1) -->
    <div class="selling-container" id="sellingArea" style="display:none;">
      <h2 style="width:100%; margin-bottom:10px;">üíº Selling System</h2>
      <p>Backpack Capacity: <span id="backpackCapacity">0</span> | <span id="backpackUsed">0</span> used</p>
      <button class="button" id="sellOne">Sell 1 Product</button>
      <button class="button" id="sellAll">Sell All</button>
      <p class="cooldown" id="sellCooldown">üïí Selling Timer: Ready</p>

      <!-- Selling Upgrades -->
      <div id="sellingUpgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Buttons for Prestige & Stats -->
    <div style="margin-top: 20px;">
      <button class="button" id="prestige">üîÑ Prestige</button>
      <button class="button" id="statsBtn">üìä Stats</button>
    </div>

    <!-- Credits -->
    <p style="margin-top: 30px;">
      Made By 
      <a href="https://sites.google.com/view/staticquasar931" target="_blank" style="color: #00d1ff;">
        Static
      </a>
    </p>
  </div>

  <!-- Double-Sized QR Code (200x200) -->
  <div class="qr-container">
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
      <img 
        src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png" 
        alt="Qr Code linking to Static's site" 
        title="Click to visit Static's site"
      />
    </a>
  </div>

  <!-- Prestige Menu -->
  <div class="modal-menu" id="prestigeMenu">
    <h2>üîÑ Prestige Confirmation</h2>
    <p><strong>Warning:</strong> Prestiging resets your money, multiplier, upgrades, employees, and backpack progress.</p>
    <p>You must have the required on-hand money to Prestige. The required money grows each Prestige (1K, 50M, 50B, 50T...).</p>
    <p>Prestige Points (PP) scale with <em>total earned</em>, but each subsequent point costs more than the last!</p>
    <p>Your Current Prestige Points: <span id="livePP">0</span></p>
    <p>Potential Prestige Points Gain: <span id="earnedPP">0</span></p>
    <p>üè≠ Current Factory: <span id="currentFactory"></span></p>
    <p>üè≠ Next Factory: <span id="nextFactory"></span></p>
    <p>üì¶ Base Product Value: <span id="baseValue"></span></p>
    <p>üì¶ Best Product Value: <span id="bestValue"></span></p>

    <div id="prestigeUpgradesMenu"></div>

    <button class="button" id="confirmPrestige">‚úî Confirm</button>
    <button class="button" id="closePrestige">‚ùå Cancel</button>
  </div>

  <!-- Stats Menu -->
  <div class="modal-menu" id="statsMenu">
    <h2>üìä Player Stats</h2>
    <div id="statsContent"></div>
    <button class="button" id="closeStats">‚ùå Close</button>
  </div>

  <script>
    "use strict";

    /* ================================
       1. NUMBER FORMATTING (Extended)
    ================================ */
    function formatNumber(num) {
      // If negative or zero, handle gracefully
      if (num === 0) return "0.00";
      if (num < 0.001 && num > 0) return num.toExponential(3); // tiny decimals
      // Use absolute value for sign
      const abs = Math.abs(num);
      let sign = num < 0 ? "-" : "";

      // Switch to scientific notation after 1e22
      if (abs >= 1e22) {
        return sign + abs.toExponential(3);
      }

      // Otherwise, short scale up to 1e21
      const scale = [
        { v: 1e3, l: "K" },
        { v: 1e6, l: "M" },  // capital M
        { v: 1e9, l: "B" },
        { v: 1e12, l: "T" },
        { v: 1e15, l: "Q" },
        { v: 1e18, l: "Qi" },
        { v: 1e21, l: "Si" },
      ];
      for (let i = scale.length - 1; i >= 0; i--) {
        if (abs >= scale[i].v) {
          return (
            sign +
            (abs / scale[i].v).toFixed(2) +
            " " +
            scale[i].l
          );
        }
      }
      // If less than 1000, just fix to 2 decimals
      return sign + abs.toFixed(2);
    }

    /* =================================================
       2. GAME STATE & INITIALIZATION
       ================================================= */
    // Basic Data
    let money = parseFloat(localStorage.getItem("money")) || 0;
    let totalEarned = parseFloat(localStorage.getItem("totalEarned")) || 0;
    let prestigePoints = parseInt(localStorage.getItem("prestigePoints")) || 0;
    let multiplier = parseFloat(localStorage.getItem("multiplier")) || 1;
    let prestigeMulti = parseFloat(localStorage.getItem("prestigeMulti")) || 1;
    let totalProductsProduced = parseInt(localStorage.getItem("totalProductsProduced")) || 0;
    let challengeBonusApplied = localStorage.getItem("challengeBonusApplied") === "true";
    let productBatch = parseInt(localStorage.getItem("productBatch")) || 1;

    let factoryIndex = parseInt(localStorage.getItem("factoryIndex")) || 0;
    let currentProductIndex = parseInt(localStorage.getItem("currentProductIndex")) || 0;
    let producing = false;
    // The user asked to allow cooldown < 0.1s, so no clamp at 100ms
    const baseCooldownTime = 5000; 
    let cooldownTime = parseInt(localStorage.getItem("cooldownTime")) || baseCooldownTime;

    // Additional Stats
    let maxMoneyHeld = parseFloat(localStorage.getItem("maxMoneyHeld")) || 0;

    // VIP
    let vipChance = parseFloat(localStorage.getItem("vipChance")) || 0.05; 
    let vipMultiplier = parseFloat(localStorage.getItem("vipMultiplier")) || 20;

    // Prestige logic: each PP costs more than the last
    // We'll keep a "nextPPcost" variable that starts at 1000
    let nextPPcost = parseFloat(localStorage.getItem("nextPPcost")) || 1000;

    // On-hand money required for each Prestige (up to 20).
    // 1st Prestige -> 1K, 2nd -> 50M, 3rd -> 50B, 4th -> 50T, 5th -> 50Qa, etc. 
    // We'll define them in short scale. 
    // The user specifically wants: 1K -> 50M -> 50B -> 50T -> ...
    // We'll do 8 steps for demonstration; can expand if needed.
    const prestigeRequirements = [
      1e3, 5e7, 5e10, 5e13, 5e16, 5e19, 1e22, 1e25, 1e28, 1e31,
      1e34, 1e37, 1e40, 1e43, 1e46, 1e49, 1e52, 1e55, 1e58, 1e61
    ];

    // Current Prestige count (how many times we've actually Prestiged)
    let prestigeCount = parseInt(localStorage.getItem("prestigeCount")) || 0;

    /* =======================
       FACTORIES & PRODUCTS
    ========================== */
    const factories = [
      {
        name: "üß∏ Children's Toys Factory",
        bg: "linear-gradient(to right, #ff9a9e, #fad0c4)",
        products: [
          { name: "Wooden Blocks", base: 10 },
          { name: "Toy Cars", base: 15 },
          { name: "Stuffed Animals", base: 20 },
          { name: "Puzzle Games", base: 25 },
          { name: "Action Figures", base: 30 },
          { name: "Dollhouses", base: 35 },
          { name: "Remote Control Cars", base: 40 },
          { name: "Educational Kits", base: 45 },
          { name: "Model Trains", base: 50 },
          { name: "Custom Playsets", base: 60 }
        ]
      },
      {
        name: "üç∞ Sweet Treats Bakery",
        bg: "linear-gradient(to right, #fbc2eb, #a6c1ee)",
        products: [
          { name: "Cupcakes", base: 12 },
          { name: "Cookies", base: 18 },
          { name: "Brownies", base: 24 },
          { name: "Donuts", base: 30 },
          { name: "Muffins", base: 36 },
          { name: "Pastries", base: 42 },
          { name: "Cakes", base: 50 },
          { name: "Macarons", base: 58 },
          { name: "Eclairs", base: 66 },
          { name: "Gourmet Pies", base: 75 }
        ]
      },
      {
        name: "üé® Artisan Crafts Workshop",
        bg: "linear-gradient(to right, #a1c4fd, #c2e9fb)",
        products: [
          { name: "Handmade Cards", base: 14 },
          { name: "Ceramic Mugs", base: 20 },
          { name: "Knitted Scarves", base: 26 },
          { name: "Wooden Toys", base: 32 },
          { name: "Painted Vases", base: 38 },
          { name: "Handcrafted Jewelry", base: 44 },
          { name: "Embroidered Pillows", base: 50 },
          { name: "Custom Furniture", base: 58 },
          { name: "Vintage Clocks", base: 66 },
          { name: "Bespoke Art Pieces", base: 75 }
        ]
      },
      {
        name: "üì± Tech Gadget Studio",
        bg: "linear-gradient(to right, #a18cd1, #fbc2eb)",
        products: [
          { name: "Smartphone Cases", base: 16 },
          { name: "Wireless Earbuds", base: 22 },
          { name: "Portable Chargers", base: 28 },
          { name: "Bluetooth Speakers", base: 34 },
          { name: "Smartwatches", base: 40 },
          { name: "Tablet Accessories", base: 46 },
          { name: "VR Headsets", base: 52 },
          { name: "Drone Kits", base: 60 },
          { name: "Gaming Controllers", base: 68 },
          { name: "Advanced Gadgets", base: 78 }
        ]
      },
      {
        name: "üíé Luxury Gift Atelier",
        bg: "linear-gradient(to right, #ffecd2, #fcb69f)",
        products: [
          { name: "Artisanal Chocolates", base: 18 },
          { name: "Designer Scarves", base: 26 },
          { name: "Luxury Candles", base: 34 },
          { name: "Fine Wines", base: 42 },
          { name: "Handcrafted Jewelry", base: 50 },
          { name: "Exclusive Perfumes", base: 58 },
          { name: "Gourmet Baskets", base: 66 },
          { name: "Limited Edition Watches", base: 74 },
          { name: "Premium Leather Goods", base: 82 },
          { name: "Custom Masterpieces", base: 90 }
        ]
      },
      {
        /* Newly added "Adult Toys" factory */
        name: "üîû Adult Toys Factory",
        bg: "linear-gradient(to right, #4f0000, #8b0000)",
        products: [
          { name: "Basic Toys", base: 200 },
          { name: "Novelty Items", base: 500 },
          { name: "Special Editions", base: 800 },
          { name: "Themed Sets", base: 1200 },
          { name: "Remote-Controlled", base: 1800 },
          { name: "Luxury Models", base: 2500 },
          { name: "Smart Devices", base: 4000 },
          { name: "Premium Kits", base: 6000 },
          { name: "Custom Orders", base: 10000 },
          { name: "Futuristic Concepts", base: 20000 }
        ]
      }
      // We can add more factories if you want up to 20
    ];

    /* =======================
       UPGRADES & EMPLOYEES
    ========================== */
    let upgrades = JSON.parse(localStorage.getItem("upgrades")) || [
      { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
      { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
      { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product to next tier.", purchased: 0 },
      { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
      { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
    ];

    // Each employee is unique
    let employees = JSON.parse(localStorage.getItem("employees")) || [
      {
        name: "üë∑ Efficient Operator",
        cost: 75,
        rate: 1,
        quantity: 0,
        description: "Generates $1/sec. Also reduces SELL time by 2% each.",
        purchased: 0
      },
      {
        name: "üë®‚Äçüîß Skilled Worker",
        cost: 250,
        rate: 5,
        quantity: 0,
        description: "Generates $5/sec. Also +1 backpack capacity per 5 workers.",
        purchased: 0
      },
      {
        name: "üõ†Ô∏è Master Craftsman",
        cost: 1000,
        rate: 20,
        quantity: 0,
        description: "Generates $20/sec. Also speeds up production by 2% each 5 craftsman.",
        purchased: 0
      },
      {
        name: "üèÜ Production Supervisor",
        cost: 4000,
        rate: 50,
        quantity: 0,
        description: "Generates $50/sec. Also +5% multiplier every 10 supervisors.",
        purchased: 0
      },
      {
        name: "üíº Operations Manager",
        cost: 7500,
        rate: 100,
        quantity: 0,
        description: "Generates $100/sec. Also +1 max product upgrade beyond final tier (still conceptual).",
        purchased: 0
      }
    ];

    // Employee Training
    let employeeTraining = JSON.parse(localStorage.getItem("employeeTraining")) || {
      unlocked: false,
      cost: 150,
      effect: 1.2,
      purchased: false,
      description: "All employee production +20%."
    };

    // Prestige Upgrades - multiple stages for auto produce & auto sell, VIP max 30%, etc.
    let prestigeUpgrades = JSON.parse(localStorage.getItem("prestigeUpgrades")) || [
      { name: "Divine Efficiency ‚ú®", cost: 5, effect: 1.1, description: "Prestige Multi +10%.", purchased: 0, max: Infinity },
      { name: "Temporal Mastery ‚è≥", cost: 10, effect: 0.95, description: "Cooldown -5%.", purchased: 0, max: Infinity },
      { name: "Cosmic Workforce üöÄ", cost: 15, effect: 1.2, description: "All employees +20% rate.", purchased: 0, max: Infinity },
      { name: "Galactic Expansion üöÄ", cost: 20, effect: 1.15, description: "Prestige Multi +15%.", purchased: 0, max: Infinity },
      { name: "Eternal Workshop üè≠", cost: 25, effect: 1.25, description: "Product base value +25%.", purchased: 0, max: Infinity },
      // Multi-stage automation upgrade
      {
        name: "Auto Tycoon (Stage)",
        cost: 10,
        effect: "autoStage",
        description: "Stage 1 = Auto Produce, Stage 2 = Auto Sell.",
        purchased: 0,
        max: 2 // up to 2 stages
      },
      {
        name: "Prestige Pure Multi",
        cost: 1,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: Infinity
      },
      {
        name: "Prestige Auto-Operator",
        cost: 8,
        effect: 1.2,
        description: "All employees +20% rate.",
        purchased: 0,
        max: Infinity
      },
      {
        name: "VIP Client Order",
        cost: 30,
        effect: 0.02,
        description: "VIP chance +2% (max 30%), VIP multiplier +5%.",
        purchased: 0,
        max: 500 // can only buy 500 times
      }
    ];

    /* =======================
       SELLING SYSTEM
    ========================== */
    // Unlocked after Prestige 1.
    let sellingUnlocked = (prestigeCount > 0);
    // Backpack capacity / usage
    let backpackCapacity = parseInt(localStorage.getItem("backpackCapacity")) || 10; 
    let backpackUsed = parseInt(localStorage.getItem("backpackUsed")) || 0;
    // Selling cooldown 
    let sellingTime = 3000; 
    let selling = false;
    let autoProduce = false; // if the user has automation stage 1
    let autoSell = false;    // if the user has automation stage 2

    // Sell Upgrades (appear in sellingArea)
    // Example: bigger backpack, faster selling, etc.
    let sellingUpgrades = JSON.parse(localStorage.getItem("sellingUpgrades")) || [
      { name: "Bigger Backpack", cost: 100, effect: 10, desc: "+10 capacity", purchased: 0 },
      { name: "Carry Suitcase", cost: 1000, effect: 25, desc: "+25 capacity", purchased: 0 },
      { name: "Storage Container", cost: 20000, effect: 100, desc: "+100 capacity", purchased: 0 },
      { name: "Abandoned School", cost: 1e6, effect: 1000, desc: "+1000 capacity", purchased: 0 }
    ];

    /* =======================
       SAVE FUNCTION
    ========================== */
    function saveGame() {
      localStorage.setItem("money", money);
      localStorage.setItem("totalEarned", totalEarned);
      localStorage.setItem("prestigePoints", prestigePoints);
      localStorage.setItem("multiplier", multiplier);
      localStorage.setItem("prestigeMulti", prestigeMulti);
      localStorage.setItem("cooldownTime", cooldownTime);
      localStorage.setItem("totalProductsProduced", totalProductsProduced);
      localStorage.setItem("challengeBonusApplied", challengeBonusApplied);
      localStorage.setItem("productBatch", productBatch);
      localStorage.setItem("factoryIndex", factoryIndex);
      localStorage.setItem("currentProductIndex", currentProductIndex);
      localStorage.setItem("vipChance", vipChance);
      localStorage.setItem("vipMultiplier", vipMultiplier);
      localStorage.setItem("maxMoneyHeld", maxMoneyHeld);
      localStorage.setItem("nextPPcost", nextPPcost);
      localStorage.setItem("prestigeCount", prestigeCount);

      localStorage.setItem("upgrades", JSON.stringify(upgrades));
      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("employeeTraining", JSON.stringify(employeeTraining));
      localStorage.setItem("prestigeUpgrades", JSON.stringify(prestigeUpgrades));

      localStorage.setItem("sellingUpgrades", JSON.stringify(sellingUpgrades));
      localStorage.setItem("backpackCapacity", backpackCapacity);
      localStorage.setItem("backpackUsed", backpackUsed);
    }

    /* =======================
       UI, BACKGROUND & NOTIFS
    ========================== */
    function updateBackground() {
      document.body.style.background = factories[factoryIndex].bg;
    }

    function showNotification(msg) {
      const box = document.getElementById("notificationBox");
      box.innerText = msg;
      box.style.display = "block";
      setTimeout(() => {
        box.style.display = "none";
      }, 3000);
    }

    function updateUI() {
      // Track max money
      if (money > maxMoneyHeld) {
        maxMoneyHeld = money;
      }

      // Basic displays
      document.getElementById("money").innerText = formatNumber(money);
      document.getElementById("prestigePoints").innerText = prestigePoints;
      document.getElementById("multiplier").innerText = formatNumber(multiplier);
      document.getElementById("prestigeMulti").innerText = formatNumber(prestigeMulti);

      const fact = factories[factoryIndex];
      document.getElementById("factoryName").innerText = fact.name;

      const product = fact.products[currentProductIndex];
      document.getElementById("productName").innerText = product.name;
      document.getElementById("productBase").innerText = formatNumber(product.base);
      document.getElementById("productBatch").innerText = productBatch;

      // If backpack is full, disable produce
      const produceBtn = document.getElementById("produce");
      if (backpackUsed >= backpackCapacity && sellingUnlocked) {
        produceBtn.classList.add("disabled");
        produceBtn.disabled = true;
      } else {
        produceBtn.classList.remove("disabled");
        produceBtn.disabled = false;
      }

      // Selling area 
      if (sellingUnlocked) {
        document.getElementById("sellingArea").style.display = "block";
        document.getElementById("backpackCapacity").innerText = backpackCapacity;
        document.getElementById("backpackUsed").innerText = backpackUsed;
        renderSellingUpgrades();
      }

      renderUpgrades();
      renderEmployees();
      renderEmployeeTraining();
      updatePrestigeMenu();
      saveGame();
      updateBackground();
    }

    /* =======================
       "MAX BUY" DETECTION
    ========================== */
    let shiftDown = false;
    let spaceDown = false;
    window.addEventListener("keydown", (e) => {
      if (e.key === "Shift") shiftDown = true;
      if (e.code === "Space") spaceDown = true;
    });
    window.addEventListener("keyup", (e) => {
      if (e.key === "Shift") shiftDown = false;
      if (e.code === "Space") spaceDown = false;
    });

    /* =======================
       UPGRADES
    ========================== */
    function renderUpgrades() {
      const container = document.getElementById("upgrades");
      container.innerHTML = "";
      upgrades.forEach((upg, index) => {
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        // "Product Upgrade" -> gold style
        if (upg.name === "Product Upgrade") {
          btn.classList.add("gold-button");
          const fact = factories[factoryIndex];
          const nextProd = fact.products[currentProductIndex + 1];
          if (!nextProd) {
            btn.innerText = `${upg.name} (Maxed)`;
            btn.disabled = true;
          } else {
            btn.innerText = `${upg.name} ($${formatNumber(upg.cost)})`;
            btn.title = `${upg.description} -> ${nextProd.name} (Base: ${formatNumber(nextProd.base)})`;
          }
        } 
        else if (upg.effect === "increaseBatch") {
          btn.innerText = `${upg.name} ($${formatNumber(upg.cost)})`;
          btn.title = `${upg.description} (Next batch: ${productBatch + 1})`;
        } else {
          btn.innerText = `${upg.name} ($${formatNumber(upg.cost)})`;
          btn.title = upg.description;
        }

        btn.onclick = (e) => purchaseUpgrade(index, e);
        container.appendChild(btn);
      });
    }

    function purchaseUpgrade(index, e) {
      const upg = upgrades[index];
      // If shiftDown or spaceDown => max buy
      if (shiftDown || spaceDown) {
        let buys = 0;
        while (money >= upg.cost) {
          if (!attemptUpgradePurchase(upg, index)) break;
          buys++;
        }
        if (buys > 0) updateUI();
      } else {
        attemptUpgradePurchase(upg, index);
        updateUI();
      }
    }

    function attemptUpgradePurchase(upg, index) {
      if (money >= upg.cost) {
        money -= upg.cost;
        upg.purchased++;

        // Behavior
        if (upg.name === "‚öôÔ∏è Speedy Assembly") {
          cooldownTime = cooldownTime * upg.effect;
        } else if (upg.name === "Product Upgrade") {
          const fact = factories[factoryIndex];
          if (currentProductIndex < fact.products.length - 1) {
            currentProductIndex++;
          }
        } else if (upg.name === "üè≠ Factory Expansion") {
          cooldownTime = cooldownTime * upg.effect;
        } else if (upg.effect === "increaseBatch") {
          productBatch++;
        } else {
          multiplier *= upg.effect;
        }

        // If we've bought 5 times or more, scale cost up more drastically:
        if (upg.purchased < 5) {
          upg.cost = Math.round(upg.cost * 1.6);
        } else {
          upg.cost = Math.round(upg.cost * 2.5);
        }

        return true;
      }
      return false;
    }

    /* =======================
       EMPLOYEES (Unique Perks)
    ========================== */
    function renderEmployees() {
      const container = document.getElementById("employees");
      container.innerHTML = "";
      employees.forEach((emp, index) => {
        const btn = document.createElement("button");
        btn.className = "button employee";
        btn.innerText = `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        btn.title = emp.description;
        btn.onclick = (e) => purchaseEmployee(index, e);
        container.appendChild(btn);
      });
    }

    function purchaseEmployee(index, e) {
      const emp = employees[index];
      // Max buy if shiftDown/spaceDown
      if (shiftDown || spaceDown) {
        while (money >= emp.cost) {
          if (!attemptEmployeePurchase(emp)) break;
        }
        updateUI();
      } else {
        attemptEmployeePurchase(emp);
        updateUI();
      }
    }

    function attemptEmployeePurchase(emp) {
      if (money >= emp.cost) {
        money -= emp.cost;
        emp.quantity++;
        emp.purchased++;

        // Increase cost faster after 5 buys
        if (emp.purchased < 5) {
          emp.cost = Math.round(emp.cost * 1.5);
        } else {
          emp.cost = Math.round(emp.cost * 2.2);
        }

        // Unique perks triggered
        // Operator: reduces SELL time by 2% each or every 5?
        // Skilled Worker: +1 capacity per 5
        // Master Craftsman: speeds production by 2% each 5
        // Supervisor: +5% multiplier every 10
        // Manager: ???

        // We'll do them on update loop or specifically here:
        applyEmployeePerks(emp);
        return true;
      }
      return false;
    }

    function applyEmployeePerks(emp) {
      // We'll do a quick check
      // üë∑ Efficient Operator => reduce sellingTime by 2% every 5 operators
      if (emp.name.includes("Efficient Operator")) {
        let totalOps = employees[0].quantity; 
        let setsOf5 = Math.floor(totalOps / 5);
        // Each set of 5 => 2% faster selling => total is setsOf5 * 0.98
        // We'll do a baseline of 3000ms 
        sellingTime = 3000 * Math.pow(0.98, setsOf5);
      }
      // Skilled Worker => +1 capacity per 5
      if (emp.name.includes("Skilled Worker")) {
        let totalWorkers = employees[1].quantity;
        let setsOf5 = Math.floor(totalWorkers / 5);
        backpackCapacity = 10 + setsOf5 * 1 + sumSellingUpgrades(); 
      }
      // Master Craftsman => speeds production by 2% each 5
      if (emp.name.includes("Master Craftsman")) {
        let totalC = employees[2].quantity;
        let setsOf5 = Math.floor(totalC / 5);
        cooldownTime *= Math.pow(0.98, setsOf5);
      }
      // Production Supervisor => +5% multiplier every 10
      if (emp.name.includes("Production Supervisor")) {
        let totalSup = employees[3].quantity;
        let setsOf10 = Math.floor(totalSup / 10);
        multiplier *= Math.pow(1.05, setsOf10);
      }
      // Operations Manager => potential synergy with product tiers, 
      // but we won't add more logic right now beyond what's stated.
    }

    // Employee Training
    function renderEmployeeTraining() {
      if (employeeTraining.unlocked && !employeeTraining.purchased) {
        const container = document.getElementById("upgrades");
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.innerText = `üèãÔ∏è Employee Training ($${formatNumber(employeeTraining.cost)})`;
        btn.title = employeeTraining.description;
        btn.onclick = (e) => {
          if (shiftDown || spaceDown) {
            // Max buy? It's one time
            purchaseEmployeeTraining();
          } else {
            purchaseEmployeeTraining();
          }
        };
        container.appendChild(btn);
      }
    }

    function purchaseEmployeeTraining() {
      if (money >= employeeTraining.cost) {
        money -= employeeTraining.cost;
        employeeTraining.purchased = true;
        employees.forEach(emp => {
          emp.rate = Math.round(emp.rate * employeeTraining.effect);
        });
        updateUI();
      }
    }

    // Passive Income from employees
    setInterval(() => {
      const totalProduction = employees.reduce((sum, emp) => sum + (emp.rate * emp.quantity), 0);
      if (totalProduction > 0) {
        const earned = totalProduction * multiplier * prestigeMulti;
        money += earned;
        totalEarned += earned;
        updateUI();
      }
    }, 1000);

    /* =======================
       AUTO PRODUCE
    ========================== */
    setInterval(() => {
      if (autoProduce && !producing && (backpackUsed < backpackCapacity)) {
        manualProduce();
      }
    }, 200); // spam produce every 0.2s if we have auto produce

    /* =======================
       MANUAL PRODUCTION
    ========================== */
    document.getElementById("produce").addEventListener("click", function() {
      if (!producing) {
        manualProduce();
      }
    });

    function manualProduce() {
      producing = true;
      let countdown = cooldownTime;
      const interval = setInterval(() => {
        countdown -= 100;
        if (countdown > 0.1) {
          let show = (countdown / 1000).toFixed(3);
          // If over 0.1s, normal. If below, show the actual?
          document.getElementById("cooldown").innerText = `‚è≥ Cooldown: ${show}s`;
        } else {
          // under 0.1? show the actual
          document.getElementById("cooldown").innerText = `‚è≥ Cooldown: ${ (countdown/1000).toFixed(3) }s`;
        }

        if (countdown <= 0) {
          clearInterval(interval);
          // produce 1 batch => goes into backpack
          if (backpackUsed + productBatch <= backpackCapacity) {
            backpackUsed += productBatch;
          } else {
            // fill up if partial?
            let canFit = backpackCapacity - backpackUsed;
            backpackUsed += canFit;
          }
          totalProductsProduced++;
          checkChallenge();
          updateUI();
          producing = false;
          document.getElementById("cooldown").innerText = "‚è≥ Cooldown: Ready";
        }
      }, 100);
    }

    function checkChallenge() {
      if (!challengeBonusApplied && totalProductsProduced >= 100) {
        multiplier *= 1.1;
        challengeBonusApplied = true;
        showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
      }
    }

    /* =======================
       SELLING SYSTEM
    ========================== */
    const sellOneBtn = document.getElementById("sellOne");
    const sellAllBtn = document.getElementById("sellAll");
    let sellingInterval = null;

    sellOneBtn.addEventListener("click", function() {
      if (!selling) {
        sellNProducts(1);
      }
    });
    sellAllBtn.addEventListener("click", function() {
      if (!selling) {
        sellNProducts(backpackUsed);
      }
    });

    function sellNProducts(n) {
      if (backpackUsed <= 0) return; // nothing to sell
      selling = true;
      let amountToSell = Math.min(n, backpackUsed);

      let stime = sellingTime; // base selling time
      // We can do a simple approach: the more items you sell, the longer it takes
      // or just flat time? Let's do a flat time for now
      let cd = stime;
      sellingInterval = setInterval(() => {
        cd -= 100;
        document.getElementById("sellCooldown").innerText = "üïí Selling Timer: " + (cd/1000).toFixed(2) + "s";
        if (cd <= 0) {
          clearInterval(sellingInterval);
          // Actually earn money
          let fact = factories[factoryIndex];
          let product = fact.products[currentProductIndex];
          let baseValue = product.base;
          let revenuePer = baseValue * multiplier * prestigeMulti; 
          // VIP won't apply again for selling since we did it on production? 
          // Actually, we said we do VIP on production. So let's keep it that way. 
          let totalRev = revenuePer * amountToSell;
          money += totalRev;
          totalEarned += totalRev;
          backpackUsed -= amountToSell;
          showNotification(`Sold ${amountToSell} items for $${formatNumber(totalRev)}!`);
          selling = false;
          document.getElementById("sellCooldown").innerText = "üïí Selling Timer: Ready";
          updateUI();
        }
      }, 100);
    }

    // If autoSell is unlocked, we do:
    setInterval(() => {
      if (autoSell && !selling && backpackUsed > 0) {
        // automatically sellAll
        sellNProducts(backpackUsed);
      }
    }, 500);

    // Render selling upgrades
    function renderSellingUpgrades() {
      const container = document.getElementById("sellingUpgrades");
      container.innerHTML = "";
      sellingUpgrades.forEach((upg, i) => {
        const btn = document.createElement("button");
        btn.className = "button sell-upgrade";
        btn.innerText = `${upg.name} - $${formatNumber(upg.cost)}`;
        btn.title = upg.desc;
        if (money < upg.cost) {
          // Not enough money
        }
        btn.onclick = (e) => {
          if (shiftDown || spaceDown) {
            while (money >= upg.cost) {
              if (!attemptSellingUpgrade(upg)) break;
            }
            updateUI();
          } else {
            attemptSellingUpgrade(upg);
            updateUI();
          }
        };
        container.appendChild(btn);
      });
    }

    function attemptSellingUpgrade(upg) {
      if (money >= upg.cost) {
        money -= upg.cost;
        upg.purchased++;
        backpackCapacity += upg.effect;
        // Scale cost more dramatically after 5 purchases
        if (upg.purchased < 5) {
          upg.cost = Math.round(upg.cost * 1.7);
        } else {
          upg.cost = Math.round(upg.cost * 2.5);
        }
        return true;
      }
      return false;
    }

    function sumSellingUpgrades() {
      let sum = 0;
      sellingUpgrades.forEach(su => {
        sum += su.effect * su.purchased;
      });
      return sum;
    }

    /* =======================
       PRESTIGE SYSTEM
    ========================== */
    function updatePrestigeMenu() {
      document.getElementById("livePP").innerText = prestigePoints;
      let potentialPP = 0;

      // We'll compute how many PPs you can buy with your totalEarned 
      // given the increasing cost for each subsequent PP
      let tempNextCost = nextPPcost;
      let localEarn = totalEarned;
      let localCount = 0;

      // We'll see how many times we can pay that "tempNextCost" from localEarn
      while (localEarn >= tempNextCost) {
        localCount++;
        localEarn -= tempNextCost;
        tempNextCost = tempNextCost * 1.2; 
      }
      potentialPP = localCount;

      document.getElementById("earnedPP").innerText = potentialPP;

      const fact = factories[factoryIndex];
      document.getElementById("currentFactory").innerText = fact.name;
      const nextF = factories[factoryIndex + 1] ? factories[factoryIndex + 1].name : "No Further Factories";
      document.getElementById("nextFactory").innerText = nextF;

      const baseVal = fact.products[0].base;
      const bestVal = fact.products[fact.products.length - 1].base;
      document.getElementById("baseValue").innerText = formatNumber(baseVal);
      document.getElementById("bestValue").innerText = formatNumber(bestVal);

      renderPrestigeUpgrades();

      // Check on-hand requirement
      let requiredOnHand = prestigeCount < prestigeRequirements.length
        ? prestigeRequirements[prestigeCount]
        : 1e99; // if we exceed 20 prestiges, just make it extremely large

      const confirmBtn = document.getElementById("confirmPrestige");
      if (money < requiredOnHand) {
        confirmBtn.disabled = true;
        confirmBtn.innerText = `Need $${formatNumber(requiredOnHand)} on hand`;
      } else {
        confirmBtn.disabled = false;
        confirmBtn.innerText = "‚úî Confirm";
      }
    }

    function renderPrestigeUpgrades() {
      const container = document.getElementById("prestigeUpgradesMenu");
      container.innerHTML = "<h3>Prestige Upgrades (Permanent)</h3>";
      prestigeUpgrades.forEach((pupg, i) => {
        const btn = document.createElement("button");
        btn.className = "button";
        if (pupg.purchased >= pupg.max) {
          btn.innerText = `${pupg.name} (MAXED)`;
          btn.disabled = true;
        } else {
          btn.innerText = `${pupg.name} (Cost: ${formatNumber(pupg.cost)} PP) [Bought: ${pupg.purchased}/${pupg.max}]`;
        }
        btn.title = pupg.description;
        btn.onclick = (e) => {
          if (prestigePoints >= pupg.cost && pupg.purchased < pupg.max) {
            prestigePoints -= pupg.cost;
            pupg.purchased++;
            // Apply effect
            if (pupg.name.includes("Divine Efficiency")) {
              prestigeMulti *= pupg.effect;
            }
            else if (pupg.name.includes("Temporal Mastery")) {
              cooldownTime *= pupg.effect;
            }
            else if (pupg.name.includes("Cosmic Workforce")) {
              employees.forEach(emp => {
                emp.rate = Math.round(emp.rate * pupg.effect);
              });
            }
            else if (pupg.name.includes("Galactic Expansion")) {
              prestigeMulti *= pupg.effect;
            }
            else if (pupg.name.includes("Eternal Workshop")) {
              factories.forEach(f => {
                f.products.forEach(p => {
                  p.base = Math.round(p.base * pupg.effect);
                });
              });
            }
            else if (pupg.name.includes("Auto Tycoon")) {
              // Stage 1 => autoProduce, Stage 2 => autoSell
              if (pupg.purchased === 1) {
                autoProduce = true;
                showNotification("Auto Production Unlocked!");
              } else if (pupg.purchased === 2) {
                autoSell = true;
                showNotification("Auto Selling Unlocked!");
              }
            }
            else if (pupg.name.includes("Prestige Pure Multi")) {
              prestigeMulti *= pupg.effect;
            }
            else if (pupg.name.includes("Prestige Auto-Operator")) {
              employees.forEach(emp => {
                emp.rate = Math.round(emp.rate * pupg.effect);
              });
            }
            else if (pupg.name.includes("VIP Client Order")) {
              vipChance += pupg.effect; // +2%
              if (vipChance > 0.3) vipChance = 0.3; // clamp at 30%
              vipMultiplier *= 1.05; 
            }

            // Increase cost
            pupg.cost = Math.round(pupg.cost * 1.5);
            updateUI();
          }
        };
        container.appendChild(btn);
      });
    }

    // Confirm Prestige
    document.getElementById("confirmPrestige").addEventListener("click", () => {
      // Check the on-hand requirement
      let requiredOnHand = prestigeCount < prestigeRequirements.length
        ? prestigeRequirements[prestigeCount]
        : 1e99;

      if (money >= requiredOnHand) {
        // Calculate how many PPs we can buy right now
        let localEarn = totalEarned;
        let localCount = 0;

        while (localEarn >= nextPPcost) {
          localCount++;
          localEarn -= nextPPcost;
          nextPPcost = nextPPcost * 1.2; 
        }

        prestigePoints += localCount;

        // Actually do the prestige reset
        prestigeCount++;
        money = 0;
        multiplier = 1;
        cooldownTime = baseCooldownTime;
        currentProductIndex = 0;
        totalProductsProduced = 0;
        challengeBonusApplied = false;
        productBatch = 1;

        // We'll keep the current prestigeMulti from upgrades but reset it to 1? 
        // Actually user says "prestige multi is permanent," but we typically multiply it. 
        // We'll keep the "base" at 1 but the "accumulated effect" remains in the variable. 
        // i.e. we do not reset `prestigeMulti = 1`, we just leave it as is from the upgrades. 
        // But to be consistent with old code, let's see. The user wants "permanent." 
        // We'll NOT reset it. We'll keep it.
        // => do nothing to prestigeMulti

        if (factoryIndex < factories.length - 1) {
          factoryIndex++;
        }

        // Reset normal upgrades & employees
        upgrades = [
          { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
          { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
          { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product to next tier.", purchased: 0 },
          { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
          { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
        ];
        employees = [
          {
            name: "üë∑ Efficient Operator",
            cost: 75,
            rate: 1,
            quantity: 0,
            description: "Generates $1/sec. Also reduces SELL time by 2% each.",
            purchased: 0
          },
          {
            name: "üë®‚Äçüîß Skilled Worker",
            cost: 250,
            rate: 5,
            quantity: 0,
            description: "Generates $5/sec. Also +1 backpack capacity per 5 workers.",
            purchased: 0
          },
          {
            name: "üõ†Ô∏è Master Craftsman",
            cost: 1000,
            rate: 20,
            quantity: 0,
            description: "Generates $20/sec. Also speeds production by 2% each 5 craftsman.",
            purchased: 0
          },
          {
            name: "üèÜ Production Supervisor",
            cost: 4000,
            rate: 50,
            quantity: 0,
            description: "Generates $50/sec. Also +5% multiplier every 10 supervisors.",
            purchased: 0
          },
          {
            name: "üíº Operations Manager",
            cost: 7500,
            rate: 100,
            quantity: 0,
            description: "Generates $100/sec. Unique synergy with product tiers.",
            purchased: 0
          }
        ];
        employeeTraining = {
          unlocked: false,
          cost: 150,
          effect: 1.2,
          purchased: false,
          description: "All employee production +20%."
        };

        // Reset selling if we're now after first Prestige => selling is unlocked
        if (prestigeCount > 0) {
          sellingUnlocked = true;
        } else {
          sellingUnlocked = false;
        }
        if (prestigeCount < 2) {
          autoSell = false;
        }

        // Reset the selling upgrades
        sellingUpgrades = [
          { name: "Bigger Backpack", cost: 100, effect: 10, desc: "+10 capacity", purchased: 0 },
          { name: "Carry Suitcase", cost: 1000, effect: 25, desc: "+25 capacity", purchased: 0 },
          { name: "Storage Container", cost: 20000, effect: 100, desc: "+100 capacity", purchased: 0 },
          { name: "Abandoned School", cost: 1e6, effect: 1000, desc: "+1000 capacity", purchased: 0 }
        ];
        backpackCapacity = 10;
        backpackUsed = 0;

        showNotification(`Prestige #${prestigeCount}! You gained ${localCount} new PP.`);
        updateUI();
      }
      document.getElementById("prestigeMenu").style.display = "none";
    });

    // Open & Close Menus
    document.getElementById("prestige").addEventListener("click", () => {
      document.getElementById("prestigeMenu").style.display = "block";
      updatePrestigeMenu();
    });
    document.getElementById("closePrestige").addEventListener("click", () => {
      document.getElementById("prestigeMenu").style.display = "none";
    });

    /* =======================
       STATS MENU
    ========================== */
    document.getElementById("statsBtn").addEventListener("click", () => {
      renderStats();
      document.getElementById("statsMenu").style.display = "block";
    });
    document.getElementById("closeStats").addEventListener("click", () => {
      document.getElementById("statsMenu").style.display = "none";
    });

    function renderStats() {
      const content = document.getElementById("statsContent");
      content.innerHTML = `
        <p><strong>Total Earned:</strong> $${formatNumber(totalEarned)}</p>
        <p><strong>Max Money Held:</strong> $${formatNumber(maxMoneyHeld)}</p>
        <p><strong>Total Products Produced:</strong> ${totalProductsProduced}</p>
        <p><strong>Current Cooldown:</strong> ${(cooldownTime/1000).toFixed(3)}s</p>
        <p><strong>VIP Chance:</strong> ${(vipChance * 100).toFixed(2)}%</p>
        <p><strong>VIP Multiplier:</strong> x${vipMultiplier.toFixed(2)}</p>
        <p><strong>Factory Index:</strong> ${factoryIndex + 1} / ${factories.length}</p>
        <p><strong>Product Batch Size:</strong> ${productBatch}</p>
        <p><strong>Multiplier (Normal):</strong> x${formatNumber(multiplier)}</p>
        <p><strong>Multiplier (Prestige):</strong> x${formatNumber(prestigeMulti)}</p>
        <p><strong>Prestige Count:</strong> ${prestigeCount} / 20 supported</p>
        <p><strong>Next PP Cost (Current):</strong> $${formatNumber(nextPPcost)}</p>
        <p><strong>Backpack Capacity:</strong> ${backpackCapacity}, Used: ${backpackUsed}</p>
        <p><strong>Auto Produce:</strong> ${autoProduce ? "Yes" : "No"}</p>
        <p><strong>Auto Sell:</strong> ${autoSell ? "Yes" : "No"}</p>
      `;
    }

    /* =======================
       INIT
    ========================== */
    window.onload = () => {
      updateUI();
      // If we are after Prestige 1, sellingUnlocked is true
      if (prestigeCount > 0) {
        sellingUnlocked = true;
      }
    };
  </script>
</body>
</html>
