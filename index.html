<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static's Infinite Factory Tycoon</title>
  <style>
    /* ===============================
       GLOBAL & RESPONSIVE UI
    ================================ */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
      transition: background 0.5s ease;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(0,0,0,0.85);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
      position: relative;
    }
    /* Buttons */
    .button {
      padding:10px 20px;
      margin:10px 5px;
      border:none;
      font-size:16px;
      cursor:pointer;
      background-color:#007bff;
      color:#fff;
      border-radius:5px;
      transition:background 0.3s;
      display:inline-block;
    }
    .button:hover {
      background-color:#0056b3;
    }
    /* Baby-blue background for mass-buy mode */
    .mass-buy-active {
      background-color:#89CFF0 !important;
    }
    /* Special gold style */
    .gold-button {
      background-color:#FFD700 !important;
      color:#000 !important;
      font-weight:normal;
    }
    .money-line {
      font-size:24px;
      font-weight:bold;
      margin-bottom:10px;
    }
    .cooldown {
      font-size:14px;
      color:#bbb;
    }
    .upgrade-container,
    .selling-container,
    .employee-container {
      margin-top:20px;
      padding:15px;
      background:rgba(255,255,255,0.1);
      border-radius:10px;
      display:flex;
      flex-wrap:wrap;
      justify-content:space-around;
    }
    .upgrade,.employee {
      flex:1 1 45%;
      margin:5px;
      padding:10px;
      background:rgba(0,0,0,0.5);
      border-radius:5px;
      cursor:pointer;
      transition:background 0.3s;
    }
    .upgrade:hover, .employee:hover {
      background:rgba(0,0,0,0.7);
    }
    /* Modal Menus */
    .modal-menu {
      display:none;
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:rgba(34,34,34,0.8);
      padding:20px;
      border-radius:10px;
      box-shadow:0 0 10px rgba(255,255,255,0.2);
      z-index:10000;
      max-width:90%;
      font-size:14px;
    }
    .modal-menu h2 {
      margin-top:0;
      font-size:20px;
    }
    /* Notification top-right */
    .notification {
      position:fixed;
      top:10px;
      right:10px;
      background:rgba(0,0,0,0.8);
      color:#fff;
      padding:10px 20px;
      border-radius:5px;
      display:none;
      z-index:20000;
      font-size:16px;
    }
    /* QR Code bottom-left (200x200) */
    .qr-container {
      position:fixed;
      bottom:10px;
      left:10px;
      width:200px;
      height:200px;
      z-index:1500;
    }
    .qr-container img {
      width:100%;
      height:100%;
      object-fit:contain;
    }
    /* Disabled button if no capacity or min cooldown */
    .disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    /* Sparkle animation for keybind feedback */
    @keyframes sparkle {
      0%   { box-shadow:0 0 5px #fff; }
      50%  { box-shadow:0 0 20px #fff; }
      100% { box-shadow:0 0 5px #fff; }
    }
    .sparkle {
      animation: sparklet 0.5s ease-in-out;
    }
    @keyframes sparklet {
      0%   { box-shadow:0 0 5px #fff; }
      50%  { box-shadow:0 0 20px #fff; }
      100% { box-shadow:0 0 5px #fff; }
    }
  </style>
</head>
<body>
  <!-- Notification (top-right) -->
  <div class="notification" id="notificationBox"></div>

  <div class="container">
    <!-- Money & Prestige Display -->
    <p class="money-line">
      üí∞ Money: $<span id="money">0</span>
      | üåü Prestige Points: <span id="prestigePoints">0</span> ‚Ñó
    </p>
    <p>
      üîÑ Multiplier: x<span id="multiplier">1.00</span>
      | Prestige Multi: x<span id="prestigeMulti">1.00</span>
    </p>

    <h2>üè≠ Factory Production</h2>
    <p>üè≠ Factory: <span id="factoryName"></span></p>
    <p>üì¶ Product: <span id="productName"></span> (Base: <span id="productBase">0</span>, Batch: <span id="productBatch">1</span>)</p>
    <button class="button" id="produce">üöÄ Produce Product</button>
    <p class="cooldown" id="cooldown">‚è≥ Cooldown: Ready</p>

    <!-- Normal Upgrades -->
    <div class="upgrade-container">
      <h2 style="width:100%">üìà Upgrades</h2>
      <div id="upgrades"></div>
    </div>

    <!-- Selling System (hidden if not unlocked) -->
    <div class="selling-container" id="sellingArea" style="display:none;">
      <h2>üíº Selling System</h2>
      <p>Backpack: <span id="backpackUsed">0</span> / <span id="backpackCapacity">0</span></p>
      <button class="button" id="sellAll">Sell All</button>
      <p class="cooldown" id="sellCooldown">üïí Selling Timer: Ready</p>
      <div id="sellingUpgrades"></div>
    </div>

    <!-- Employees -->
    <div class="employee-container">
      <h2 style="width:100%">üë• Employees</h2>
      <div id="employees"></div>
    </div>

    <!-- Prestige, Stats, Settings -->
    <div style="margin-top:20px;">
      <button class="button" id="prestige">üîÑ Prestige</button>
      <button class="button" id="statsBtn">üìä Stats</button>
      <button class="button" id="settingsBtn">‚öô Settings</button>
    </div>

    <!-- Credits -->
    <p style="margin-top:30px;">
      Made By <a href="https://sites.google.com/view/staticquasar931" target="_blank" style="color:#00d1ff;">Static</a>
    </p>
  </div>

  <!-- QR Code (200x200) -->
  <div class="qr-container">
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
      <img src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png"
           alt="Qr Code linking to Static's site"
           title="Click to visit Static's site"/>
    </a>
  </div>

  <!-- Prestige Menu -->
  <div class="modal-menu" id="prestigeMenu">
    <h2>üîÑ Prestige Confirmation</h2>
    <p>
      Reset your money, normal upgrades, employees, and backpack. The on-hand requirement grows each Prestige.<br>
      You gain PP from total earned, each point costs more than the last but never below 1.
    </p>
    <p>Current PP: <span id="livePP">0</span> ‚Ñó &nbsp;&nbsp; Potential PP: <span id="earnedPP">0</span> ‚Ñó</p>
    <p>üè≠ Current Factory: <span id="currentFactory"></span></p>
    <p>üè≠ Next Factory: <span id="nextFactory"></span></p>
    <p>Base Value: <span id="baseValue"></span> | Best Value: <span id="bestValue"></span></p>
    <div id="prestigeUpgradesMenu"></div>
    <button class="button" id="confirmPrestige">‚úî Confirm</button>
    <button class="button" id="closePrestige">‚ùå Cancel</button>
  </div>

  <!-- Stats Menu -->
  <div class="modal-menu" id="statsMenu">
    <h2>üìä Stats</h2>
    <div id="statsContent"></div>
    <button class="button" id="closeStats">‚ùå Close</button>
  </div>

  <!-- Settings Menu -->
  <div class="modal-menu" id="settingsMenu">
    <h2>‚öô Settings</h2>
    <p><strong>Keybinds:</strong></p>
    <ul style="text-align:left;max-width:400px;margin:auto;">
      <li>Produce: Q, W, Up Arrow, Left Arrow</li>
      <li>Sell All: E, S, Down Arrow, Right Arrow</li>
      <li>Mass Buy: Hold Shift or Space (baby-blue upgrade buttons + purchase count)</li>
    </ul>
    <p>Your progress is auto-saved. The selling system is hidden until unlocked.</p>
    <button class="button" id="resetGame">üîÅ Reset Progress</button>
    <p id="resetTimer" style="color:#f55;"></p>
    <p style="color:#f33;font-weight:bold;">Warning: The Undo may not work in all browsers if you refresh quickly.</p>
    <button class="button" id="closeSettings">‚ùå Close</button>
  </div>

  <!-- Selling Explanation Popup -->
  <div class="modal-menu" id="sellExplain" style="display:none;">
    <h2>üéâ Selling System Unlocked!</h2>
    <p>
      Producing products now places them into a backpack. Use "Sell All" or keybinds (E, S, Down/Right Arrow) to sell items for money.
    </p>
    <button class="button" id="closeSellExplain">Got It</button>
  </div>

  <script>
    "use strict";

    /* ===========================
       1. EXTENDED NUMBER FORMAT
    ============================ */
    const scaleUnits = [
      { v:1e3, l:"K" },
      { v:1e6, l:"M" },
      { v:1e9, l:"B" },
      { v:1e12, l:"T" },
      { v:1e15, l:"Qa" },
      { v:1e18, l:"Qi" },
      { v:1e21, l:"Sx" },
      { v:1e24, l:"Sp" },
      { v:1e27, l:"Oc" },
      { v:1e30, l:"No" },
      { v:1e33, l:"De" },
      { v:1e36, l:"Ud" },
      { v:1e39, l:"Dd" },
      { v:1e42, l:"Td" },
      { v:1e45, l:"Qd" },
      { v:1e48, l:"Pd" },
      { v:1e51, l:"Hd" }
      // Add more expansions as needed
    ];
    function formatNumber(num){
      if(num===0) return "0.00";
      let abs=Math.abs(num), sign=(num<0)?"-":"";
      // scientific fallback with 3 decimals
      if(abs>=1e100) return sign + abs.toExponential(3);
      for(let i=scaleUnits.length-1;i>=0;i--){
        if(abs>=scaleUnits[i].v){
          return sign + (abs/scaleUnits[i].v).toFixed(2) + " " + scaleUnits[i].l;
        }
      }
      return sign + abs.toFixed(2);
    }
    function formatCooldown(ms){
      if(ms<=0) return "0s";
      let s= ms/1000;
      if(s>=1) return s.toFixed(2)+"s";
      let str= s.toFixed(4).replace(/0+$/,"");
      return str+"s";
    }

    /* ===========================
       2. GAME STATE LOAD
    ============================ */
    let money= parseFloat(localStorage.getItem("money"))||0;
    let totalEarned= parseFloat(localStorage.getItem("totalEarned"))||0;
    let prestigePoints= parseFloat(localStorage.getItem("prestigePoints"))||0;
    let multiplier= parseFloat(localStorage.getItem("multiplier"))||1;
    let prestigeMulti= parseFloat(localStorage.getItem("prestigeMulti"))||1;
    let totalProductsProduced= parseInt(localStorage.getItem("totalProductsProduced"))||0;
    let productBatch= parseInt(localStorage.getItem("productBatch"))||1;
    let factoryIndex= parseInt(localStorage.getItem("factoryIndex"))||0;
    let currentProductIndex= parseInt(localStorage.getItem("currentProductIndex"))||0;
    let cooldownTime= parseFloat(localStorage.getItem("cooldownTime"))||5000;
    let maxMoneyHeld= parseFloat(localStorage.getItem("maxMoneyHeld"))||0;
    let vipChance= parseFloat(localStorage.getItem("vipChance"))||0.05;
    let vipMultiplier= parseFloat(localStorage.getItem("vipMultiplier"))||20;
    let prestigeCount= parseInt(localStorage.getItem("prestigeCount"))||0;
    let nextPPcost= parseFloat(localStorage.getItem("nextPPcost"))||1000;
    let challengeBonusApplied= (localStorage.getItem("challengeBonusApplied")==="true");
    let lastSaveTime= parseInt(localStorage.getItem("lastSaveTime"))||Date.now();

    // SELLING
    let sellingUnlocked= (prestigeCount>0);
    let backpackCapacity= parseInt(localStorage.getItem("backpackCapacity"))||10;
    let backpackUsed= parseInt(localStorage.getItem("backpackUsed"))||0;
    let sellingTime= 3000;
    let autoProduce= (localStorage.getItem("autoProduce")==="true");
    let autoSell= (localStorage.getItem("autoSell")==="true");

    // SHIFT & SPACE
    let shiftDown=false;
    let spaceDown=false;
    let keyDownSet= new Set();
    let resetInProgress= false;

    // For offline
    let offlineSec= Math.floor((Date.now()- lastSaveTime)/1000);

    /* ===========================
       3. FACTORIES
    ============================ */
    const factories= [
      {
        name:"üß∏ Children's Toys Factory",
        bg:"linear-gradient(to right,#ff9a9e,#fad0c4)",
        products:[
          { name:"Wooden Blocks", base:10 },
          { name:"Toy Cars", base:15 },
          { name:"Stuffed Animals", base:20 },
          { name:"Puzzle Games", base:25 },
          { name:"Action Figures", base:30 },
          { name:"Dollhouses", base:35 },
          { name:"Remote Control Cars", base:40 },
          { name:"Educational Kits", base:45 },
          { name:"Model Trains", base:50 },
          { name:"Custom Playsets", base:60 }
        ]
      },
      {
        name:"üç∞ Sweet Treats Bakery",
        bg:"linear-gradient(to right,#fbc2eb,#a6c1ee)",
        products:[
          { name:"Cupcakes", base:12 },
          { name:"Cookies", base:18 },
          { name:"Brownies", base:24 },
          { name:"Donuts", base:30 },
          { name:"Muffins", base:36 },
          { name:"Pastries", base:42 },
          { name:"Cakes", base:50 },
          { name:"Macarons", base:58 },
          { name:"Eclairs", base:66 },
          { name:"Gourmet Pies", base:75 }
        ]
      },
      {
        name:"üé® Artisan Crafts Workshop",
        bg:"linear-gradient(to right,#a1c4fd,#c2e9fb)",
        products:[
          { name:"Handmade Cards", base:14 },
          { name:"Ceramic Mugs", base:20 },
          { name:"Knitted Scarves", base:26 },
          { name:"Wooden Toys", base:32 },
          { name:"Painted Vases", base:38 },
          { name:"Handcrafted Jewelry", base:44 },
          { name:"Embroidered Pillows", base:50 },
          { name:"Custom Furniture", base:58 },
          { name:"Vintage Clocks", base:66 },
          { name:"Bespoke Art Pieces", base:75 }
        ]
      },
      {
        name:"üì± Tech Gadget Studio",
        bg:"linear-gradient(to right,#a18cd1,#fbc2eb)",
        products:[
          { name:"Smartphone Cases", base:16 },
          { name:"Wireless Earbuds", base:22 },
          { name:"Portable Chargers", base:28 },
          { name:"Bluetooth Speakers", base:34 },
          { name:"Smartwatches", base:40 },
          { name:"Tablet Accessories", base:46 },
          { name:"VR Headsets", base:52 },
          { name:"Drone Kits", base:60 },
          { name:"Gaming Controllers", base:68 },
          { name:"Advanced Gadgets", base:78 }
        ]
      },
      {
        name:"üíé Luxury Gift Atelier",
        bg:"linear-gradient(to right,#ffecd2,#fcb69f)",
        products:[
          { name:"Artisanal Chocolates", base:18 },
          { name:"Designer Scarves", base:26 },
          { name:"Luxury Candles", base:34 },
          { name:"Fine Wines", base:42 },
          { name:"Handcrafted Jewelry", base:50 },
          { name:"Exclusive Perfumes", base:58 },
          { name:"Gourmet Baskets", base:66 },
          { name:"Limited Edition Watches", base:74 },
          { name:"Premium Leather Goods", base:82 },
          { name:"Custom Masterpieces", base:90 }
        ]
      },
      {
        name:"üîû Adult Toys Factory",
        bg:"linear-gradient(to right,#4f0000,#8b0000)",
        products:[
          { name:"Basic Toys", base:200 },
          { name:"Novelty Items", base:500 },
          { name:"Special Editions", base:800 },
          { name:"Themed Sets", base:1200 },
          { name:"Remote-Controlled", base:1800 },
          { name:"Luxury Models", base:2500 },
          { name:"Smart Devices", base:4000 },
          { name:"Premium Kits", base:6000 },
          { name:"Custom Orders", base:10000 },
          { name:"Futuristic Concepts", base:20000 }
        ]
      }
    ];

    /* EMPLOYEES */
    let employees= JSON.parse(localStorage.getItem("employees"))|| [
      {
        name:"üë∑ Worker #1",
        cost:75,
        rate:1,
        quantity:0,
        description:"Generates $1/sec + ?",
        purchased:0
      },
      {
        name:"üë®‚Äçüîß Worker #2",
        cost:500,
        rate:5,
        quantity:0,
        description:"Generates $5/sec + ?",
        purchased:0
      },
      {
        name:"üì¶ Porter #3",
        cost:1500,
        rate:0,
        quantity:0,
        description:"Slowly increases backpack capacity? ???",
        purchased:0
      }
    ];
    let employeeTraining= JSON.parse(localStorage.getItem("employeeTraining"))|| {
      unlocked:false,
      cost:200,
      effect:1.2,
      purchased:false,
      description:"All employees +20% production."
    };

    // Normal Upgrades
    let upgrades= JSON.parse(localStorage.getItem("upgrades"))|| [
      { name:"Quality Increase", cost:25, effect:1.5, description:"Production multiplier +50%.", purchased:0 },
      { name:"‚öôÔ∏è Speedy Assembly", cost:50, effect:0.9, description:"Cooldown -10%.", purchased:0 },
      { name:"Product Upgrade", cost:250, effect:"upgradeProduct", description:"Upgrade product tier.", purchased:0 },
      { name:"üè≠ Factory Expansion", cost:200, effect:0.95, description:"Cooldown -5%.", purchased:0 },
      { name:"üì¶ Batch Production", cost:400, effect:"increaseBatch", description:"Batch size +1.", purchased:0 }
    ];

    // Prestige Upgrades
    let prestigeUpgrades= JSON.parse(localStorage.getItem("prestigeUpgrades"))|| [
      {
        name:"Divine Efficiency ‚ú®",
        cost:5,
        effect:1.1,
        description:"Prestige Multi +10%.",
        purchased:0,
        max:999
      },
      {
        name:"Temporal Mastery ‚è≥",
        cost:10,
        effect:0.95,
        description:"Cooldown -5%.",
        purchased:0,
        max:999
      },
      {
        name:"Eternal Workshop üè≠",
        cost:25,
        effect:1.25,
        description:"Product base value +25%.",
        purchased:0,
        max:999
      },
      {
        name:"Auto Tycoon (Stage)",
        cost:500,
        effect:"autoStage",
        description:"Stage 1 => ???, Stage 2 => ???",
        purchased:0,
        max:2
      },
      {
        name:"Prestige Pure Multi",
        cost:20,
        effect:1.1,
        description:"Prestige Multi +10%.",
        purchased:0,
        max:999
      },
      {
        name:"VIP Client Order",
        cost:30,
        effect:0.02,
        description:"VIP chance +2% (cap 30%), VIP multiplier +5%.",
        purchased:0,
        max:500
      },
      {
        name:"Selling Speed Mastery",
        cost:50,
        effect:0.9,
        description:"Selling time -10%.",
        purchased:0,
        max:10
      }
    ];

    // SELLING & BACKPACK
    let backpackIndex= parseInt(localStorage.getItem("backpackIndex"))||0;
    let backpackData= JSON.parse(localStorage.getItem("backpackData"));
    if(!backpackData){
      backpackData=[];
      for(let i=1;i<=30;i++){
        backpackData.push({
          name:`Backpack #${i}`,
          cost: Math.round(100*Math.pow(2.5,i)),
          effect:10*i
        });
      }
      backpackData.push({name:"A Hole", cost:1e8, effect:1000});
      backpackData.push({name:"A Bigger Hole", cost:5e9, effect:5000});
    }

    let sellMultiIndex= parseInt(localStorage.getItem("sellMultiIndex"))||0;
    let sellMultiLevels= [40,30,20,10,5];
    let sellMultiCost= parseFloat(localStorage.getItem("sellMultiCost"))||1000;
    let sellingUpgrades= JSON.parse(localStorage.getItem("sellingUpgrades"))|| [
      {
        name:"Faster Sell",
        cost:3000,
        effect:0.9,
        desc:"Selling time -10% each purchase (cost doubles).",
        purchased:0
      }
    ];

    /* ===========================
       4. OFFLINE PRODUCTION
    ============================ */
    if(offlineSec>0){
      setTimeout(()=>{
        let eRate= employees.reduce((sum,e)=> sum+(e.rate* e.quantity),0);
        if(eRate>0){
          let earned= eRate* multiplier* prestigeMulti* offlineSec;
          money+=earned;
          totalEarned+=earned;
          showNotification(`While offline for ${offlineSec}s, you earned $${formatNumber(earned)}!`);
          updateUI();
        }
      },50);
    }

    /* ===========================
       5. SAVE FUNCTION
    ============================ */
    function saveGame(){
      if(resetInProgress) return;
      localStorage.setItem("money", money);
      localStorage.setItem("totalEarned", totalEarned);
      localStorage.setItem("prestigePoints", prestigePoints);
      localStorage.setItem("multiplier", multiplier);
      localStorage.setItem("prestigeMulti", prestigeMulti);
      localStorage.setItem("cooldownTime", cooldownTime);
      localStorage.setItem("totalProductsProduced", totalProductsProduced);
      localStorage.setItem("challengeBonusApplied", challengeBonusApplied);
      localStorage.setItem("productBatch", productBatch);
      localStorage.setItem("factoryIndex", factoryIndex);
      localStorage.setItem("currentProductIndex", currentProductIndex);
      localStorage.setItem("maxMoneyHeld", maxMoneyHeld);
      localStorage.setItem("vipChance", vipChance);
      localStorage.setItem("vipMultiplier", vipMultiplier);
      localStorage.setItem("prestigeCount", prestigeCount);
      localStorage.setItem("nextPPcost", nextPPcost);
      localStorage.setItem("lastSaveTime", Date.now());

      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("employeeTraining", JSON.stringify(employeeTraining));
      localStorage.setItem("upgrades", JSON.stringify(upgrades));
      localStorage.setItem("prestigeUpgrades", JSON.stringify(prestigeUpgrades));

      localStorage.setItem("sellingUnlocked", sellingUnlocked);
      localStorage.setItem("backpackCapacity", backpackCapacity);
      localStorage.setItem("backpackUsed", backpackUsed);
      localStorage.setItem("sellMultiIndex", sellMultiIndex);
      localStorage.setItem("sellMultiCost", sellMultiCost);
      localStorage.setItem("sellingUpgrades", JSON.stringify(sellingUpgrades));
      localStorage.setItem("backpackIndex", backpackIndex);
      localStorage.setItem("backpackData", JSON.stringify(backpackData));
      localStorage.setItem("autoProduce", autoProduce);
      localStorage.setItem("autoSell", autoSell);
    }

    /* ===========================
       6. SHIFT/SPACE DETECTION
    ============================ */
    window.addEventListener("keydown", (e)=>{
      keyDownSet.add(e.key.toLowerCase());
      keyDownSet.add(e.code);
      if(e.key==="Shift") shiftDown=true;
      if(e.code==="Space") spaceDown=true;
      refreshMassBuyUI();
    });
    window.addEventListener("keyup", (e)=>{
      keyDownSet.delete(e.key.toLowerCase());
      keyDownSet.delete(e.code);
      if(e.key==="Shift") shiftDown=false;
      if(e.code==="Space") spaceDown=false;
      refreshMassBuyUI();
    });

    /* ===========================
       7. NOTIFICATIONS & SPARKLE
    ============================ */
    function showNotification(msg){
      const box= document.getElementById("notificationBox");
      box.innerText= msg;
      box.style.display="block";
      setTimeout(()=>{ box.style.display="none"; },3000);
    }
    function sparkleButton(btn){
      btn.classList.add("sparkle");
      setTimeout(()=> btn.classList.remove("sparkle"),500);
    }

    /* ===========================
       8. CLAMP COOL DOWN / SELL TIME
    ============================ */
    function clampTimes(){
      if(cooldownTime<50) cooldownTime=50;
      if(sellingTime<50) sellingTime=50;
    }

    /* ===========================
       9. UI UPDATE
    ============================ */
    function updateUI(){
      clampTimes();
      if(money>maxMoneyHeld) maxMoneyHeld= money;
      document.getElementById("money").innerText= formatNumber(money);
      document.getElementById("prestigePoints").innerText= formatNumber(prestigePoints);
      document.getElementById("multiplier").innerText= formatNumber(multiplier);
      document.getElementById("prestigeMulti").innerText= formatNumber(prestigeMulti);

      const f= factories[factoryIndex];
      document.getElementById("factoryName").innerText= f.name;
      const prod= f.products[currentProductIndex];
      document.getElementById("productName").innerText= prod.name;
      document.getElementById("productBase").innerText= formatNumber(prod.base);
      document.getElementById("productBatch").innerText= productBatch;

      let potential= prod.base* multiplier* prestigeMulti* productBatch;
      let tip= `Potential Earn (no VIP): ~$${formatNumber(potential)}\nCooldown: ${formatCooldown(cooldownTime)}`;
      if(shiftDown||spaceDown) tip+= "\n(Mass Buy Mode)";
      document.getElementById("produce").title= tip;

      // Show or hide the selling area
      const sellArea= document.getElementById("sellingArea");
      if(sellingUnlocked){
        sellArea.style.display="block";
        document.getElementById("backpackUsed").innerText= backpackUsed;
        document.getElementById("backpackCapacity").innerText= backpackCapacity;
      } else {
        sellArea.style.display="none";
      }

      // If backpack is full => disable produce
      const produceBtn= document.getElementById("produce");
      if(sellingUnlocked && backpackUsed>= backpackCapacity){
        produceBtn.disabled=true;
        produceBtn.classList.add("disabled");
      } else {
        produceBtn.disabled=false;
        produceBtn.classList.remove("disabled");
      }

      renderUpgrades();
      renderSellingUpgrades();
      renderEmployees();
      checkEmployeeTrainingUnlock();
      renderEmployeeTraining();
      updatePrestigeMenu();
      updateBackground();
      refreshMassBuyUI(); // update mass-buy counts
      saveGame();
    }
    function updateBackground(){
      document.body.style.background= factories[factoryIndex].bg;
    }

    /* ===========================
       10. MASS BUY SIMULATORS
    ============================ */
    // For each type of item, we define how cost scales, so we can compute how many times we can buy in a single chunk of money.
    // We'll do a function "simulateMaxBuy(item, type, moneyRemaining)"
    // Each item has its own cost scale logic:
    // - Normal Upgrades: if purchased<5 => cost= cost*1.6, else cost= cost*2.5
    // - Speedy / Factory Exp => same logic, but also skip if cooldownTime=50
    // - Employees: if purchased<5 => cost= cost*1.5, else cost= cost*2.2
    // - Backpack => if backpackIndex < last => cost next item, else cost= cost*2, effect= effect*1.5
    // - SellMulti => cost= cost*2 each time
    // - PrestigeUpgrades => cost= cost*1.6 each time
    // This function returns how many times we can buy with the current money.

    // For normal upgrades, we need to know the item purchased. We'll pass the item object.
    function simulateMaxBuyNormalUpgrade(item, moneyRemaining){
      // If item is Speedy or Factory Exp and cooldownTime=50 => can't buy further
      if((item.name==="‚öôÔ∏è Speedy Assembly"||item.name==="üè≠ Factory Expansion") && cooldownTime<=50){
        return 0;
      }
      let count=0;
      let cost=item.cost;
      let purchased= item.purchased;
      while(moneyRemaining>= cost){
        moneyRemaining-= cost;
        count++;
        purchased++;
        // scale cost
        if(item.name==="‚öôÔ∏è Speedy Assembly" || item.name==="üè≠ Factory Expansion"){
          // same logic as normal if item isn't at min cd
          if(purchased<5) cost= Math.round(cost*1.6);
          else cost= Math.round(cost*2.5);
        } else if(item.name==="Product Upgrade" || item.name==="Quality Increase" || item.name==="üì¶ Batch Production"){
          if(purchased<5) cost= Math.round(cost*1.6);
          else cost= Math.round(cost*2.5);
        } else {
          // default
          if(purchased<5) cost= Math.round(cost*1.6);
          else cost= Math.round(cost*2.5);
        }
        if((item.name==="‚öôÔ∏è Speedy Assembly"|| item.name==="üè≠ Factory Expansion") && cooldownTime<=50){
          // once we purchase one, if it hits min cd => no more
          break;
        }
      }
      return count;
    }

    // Employees
    function simulateMaxBuyEmployee(emp, moneyRemaining){
      let count=0;
      let cost= emp.cost;
      let purchased= emp.purchased;
      while(moneyRemaining>= cost){
        moneyRemaining-= cost;
        count++;
        purchased++;
        if(purchased<5) cost= Math.round(cost*1.5);
        else cost= Math.round(cost*2.2);
      }
      return count;
    }

    // Backpack single upgrade
    // If we haven't reached the end of the array => we move to next index
    // If at end => cost= cost*2 each time
    // But for mass buy, the user can purchase multiple times. This is tricky because after we buy once, we might skip to the next index or keep re-using the same item. We'll do a loop approach that tries to buy 1 item at a time and see if the user can keep going. This is a simplified approach ‚Äì we only let the user buy the next item once if there's an index left, then do infinite item if at end.
    // For a single button, you can only buy 1 time => automatically move to next index. If SHIFT is down, we keep going.
    function simulateMaxBuyBackpack(moneyRemaining){
      let count=0;
      let localIndex= backpackIndex;
      let localData= JSON.parse(JSON.stringify(backpackData)); // copy to avoid messing real data
      while(true){
        if(localIndex>= localData.length){
          // we are beyond last => let's take the last item
          let lastItem= localData[ localData.length-1 ];
          // scale infinite approach
          let cost= lastItem.cost;
          while(moneyRemaining>= cost){
            moneyRemaining-= cost;
            count++;
            cost= Math.round(cost*2);
            lastItem.cost= cost; // store updated cost
          }
          break;
        } else {
          // check the current item
          let item= localData[localIndex];
          let cost= item.cost;
          if(moneyRemaining>= cost){
            moneyRemaining-= cost;
            count++;
            localIndex++;
          } else{
            break;
          }
        }
      }
      return count;
    }

    // Sell Multi
    function simulateMaxBuySellMulti(moneyRemaining){
      let count=0;
      let localIndex= sellMultiIndex;
      let localCost= sellMultiCost;
      while(moneyRemaining>= localCost){
        moneyRemaining-= localCost;
        count++;
        // scale
        localIndex++;
        localCost= Math.round(localCost*2);
        if(localIndex>= sellMultiLevels.length){
          // we can keep going but effect= +5% each time
          // still cost doubles
        }
      }
      return count;
    }

    // Selling Upgrades (like "Faster Sell")
    function simulateMaxBuySellingUpgrade(su, moneyRemaining){
      let count=0;
      let localCost= su.cost;
      let purchased= su.purchased;
      while(moneyRemaining>= localCost){
        moneyRemaining-= localCost;
        count++;
        purchased++;
        localCost= Math.round(localCost*2);
      }
      return count;
    }

    // Prestige Upgrades
    function simulateMaxBuyPrestigeUpgrade(pu, PP){
      if(pu.purchased>= pu.max) return 0;
      let count=0;
      let cost= pu.cost;
      let purchased= pu.purchased;
      while(PP>= cost && purchased< pu.max){
        PP-= cost;
        count++;
        purchased++;
        cost= Math.round(cost*1.6);
      }
      return count;
    }

    // We'll do similarly for employees, normal upgrades, etc.

    /* ===========================
       11. REFRESH MASS BUY UI
    ============================ */
    function refreshMassBuyUI(){
      // We'll only apply the baby-blue style and " (xN)" to relevant upgrade/employee/prestige/selling buttons
      // Normal Upgrades
      const upgradeBtns= document.querySelectorAll("#upgrades .upgrade");
      upgradeBtns.forEach((btn, i)=>{
        let baseText= btn.innerText.split(" (x")[0];
        // find the item
        let item= upgrades[i];
        // if SHIFT/SPACE => compute how many we can buy
        if(shiftDown || spaceDown){
          btn.classList.add("mass-buy-active");
          let max= simulateMaxBuyNormalUpgrade(item, money);
          btn.innerText= `${baseText} (x${max})`;
        } else {
          btn.classList.remove("mass-buy-active");
          btn.innerText= baseText;
        }
      });

      // Employees
      const empBtns= document.querySelectorAll("#employees .employee");
      empBtns.forEach((btn, i)=>{
        let baseText= btn.innerText.split(" (x")[0];
        let emp= employees[i];
        if(shiftDown|| spaceDown){
          btn.classList.add("mass-buy-active");
          let max= simulateMaxBuyEmployee(emp, money);
          btn.innerText= `${baseText} (x${max})`;
        } else {
          btn.classList.remove("mass-buy-active");
          btn.innerText= baseText;
        }
      });

      // Backpack & Sell Multi & Selling Upgrades
      const suContainer= document.getElementById("sellingUpgrades");
      if(suContainer){
        let suBtns= suContainer.querySelectorAll(".upgrade");
        // We expect 1 = backpack, 1= sellMulti, rest are sellingUpgrades
        // So the first button => backpack, second => sellMulti, then the rest => other SU
        // We'll do a simple approach
        suBtns.forEach((btn, i)=>{
          let baseText= btn.innerText.split(" (x")[0];
          if(shiftDown|| spaceDown){
            btn.classList.add("mass-buy-active");
            // parse which item
            if(i===0){
              // Backpack
              let max= simulateMaxBuyBackpack(money);
              btn.innerText= `${baseText} (x${max})`;
            } else if(i===1){
              // SellMulti
              let max= simulateMaxBuySellMulti(money);
              btn.innerText= `${baseText} (x${max})`;
            } else {
              // SellingUpgrades array => i-2 index
              let suIndex= i-2;
              let item= sellingUpgrades[ suIndex ];
              let max= simulateMaxBuySellingUpgrade(item, money);
              btn.innerText= `${baseText} (x${max})`;
            }
          } else{
            btn.classList.remove("mass-buy-active");
            btn.innerText= baseText;
          }
        });
      }

      // Prestige Upgrades
      const puContainer= document.getElementById("prestigeUpgradesMenu");
      if(puContainer){
        let pBtns= puContainer.querySelectorAll(".upgrade");
        pBtns.forEach((btn, i)=>{
          let baseText= btn.innerText.split(" (x")[0];
          let pu= prestigeUpgrades[i];
          if(shiftDown|| spaceDown){
            btn.classList.add("mass-buy-active");
            let max= simulateMaxBuyPrestigeUpgrade(pu, prestigePoints);
            btn.innerText= `${baseText} (x${max})`;
          } else{
            btn.classList.remove("mass-buy-active");
            btn.innerText= baseText;
          }
        });
      }
    }

    /* ===========================
       12. REMAINING RENDER
    ============================ */
    function renderUpgrades(){
      const cont= document.getElementById("upgrades");
      cont.innerHTML="";
      upgrades.forEach((u,i)=>{
        let btn= document.createElement("button");
        btn.className="button upgrade";
        if(u.name==="Product Upgrade") btn.classList.add("gold-button");

        // If upgrade is Speedy/FactoryExp but cooldownTime=50 => disable
        if((u.name==="‚öôÔ∏è Speedy Assembly"||u.name==="üè≠ Factory Expansion") && cooldownTime<=50){
          btn.disabled= true;
          btn.innerText=`${u.name} (Min CD Reached)`;
        } else {
          btn.innerText=`${u.name} ($${formatNumber(u.cost)})`;
        }

        btn.title= u.description;
        btn.onclick= ()=>{
          if(!btn.disabled && money>= u.cost){
            if(shiftDown||spaceDown){
              // mass buy
              let count=0;
              while(money>= u.cost){
                if(!attemptUpgradePurchase(u)) break;
                count++;
                if((u.name==="‚öôÔ∏è Speedy Assembly"||u.name==="üè≠ Factory Expansion") && cooldownTime<=50){
                  // can't buy more
                  break;
                }
              }
              sparkleButton(btn);
              updateUI();
            } else{
              attemptUpgradePurchase(u);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptUpgradePurchase(u){
      if(u.name==="‚öôÔ∏è Speedy Assembly"||u.name==="üè≠ Factory Expansion"){
        if(cooldownTime<=50) return false;
      }
      if(money>=u.cost){
        money-= u.cost;
        u.purchased++;
        // apply effect
        if(u.name==="‚öôÔ∏è Speedy Assembly"||u.name==="üè≠ Factory Expansion"){
          cooldownTime*= u.effect;
          clampTimes();
        } else if(u.name==="Product Upgrade"){
          const f= factories[factoryIndex];
          if(currentProductIndex< f.products.length-1) currentProductIndex++;
        } else if(u.effect==="increaseBatch"){
          productBatch++;
        } else{
          multiplier*= u.effect;
        }
        // scale cost
        if(u.purchased<5) u.cost= Math.round(u.cost*1.6);
        else u.cost= Math.round(u.cost*2.5);
        return true;
      }
      return false;
    }

    // Selling Upgrades
    function renderSellingUpgrades(){
      const cont= document.getElementById("sellingUpgrades");
      cont.innerHTML="";
      if(!sellingUnlocked) return;
      // backpack
      let bItem= backpackData[backpackIndex];
      let bpBtn= document.createElement("button");
      bpBtn.className="button upgrade";
      bpBtn.innerText= `${bItem.name} ($${formatNumber(bItem.cost)})`;
      bpBtn.title= `+${bItem.effect} capacity`;
      bpBtn.onclick= ()=>{
        if(money>= bItem.cost){
          if(shiftDown||spaceDown){
            // mass buy
            while(money>= bItem.cost){
              if(!purchaseBackpack(bItem)) break;
            }
            sparkleButton(bpBtn);
            updateUI();
          } else{
            purchaseBackpack(bItem);
            sparkleButton(bpBtn);
            updateUI();
          }
        }
      };
      cont.appendChild(bpBtn);

      // Sell Multi
      let eff= sellMultiLevels[sellMultiIndex]||5;
      let smBtn= document.createElement("button");
      smBtn.className="button upgrade";
      smBtn.innerText=`Selling Multi +${eff}% ($${formatNumber(sellMultiCost)})`;
      smBtn.title=`Boost selling money by +${eff}%. cost x2 each purchase.`;
      smBtn.onclick= ()=>{
        if(money>= sellMultiCost){
          if(shiftDown||spaceDown){
            while(money>= sellMultiCost){
              if(!purchaseSellMulti()) break;
            }
            sparkleButton(smBtn);
            updateUI();
          } else{
            purchaseSellMulti();
            sparkleButton(smBtn);
            updateUI();
          }
        }
      };
      cont.appendChild(smBtn);

      // Other sellingUpgrades
      sellingUpgrades.forEach((su,i)=>{
        let btn= document.createElement("button");
        btn.className="button upgrade";
        btn.innerText= `${su.name} ($${formatNumber(su.cost)})`;
        btn.title= su.desc;
        btn.onclick= ()=>{
          if(money>= su.cost){
            if(shiftDown||spaceDown){
              while(money>= su.cost){
                if(!attemptSellingUpgrade(su)) break;
              }
              sparkleButton(btn);
              updateUI();
            } else{
              attemptSellingUpgrade(su);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function purchaseBackpack(bItem){
      if(money>= bItem.cost){
        money-= bItem.cost;
        backpackCapacity+= bItem.effect;
        if(backpackIndex< backpackData.length-1){
          backpackIndex++;
        } else{
          // infinite scaling => cost= cost*2, effect= effect*1.5
          bItem.cost= Math.round(bItem.cost*2);
          bItem.effect= Math.round(bItem.effect*1.5);
        }
        return true;
      }
      return false;
    }
    function purchaseSellMulti(){
      if(money>= sellMultiCost){
        money-= sellMultiCost;
        let eff= sellMultiLevels[sellMultiIndex]||5;
        multiplier*= (1+ eff/100);
        if(sellMultiIndex< sellMultiLevels.length-1){
          sellMultiIndex++;
        }
        sellMultiCost= Math.round(sellMultiCost*2);
        return true;
      }
      return false;
    }
    function attemptSellingUpgrade(su){
      if(money>= su.cost){
        money-= su.cost;
        su.purchased++;
        if(su.name==="Faster Sell"){
          sellingTime*= su.effect;
          clampTimes();
          su.cost= Math.round(su.cost*2);
        }
        return true;
      }
      return false;
    }

    // Employees
    function renderEmployees(){
      const cont= document.getElementById("employees");
      cont.innerHTML="";
      employees.forEach((emp,i)=>{
        let btn= document.createElement("button");
        btn.className="button employee";
        let baseLabel= `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        btn.innerText= baseLabel;
        // synergy reveal for Porter #3 if sellingUnlocked
        let desc= emp.description;
        if(emp.name.includes("Porter") && sellingUnlocked){
          desc="Generates $0/sec. Slowly adds +1 capacity every 10s!";
        }
        // show base and multi
        let baseRate= emp.rate;
        let withMulti= (emp.rate* multiplier).toFixed(2);
        btn.title= `${desc}\nBase: $${baseRate}/sec, With Multi: $${withMulti}/sec`;
        btn.onclick= ()=>{
          if(money>= emp.cost){
            if(shiftDown||spaceDown){
              while(money>= emp.cost){
                if(!attemptEmployeePurchase(emp)) break;
              }
              sparkleButton(btn);
              updateUI();
            } else{
              attemptEmployeePurchase(emp);
              sparkleButton(btn);
              updateUI();
            }
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptEmployeePurchase(emp){
      if(money>=emp.cost){
        money-= emp.cost;
        emp.quantity++;
        emp.purchased++;
        if(emp.purchased<5) emp.cost= Math.round(emp.cost*1.5);
        else emp.cost= Math.round(emp.cost*2.2);
        return true;
      }
      return false;
    }
    // If total employees >=10 => unlock training
    function checkEmployeeTrainingUnlock(){
      let totalE= employees.reduce((s,e)=> s+ e.quantity,0);
      if(totalE>=10) employeeTraining.unlocked= true;
    }
    function renderEmployeeTraining(){
      if(employeeTraining.unlocked && !employeeTraining.purchased){
        const cont= document.getElementById("upgrades");
        const btn= document.createElement("button");
        btn.className="button upgrade";
        let label= `Employee Training ($${formatNumber(employeeTraining.cost)})`;
        btn.innerText= label;
        btn.title= employeeTraining.description;
        btn.onclick= ()=>{
          if(money>= employeeTraining.cost){
            money-= employeeTraining.cost;
            employeeTraining.purchased= true;
            employees.forEach(e=> e.rate= Math.round(e.rate* employeeTraining.effect));
            sparkleButton(btn);
            updateUI();
          }
        };
        cont.appendChild(btn);
      }
    }

    // Porter synergy
    setInterval(()=>{
      if(sellingUnlocked){
        let p3= employees.find(e=> e.name.includes("Porter #3"));
        if(p3 && p3.quantity>0){
          backpackCapacity+= p3.quantity;
          updateUI();
        }
      }
    },10000);

    // Passive Employee Income
    setInterval(()=>{
      let eRate= employees.reduce((s,e)=> s+(e.rate* e.quantity),0);
      if(eRate>0){
        let inc= eRate* multiplier* prestigeMulti;
        money+= inc;
        totalEarned+= inc;
        updateUI();
      }
    },1000);

    /* ===========================
       13. PRODUCE
    ============================ */
    let producing=false, produceInterval=null;
    document.getElementById("produce").addEventListener("click",()=>{
      if(!producing){
        doProduce();
        sparkleButton(document.getElementById("produce"));
      }
    });
    function doProduce(){
      producing=true;
      clampTimes();
      let cd= cooldownTime;
      if(produceInterval) clearInterval(produceInterval);
      produceInterval= setInterval(()=>{
        cd-=50;
        if(cd<0) cd=0;
        document.getElementById("cooldown").innerText=`‚è≥ Cooldown: ${formatCooldown(cd)}`;
        if(cd<=0){
          clearInterval(produceInterval);
          let f= factories[factoryIndex];
          let p= f.products[currentProductIndex];
          let val= p.base* multiplier* prestigeMulti* productBatch;
          if(!sellingUnlocked){
            // immediate money
            if(Math.random()< vipChance){
              val*=vipMultiplier;
              showNotification(`VIP order! +${vipMultiplier}x bonus`);
            }
            money+= val;
            totalEarned+= val;
          } else{
            // goes to backpack
            let space= backpackCapacity- backpackUsed;
            let actual= (productBatch> space)? space: productBatch;
            backpackUsed+= actual;
          }
          totalProductsProduced++;
          if(!challengeBonusApplied && totalProductsProduced>=100){
            multiplier*=1.1;
            challengeBonusApplied= true;
            showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
          }
          producing=false;
          document.getElementById("cooldown").innerText="‚è≥ Cooldown: Ready";
          updateUI();
        }
      },50);
    }

    // Keybind produce: Q, W, ArrowUp, ArrowLeft
    // Sell: E, S, ArrowDown, ArrowRight
    window.addEventListener("keydown",(e)=>{
      let k= e.key.toLowerCase();
      keyDownSet.add(k);
      keyDownSet.add(e.code);
      refreshMassBuyUI();
      if((["q","w"].includes(k)||["ArrowUp","ArrowLeft"].includes(e.code)) && !isAnyKeyPressed(["e","s"],["ArrowDown","ArrowRight"])){
        if(!producing){
          doProduce();
          sparkleButton(document.getElementById("produce"));
        }
      }
      if((["e","s"].includes(k)||["ArrowDown","ArrowRight"].includes(e.code)) && !isAnyKeyPressed(["q","w"],["ArrowUp","ArrowLeft"])){
        if(!selling && sellingUnlocked && backpackUsed>0){
          doSellAll();
          sparkleButton(document.getElementById("sellAll"));
        }
      }
    });
    window.addEventListener("keyup",(e)=>{
      keyDownSet.delete(e.key.toLowerCase());
      keyDownSet.delete(e.code);
      refreshMassBuyUI();
    });
    function isAnyKeyPressed(keyArr, codeArr){
      for(let k of keyArr) if(keyDownSet.has(k)) return true;
      for(let c of codeArr) if(keyDownSet.has(c)) return true;
      return false;
    }

    /* ===========================
       14. SELL ALL
    ============================ */
    let selling= false, sellingInterval=null;
    document.getElementById("sellAll").addEventListener("click",()=>{
      if(!selling && sellingUnlocked && backpackUsed>0){
        doSellAll();
        sparkleButton(document.getElementById("sellAll"));
      }
    });
    function doSellAll(){
      selling=true;
      clampTimes();
      let cd= sellingTime;
      let amt= backpackUsed;
      if(sellingInterval) clearInterval(sellingInterval);
      sellingInterval= setInterval(()=>{
        cd-=50;
        if(cd<0) cd=0;
        document.getElementById("sellCooldown").innerText=`üïí Selling Timer: ${formatCooldown(cd)}`;
        if(cd<=0){
          clearInterval(sellingInterval);
          let f= factories[factoryIndex];
          let p= f.products[currentProductIndex];
          let val= p.base* multiplier* prestigeMulti;
          let totalVal= val* amt;
          money+= totalVal;
          totalEarned+= totalVal;
          backpackUsed=0;
          showNotification(`Sold ${amt} items for $${formatNumber(totalVal)}`);
          selling=false;
          document.getElementById("sellCooldown").innerText="üïí Selling Timer: Ready";
          updateUI();
        }
      },50);
    }

    /* ===========================
       15. AUTO PRODUCE & SELL
    ============================ */
    setInterval(()=>{
      if(autoProduce && !producing && sellingUnlocked && backpackUsed< backpackCapacity){
        doProduce();
      }
      if(autoSell && !selling && sellingUnlocked && backpackUsed>0){
        doSellAll();
      }
    },200);

    /* ===========================
       16. PRESTIGE MENU
    ============================ */
    const prestigeMenu= document.getElementById("prestigeMenu");
    document.getElementById("prestige").addEventListener("click",()=>{
      prestigeMenu.style.display="block";
      updatePrestigeMenu();
    });
    document.getElementById("closePrestige").addEventListener("click",()=>{
      prestigeMenu.style.display="none";
    });
    function updatePrestigeMenu(){
      document.getElementById("livePP").innerText= formatNumber(prestigePoints);
      let pot=0, localEarn= totalEarned, cost= nextPPcost;
      while(localEarn>= cost){
        pot++;
        localEarn-= cost;
        cost*=1.2;
        if(cost<1) cost=1;
      }
      document.getElementById("earnedPP").innerText= formatNumber(pot);

      const f= factories[factoryIndex];
      document.getElementById("baseValue").innerText= formatNumber(f.products[0].base);
      document.getElementById("bestValue").innerText= formatNumber(f.products[f.products.length-1].base);
      document.getElementById("currentFactory").innerText= f.name;
      const nextF= factories[factoryIndex+1]? factories[factoryIndex+1].name:"None";
      document.getElementById("nextFactory").innerText= nextF;
      renderPrestigeUpgrades();

      let reqList=[1e3,5e7,5e10,5e13,5e16,5e19,1e22,1e25,1e28,1e31,1e34,1e37,1e40,1e43,1e46,1e49,1e52,1e55,1e58,1e61];
      let needed= reqList[prestigeCount]||1e99;
      const cbtn= document.getElementById("confirmPrestige");
      if(money<needed){
        cbtn.disabled= true;
        cbtn.innerText=`Need $${formatNumber(needed)}`;
      } else{
        cbtn.disabled= false;
        cbtn.innerText="‚úî Confirm";
      }
    }
    function renderPrestigeUpgrades(){
      const cont= document.getElementById("prestigeUpgradesMenu");
      cont.innerHTML= "<h3>Permanent Prestige Upgrades</h3>";
      prestigeUpgrades.forEach((pu,i)=>{
        const btn= document.createElement("button");
        btn.className="button upgrade";
        let maxTxt= (pu.max>=999)?"":`/${pu.max}`;
        if(pu.purchased>= pu.max){
          btn.innerText= `${pu.name} (MAX)`;
          btn.disabled= true;
        } else {
          btn.innerText= `${pu.name} (Cost: $${formatNumber(pu.cost)} ‚Ñó) [${pu.purchased}${maxTxt}]`;
        }
        btn.title= pu.description;
        btn.onclick= ()=>{
          if(prestigePoints>= pu.cost && pu.purchased< pu.max){
            prestigePoints-= pu.cost;
            pu.purchased++;
            applyPrestigeUpgradeEffect(pu);
            pu.cost= Math.round(pu.cost*1.6);
            sparkleButton(btn);
            updateUI();
          }
        };
        cont.appendChild(btn);
      });
    }
    function applyPrestigeUpgradeEffect(pu){
      if(pu.name.includes("Divine Efficiency")){
        prestigeMulti*= pu.effect;
      } else if(pu.name.includes("Temporal Mastery")){
        cooldownTime*= pu.effect;
        clampTimes();
      } else if(pu.name.includes("Eternal Workshop")){
        factories.forEach(f=>{
          f.products.forEach(pr=>{
            pr.base= Math.round(pr.base* pu.effect);
          });
        });
      } else if(pu.name.includes("Auto Tycoon")){
        if(pu.purchased===1){
          autoProduce= true;
          showNotification("Stage 1 Unlocked: Auto Production");
        } else if(pu.purchased===2){
          autoSell= true;
          showNotification("Stage 2 Unlocked: ???");
        }
      } else if(pu.name.includes("Prestige Pure Multi")){
        prestigeMulti*= pu.effect;
      } else if(pu.name.includes("VIP Client Order")){
        vipChance+= pu.effect;
        if(vipChance>0.3) vipChance=0.3;
        vipMultiplier*=1.05;
      } else if(pu.name.includes("Selling Speed Mastery")){
        sellingTime*= pu.effect;
        clampTimes();
      }
    }
    document.getElementById("confirmPrestige").addEventListener("click",()=>{
      let reqList=[1e3,5e7,5e10,5e13,5e16,5e19,1e22,1e25,1e28,1e31,1e34,1e37,1e40,1e43,1e46,1e49,1e52,1e55,1e58,1e61];
      let needed= reqList[prestigeCount]||1e99;
      if(money>= needed){
        let localEarn= totalEarned;
        let c=0;
        let cost= nextPPcost;
        while(localEarn>= cost){
          c++;
          localEarn-= cost;
          cost*=1.15;
          if(cost<1) cost=1;
        }
        prestigePoints+= c;
        nextPPcost= cost;
        prestigeCount++;
        // reset main
        money=0;
        multiplier=1;
        cooldownTime=5000;
        currentProductIndex=0;
        totalProductsProduced=0;
        challengeBonusApplied=false;
        productBatch=1;
        if(factoryIndex< factories.length-1) factoryIndex++;

        upgrades=[
          { name:"Quality Increase", cost:25, effect:1.5, description:"Production multiplier +50%.", purchased:0 },
          { name:"‚öôÔ∏è Speedy Assembly", cost:50, effect:0.9, description:"Cooldown -10%.", purchased:0 },
          { name:"Product Upgrade", cost:250, effect:"upgradeProduct", description:"Upgrade product tier.", purchased:0 },
          { name:"üè≠ Factory Expansion", cost:200, effect:0.95, description:"Cooldown -5%.", purchased:0 },
          { name:"üì¶ Batch Production", cost:400, effect:"increaseBatch", description:"Batch size +1.", purchased:0 }
        ];
        employees=[
          {
            name:"üë∑ Worker #1",
            cost:75,
            rate:1,
            quantity:0,
            description:"Generates $1/sec + ?",
            purchased:0
          },
          {
            name:"üë®‚Äçüîß Worker #2",
            cost:500,
            rate:5,
            quantity:0,
            description:"Generates $5/sec + ?",
            purchased:0
          },
          {
            name:"üì¶ Porter #3",
            cost:1500,
            rate:0,
            quantity:0,
            description:"Slowly increases backpack capacity? ???",
            purchased:0
          }
        ];
        employeeTraining={
          unlocked:false,
          cost:200,
          effect:1.2,
          purchased:false,
          description:"All employees +20% production."
        };
        if(prestigeCount>0) sellingUnlocked= true;
        if(prestigeCount<2) autoSell= false;
        backpackCapacity=10;
        backpackUsed=0;
        backpackIndex=0;
        backpackData=[];
        for(let i=1;i<=30;i++){
          backpackData.push({
            name:`Backpack #${i}`,
            cost: Math.round(100*Math.pow(2.5,i)),
            effect: 10*i
          });
        }
        backpackData.push({name:"A Hole", cost:1e8, effect:1000});
        backpackData.push({name:"A Bigger Hole", cost:5e9, effect:5000});
        sellMultiIndex=0;
        sellMultiCost=1000;
        sellingUpgrades=[
          {
            name:"Faster Sell",
            cost:3000,
            effect:0.9,
            desc:"Selling time -10% (cost doubles each purchase).",
            purchased:0
          }
        ];
        showNotification(`Prestige #${prestigeCount}! You gained ${c} new PP.`);
        if(prestigeCount===1){
          document.getElementById("sellExplain").style.display="block";
        }
        updateUI();
      }
      prestigeMenu.style.display="none";
    });

    // close sellExplain
    document.getElementById("closeSellExplain").addEventListener("click",()=>{
      document.getElementById("sellExplain").style.display="none";
    });

    /* ===========================
       17. STATS MENU
    ============================ */
    const statsMenu= document.getElementById("statsMenu");
    document.getElementById("statsBtn").addEventListener("click",()=>{
      renderStats();
      statsMenu.style.display="block";
    });
    document.getElementById("closeStats").addEventListener("click",()=>{
      statsMenu.style.display="none";
    });
    function renderStats(){
      const c= document.getElementById("statsContent");
      let s=`
        <p><strong>Total Earned:</strong> $${formatNumber(totalEarned)}</p>
        <p><strong>Max Money Held:</strong> $${formatNumber(maxMoneyHeld)}</p>
        <p><strong>Total Products Produced:</strong> ${totalProductsProduced}</p>
        <p><strong>Cooldown Time:</strong> ${formatCooldown(cooldownTime)}</p>
        <p><strong>VIP Chance:</strong> ${(vipChance*100).toFixed(2)}%</p>
        <p><strong>VIP Multiplier:</strong> x${vipMultiplier.toFixed(2)}</p>
        <p><strong>Factory Index:</strong> ${factoryIndex+1} / ${factories.length}</p>
        <p><strong>Product Batch Size:</strong> ${productBatch}</p>
        <p><strong>Multiplier (Normal):</strong> x${formatNumber(multiplier)}</p>
        <p><strong>Multiplier (Prestige):</strong> x${formatNumber(prestigeMulti)}</p>
        <p><strong>Prestige Count:</strong> ${prestigeCount}</p>
        <p><strong>Next PP Cost:</strong> ‚Ñó${formatNumber(nextPPcost)}</p>
      `;
      if(sellingUnlocked){
        s+= `<p><strong>Backpack Used/Cap:</strong> ${backpackUsed}/${backpackCapacity}</p>`;
        s+= `<p><strong>Auto Produce:</strong> ${autoProduce?"Yes":"No"}</p>`;
        s+= `<p><strong>Auto Sell:</strong> ${autoSell?"Yes":"No"}</p>`;
      }
      c.innerHTML= s;
    }

    /* ===========================
       18. SETTINGS & RESET
    ============================ */
    const settingsMenu= document.getElementById("settingsMenu");
    document.getElementById("settingsBtn").addEventListener("click",()=>{
      settingsMenu.style.display="block";
    });
    document.getElementById("closeSettings").addEventListener("click",()=>{
      settingsMenu.style.display="none";
    });
    const resetTimer= document.getElementById("resetTimer");
    document.getElementById("resetGame").addEventListener("click",()=>{
      if(!resetInProgress){
        resetInProgress= true;
        resetTimer.innerText= "Confirm to reset. Then you have 10s to undo, or it resets fully.";
        let confirmBtn= document.createElement("button");
        confirmBtn.className="button";
        confirmBtn.innerText="Confirm Reset";
        let undoBtn= document.createElement("button");
        undoBtn.className="button";
        undoBtn.innerText="Undo";
        settingsMenu.appendChild(confirmBtn);
        settingsMenu.appendChild(undoBtn);

        confirmBtn.onclick= ()=>{
          let cd=10;
          resetTimer.innerText=`Reset in ${cd}s. Press Undo to cancel.`;
          let interval= setInterval(()=>{
            cd--;
            resetTimer.innerText=`Reset in ${cd}s. Press Undo to cancel.`;
            if(cd<=0){
              clearInterval(interval);
              localStorage.clear();
              location.reload();
            }
          },1000);
          confirmBtn.remove();
        };
        undoBtn.onclick= ()=>{
          resetInProgress= false;
          resetTimer.innerText="";
          confirmBtn.remove();
          undoBtn.remove();
          showNotification("Reset canceled. Progress saving resumed.");
          saveGame();
        };
      }
    });

    /* ===========================
       19. INIT
    ============================ */
    function init(){
      if(prestigeCount>0) sellingUnlocked= true;
      if(offlineSec>0) updateUI(); // after offline calc
      else updateUI();
    }
    window.onload= init;

    // auto update every 10s
    setInterval(()=> updateUI(),10000);

  </script>
</body>
</html>
