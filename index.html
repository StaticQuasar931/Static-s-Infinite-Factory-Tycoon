<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static's Infinite Factory Tycoon – Updated</title>
  <style>
    /* ===========================
       GLOBAL STYLES
    ============================ */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
      transition: background 0.5s ease;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
      position: relative;
    }
    .button {
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      transition: background 0.3s;
      display: inline-block;
    }
    .button:hover {
      background-color: #0056b3;
    }
    /* For special gold upgrades */
    .gold-button {
      background-color: #FFD700 !important;
      color: #000 !important;
      font-weight: normal;
    }
    .money-line {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .cooldown {
      font-size: 14px;
      color: #bbb;
    }
    .upgrade-container,
    .employee-container,
    .selling-container {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .upgrade,
    .employee,
    .sell-upgrade {
      flex: 1 1 45%;
      margin: 5px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .upgrade:hover,
    .employee:hover,
    .sell-upgrade:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    /* Modal Menus (Prestige / Stats / Settings) */
    .modal-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      z-index: 1000;
      max-width: 80%;
      font-size: 14px;
    }
    .modal-menu h2 {
      margin-top: 0;
    }
    /* Notification for VIP or challenge messages */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 2000;
      max-width: 70%;
      font-size: 16px;
    }
    /* QR code bottom-left, let's keep 200x200 */
    .qr-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 200px;
      height: 200px;
      z-index: 1500;
    }
    .qr-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* Gray-out for disabled produce button if backpack is full */
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Notification for VIP/Challenge/etc. -->
  <div class="notification" id="notificationBox"></div>

  <div class="container">
    <!-- Money & Prestige in one line -->
    <p class="money-line">
      💰 Money: $<span id="money">0.00</span>
      | 🌟 Prestige Points: <span id="prestigePoints">0</span>
    </p>
    <p>🔄 Multiplier: x<span id="multiplier">1.00</span>
       | Prestige Multi: x<span id="prestigeMulti">1.00</span></p>

    <h2>🏭 Factory Production</h2>
    <p>🏭 Factory: <span id="factoryName"></span></p>
    <p>
      📦 Product: <span id="productName"></span>
      (<span id="prodUsed"></span>/<span id="prodCap"></span>)
      (Base: <span id="productBase">0</span>, Batch: <span id="productBatch">1</span>)
    </p>
    <button class="button" id="produce">🚀 Produce Product</button>
    <p class="cooldown" id="cooldown">⏳ Cooldown: Ready</p>

    <!-- Normal Upgrades -->
    <div class="upgrade-container">
      <h2 style="width:100%;">📈 Upgrades</h2>
      <div id="upgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Employees -->
    <div class="employee-container">
      <h2 style="width:100%;">👥 Employees</h2>
      <div id="employees" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Selling (hidden until prestigeCount>0) -->
    <div class="selling-container" id="sellingArea" style="display:none;">
      <h2 style="width:100%;">💼 Selling System</h2>
      <p>Backpack: <span id="backpackUsed">0</span> / <span id="backpackCapacity">0</span></p>
      <button class="button" id="sellOne">Sell 1</button>
      <button class="button" id="sellAll">Sell All</button>
      <p class="cooldown" id="sellCooldown">🕒 Selling Timer: Ready</p>

      <!-- Selling Upgrades -->
      <div id="sellingUpgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Buttons for Prestige, Stats, and Settings -->
    <div style="margin-top: 20px;">
      <button class="button" id="prestige">🔄 Prestige</button>
      <button class="button" id="statsBtn">📊 Stats</button>
      <button class="button" id="settingsBtn">⚙ Settings</button>
    </div>

    <!-- Credits -->
    <p style="margin-top: 30px;">
      Made By
      <a href="https://sites.google.com/view/staticquasar931" target="_blank" style="color: #00d1ff;">
        Static
      </a>
    </p>
  </div>

  <!-- QR Code bottom-left (200x200) -->
  <div class="qr-container">
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
      <img 
        src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png" 
        alt="Qr Code linking to Static's site" 
        title="Click to visit Static's site"
      />
    </a>
  </div>

  <!-- Prestige Menu -->
  <div class="modal-menu" id="prestigeMenu">
    <h2>🔄 Prestige Confirmation</h2>
    <p><strong>Warning:</strong> Prestiging resets money, multiplier, normal upgrades, employees, and your backpack progress.</p>
    <p>Your Prestige requirement grows each time (1K, 50M, 50B, ...). PP earned from total earned, but each new point costs more than the last.</p>
    <p>Current PP: <span id="livePP">0</span></p>
    <p>Potential New PP: <span id="earnedPP">0</span></p>
    <p>🏭 Current Factory: <span id="currentFactory"></span></p>
    <p>🏭 Next Factory: <span id="nextFactory"></span></p>
    <p>📦 Base Value: <span id="baseValue"></span></p>
    <p>📦 Best Value: <span id="bestValue"></span></p>
    <div id="prestigeUpgradesMenu"></div>

    <button class="button" id="confirmPrestige">✔ Confirm</button>
    <button class="button" id="closePrestige">❌ Cancel</button>
  </div>

  <!-- Stats Menu -->
  <div class="modal-menu" id="statsMenu">
    <h2>📊 Player Stats</h2>
    <div id="statsContent"></div>
    <button class="button" id="closeStats">❌ Close</button>
  </div>

  <!-- Settings Menu -->
  <div class="modal-menu" id="settingsMenu">
    <h2>⚙ Game Settings</h2>
    <p>Manage QoL options and progress resets here.</p>
    <h4>QoL Notes</h4>
    <ul style="text-align:left; max-width:400px; margin:auto;">
      <li><strong>Max Buy:</strong> Hold Shift or Space to purchase as many as you can afford.</li>
      <li><strong>Selling Unlocks at 1st Prestige.</strong></li>
      <li><strong>Auto Production & Auto Selling:</strong> Gained via a Prestige Upgrade (two stages).</li>
      <li><strong>Number Formats:</strong> Short scale up to 1e22, then scientific with 3 decimals.</li>
    </ul>

    <h4>Reset Progress</h4>
    <p>If you reset, all local data is cleared. We'll give you 10s to confirm or undo, or else it cancels by default.</p>
    <button class="button" id="resetGame">🚫 Reset Progress</button>
    <p id="resetTimer" style="color: #f55;"></p>

    <button class="button" id="closeSettings">❌ Close</button>
  </div>

  <script>
    "use strict";

    /* ============================
       1. NUMBER FORMATTING
    ============================ */
    function formatNumber(num) {
      if (num === 0) return "0.00";
      let abs = Math.abs(num);
      let sign = num < 0 ? "-" : "";

      if (abs >= 1e22) {
        return sign + abs.toExponential(3);
      }
      const scale = [
        { v: 1e3, l: "K" },
        { v: 1e6, l: "M" },
        { v: 1e9, l: "B" },
        { v: 1e12, l: "T" },
        { v: 1e15, l: "Q" },
        { v: 1e18, l: "Qi" },
        { v: 1e21, l: "Si" },
      ];
      for (let i = scale.length - 1; i >= 0; i--) {
        if (abs >= scale[i].v) {
          return sign + (abs / scale[i].v).toFixed(2) + " " + scale[i].l;
        }
      }
      return sign + abs.toFixed(2);
    }
    function formatCooldown(ms) {
      if (ms <= 0) return "0s";
      let sec = ms / 1000;
      if (sec >= 1) {
        // up to 2 decimals
        return sec.toFixed(2).replace(/\.00$/,"") + "s";
      }
      // more decimals for <1
      let s = sec.toFixed(4).replace(/0+$/,"");
      return s + "s";
    }

    /* ============================
       2. GAME STATE
    ============================ */
    let money = parseFloat(localStorage.getItem("money")) || 0;
    let totalEarned = parseFloat(localStorage.getItem("totalEarned")) || 0;
    let prestigePoints = parseInt(localStorage.getItem("prestigePoints")) || 0;
    let multiplier = parseFloat(localStorage.getItem("multiplier")) || 1;
    let prestigeMulti = parseFloat(localStorage.getItem("prestigeMulti")) || 1;
    let totalProductsProduced = parseInt(localStorage.getItem("totalProductsProduced")) || 0;
    let challengeBonusApplied = localStorage.getItem("challengeBonusApplied") === "true";
    let productBatch = parseInt(localStorage.getItem("productBatch")) || 1;

    let factoryIndex = parseInt(localStorage.getItem("factoryIndex")) || 0;
    let currentProductIndex = parseInt(localStorage.getItem("currentProductIndex")) || 0;
    let producing = false;
    const baseCooldownTime = 5000;
    let cooldownTime = parseFloat(localStorage.getItem("cooldownTime")) || baseCooldownTime;

    let maxMoneyHeld = parseFloat(localStorage.getItem("maxMoneyHeld")) || 0;
    let vipChance = parseFloat(localStorage.getItem("vipChance")) || 0.05;
    let vipMultiplier = parseFloat(localStorage.getItem("vipMultiplier")) || 20;
    let nextPPcost = parseFloat(localStorage.getItem("nextPPcost")) || 1000;
    let prestigeCount = parseInt(localStorage.getItem("prestigeCount")) || 0;

    const prestigeRequirements = [
      1e3, 5e7, 5e10, 5e13, 5e16, 5e19, 1e22, 1e25,
      1e28, 1e31, 1e34, 1e37, 1e40, 1e43, 1e46, 1e49,
      1e52, 1e55, 1e58, 1e61 // up to 20
    ];

    // SELLING
    let sellingUnlocked = (prestigeCount > 0);
    let backpackCapacity = parseInt(localStorage.getItem("backpackCapacity")) || 10;
    let backpackUsed = parseInt(localStorage.getItem("backpackUsed")) || 0;
    let sellingTime = 3000;
    let selling = false;
    let autoProduce = false;
    let autoSell = false;

    /* FACTORIES */
    const factories = [
      {
        name: "🧸 Children's Toys Factory",
        bg: "linear-gradient(to right, #ff9a9e, #fad0c4)",
        products: [
          { name: "Wooden Blocks", base: 10 },
          { name: "Toy Cars", base: 15 },
          { name: "Stuffed Animals", base: 20 },
          { name: "Puzzle Games", base: 25 },
          { name: "Action Figures", base: 30 },
          { name: "Dollhouses", base: 35 },
          { name: "Remote Control Cars", base: 40 },
          { name: "Educational Kits", base: 45 },
          { name: "Model Trains", base: 50 },
          { name: "Custom Playsets", base: 60 }
        ]
      },
      {
        name: "🍰 Sweet Treats Bakery",
        bg: "linear-gradient(to right, #fbc2eb, #a6c1ee)",
        products: [
          { name: "Cupcakes", base: 12 },
          { name: "Cookies", base: 18 },
          { name: "Brownies", base: 24 },
          { name: "Donuts", base: 30 },
          { name: "Muffins", base: 36 },
          { name: "Pastries", base: 42 },
          { name: "Cakes", base: 50 },
          { name: "Macarons", base: 58 },
          { name: "Eclairs", base: 66 },
          { name: "Gourmet Pies", base: 75 }
        ]
      },
      {
        name: "🎨 Artisan Crafts Workshop",
        bg: "linear-gradient(to right, #a1c4fd, #c2e9fb)",
        products: [
          { name: "Handmade Cards", base: 14 },
          { name: "Ceramic Mugs", base: 20 },
          { name: "Knitted Scarves", base: 26 },
          { name: "Wooden Toys", base: 32 },
          { name: "Painted Vases", base: 38 },
          { name: "Handcrafted Jewelry", base: 44 },
          { name: "Embroidered Pillows", base: 50 },
          { name: "Custom Furniture", base: 58 },
          { name: "Vintage Clocks", base: 66 },
          { name: "Bespoke Art Pieces", base: 75 }
        ]
      },
      {
        name: "📱 Tech Gadget Studio",
        bg: "linear-gradient(to right, #a18cd1, #fbc2eb)",
        products: [
          { name: "Smartphone Cases", base: 16 },
          { name: "Wireless Earbuds", base: 22 },
          { name: "Portable Chargers", base: 28 },
          { name: "Bluetooth Speakers", base: 34 },
          { name: "Smartwatches", base: 40 },
          { name: "Tablet Accessories", base: 46 },
          { name: "VR Headsets", base: 52 },
          { name: "Drone Kits", base: 60 },
          { name: "Gaming Controllers", base: 68 },
          { name: "Advanced Gadgets", base: 78 }
        ]
      },
      {
        name: "💎 Luxury Gift Atelier",
        bg: "linear-gradient(to right, #ffecd2, #fcb69f)",
        products: [
          { name: "Artisanal Chocolates", base: 18 },
          { name: "Designer Scarves", base: 26 },
          { name: "Luxury Candles", base: 34 },
          { name: "Fine Wines", base: 42 },
          { name: "Handcrafted Jewelry", base: 50 },
          { name: "Exclusive Perfumes", base: 58 },
          { name: "Gourmet Baskets", base: 66 },
          { name: "Limited Edition Watches", base: 74 },
          { name: "Premium Leather Goods", base: 82 },
          { name: "Custom Masterpieces", base: 90 }
        ]
      },
      {
        name: "🔞 Adult Toys Factory",
        bg: "linear-gradient(to right, #4f0000, #8b0000)",
        products: [
          { name: "Basic Toys", base: 200 },
          { name: "Novelty Items", base: 500 },
          { name: "Special Editions", base: 800 },
          { name: "Themed Sets", base: 1200 },
          { name: "Remote-Controlled", base: 1800 },
          { name: "Luxury Models", base: 2500 },
          { name: "Smart Devices", base: 4000 },
          { name: "Premium Kits", base: 6000 },
          { name: "Custom Orders", base: 10000 },
          { name: "Futuristic Concepts", base: 20000 }
        ]
      }
    ];

    /* UPGRADES & EMPLOYEES */
    let upgrades = JSON.parse(localStorage.getItem("upgrades")) || [
      { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
      { name: "⚙️ Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
      { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product to next tier.", purchased: 0 },
      { name: "🏭 Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
      { name: "📦 Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
    ];

    let employees = JSON.parse(localStorage.getItem("employees")) || [
      {
        name: "👷 Efficient Operator",
        cost: 75,
        rate: 1,
        quantity: 0,
        description: "Generates $1/sec. (Selling perks hidden if locked.)",
        purchased: 0
      },
      {
        name: "👨‍🔧 Skilled Worker",
        cost: 250,
        rate: 5,
        quantity: 0,
        description: "Generates $5/sec. (Backpack perks hidden if locked.)",
        purchased: 0
      },
      {
        name: "🛠️ Master Craftsman",
        cost: 1000,
        rate: 20,
        quantity: 0,
        description: "Generates $20/sec.",
        purchased: 0
      },
      {
        name: "🏆 Production Supervisor",
        cost: 4000,
        rate: 50,
        quantity: 0,
        description: "Generates $50/sec.",
        purchased: 0
      },
      {
        name: "💼 Operations Manager",
        cost: 7500,
        rate: 100,
        quantity: 0,
        description: "Generates $100/sec. (More synergy later).",
        purchased: 0
      }
    ];

    let employeeTraining = JSON.parse(localStorage.getItem("employeeTraining")) || {
      unlocked: false,
      cost: 150,
      effect: 1.2,
      purchased: false,
      description: "All employees +20% production."
    };

    // A curated set of permanent Prestige Upgrades
    let prestigeUpgrades = JSON.parse(localStorage.getItem("prestigeUpgrades")) || [
      {
        name: "Divine Efficiency ✨",
        cost: 5,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Temporal Mastery ⏳",
        cost: 10,
        effect: 0.95,
        description: "Cooldown -5%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Eternal Workshop 🏭",
        cost: 25,
        effect: 1.25,
        description: "Product base value +25%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Auto Tycoon (Stage)",
        cost: 10,
        effect: "autoStage",
        description: "Stage 1 => Auto Produce, Stage 2 => Auto Sell.",
        purchased: 0,
        max: 2
      },
      {
        name: "Prestige Pure Multi",
        cost: 1,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "VIP Client Order",
        cost: 30,
        effect: 0.02,
        description: "VIP chance +2% (capped @30%), VIP multiplier +5%.",
        purchased: 0,
        max: 500
      }
    ];

    /* SELLING UPGRADES – 30 Named Backpacks + indefinite “Hole” expansions */
    let sellingUpgrades = JSON.parse(localStorage.getItem("sellingUpgrades")) || generateSellingUpgrades();
    function generateSellingUpgrades() {
      const arr = [];
      // 30 distinct upgrades
      for (let i=1;i<=30;i++) {
        arr.push({
          name: `Backpack #${i}`,
          cost: 100 * Math.pow(3, i),  // scaling cost
          effect: 10 * i,
          desc: `+${10*i} capacity`,
          purchased: 0,
          gold: (i%10===0) // every 10th backpack is gold
        });
      }
      // Then indefinite "Hole" expansions
      arr.push({
        name: "A Hole",
        cost: 1e9,
        effect: 5000,
        desc: "You found a hole that can store +5000 items",
        purchased: 0,
        gold: false,
        infinite: true
      });
      arr.push({
        name: "A Bigger Hole",
        cost: 5e9,
        effect: 25000,
        desc: "A bigger hole for +25K capacity",
        purchased: 0,
        gold: true,
        infinite: true
      });
      return arr;
    }

    /* ============================
       3. SAVING & BACKGROUND
    ============================ */
    let resetInProgress= false; // track if we are in the 10s reset window
    function saveGame() {
      if (resetInProgress) return;

      localStorage.setItem("money", money);
      localStorage.setItem("totalEarned", totalEarned);
      localStorage.setItem("prestigePoints", prestigePoints);
      localStorage.setItem("multiplier", multiplier);
      localStorage.setItem("prestigeMulti", prestigeMulti);
      localStorage.setItem("cooldownTime", cooldownTime);
      localStorage.setItem("totalProductsProduced", totalProductsProduced);
      localStorage.setItem("challengeBonusApplied", challengeBonusApplied);
      localStorage.setItem("productBatch", productBatch);
      localStorage.setItem("factoryIndex", factoryIndex);
      localStorage.setItem("currentProductIndex", currentProductIndex);
      localStorage.setItem("vipChance", vipChance);
      localStorage.setItem("vipMultiplier", vipMultiplier);
      localStorage.setItem("maxMoneyHeld", maxMoneyHeld);
      localStorage.setItem("nextPPcost", nextPPcost);
      localStorage.setItem("prestigeCount", prestigeCount);

      localStorage.setItem("upgrades", JSON.stringify(upgrades));
      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("employeeTraining", JSON.stringify(employeeTraining));
      localStorage.setItem("prestigeUpgrades", JSON.stringify(prestigeUpgrades));

      localStorage.setItem("sellingUpgrades", JSON.stringify(sellingUpgrades));
      localStorage.setItem("backpackCapacity", backpackCapacity);
      localStorage.setItem("backpackUsed", backpackUsed);
    }
    function updateBackground() {
      document.body.style.background = factories[factoryIndex].bg;
    }

    /* ============================
       4. NOTIFICATIONS
    ============================ */
    function showNotification(msg) {
      const box = document.getElementById("notificationBox");
      box.innerText= msg;
      box.style.display= "block";
      setTimeout(()=>{ box.style.display= "none"; },3000);
    }

    /* ============================
       SHIFT/SPACE DETECTION
    ============================ */
    let shiftDown= false, spaceDown= false;
    window.addEventListener("keydown",(e)=>{
      if (e.key==="Shift") shiftDown=true;
      if (e.code==="Space") spaceDown=true;
    });
    window.addEventListener("keyup",(e)=>{
      if (e.key==="Shift") shiftDown=false;
      if (e.code==="Space") spaceDown=false;
    });

    /* ============================
       5. MAIN UI UPDATE
    ============================ */
    function updateUI() {
      if (money>maxMoneyHeld) maxMoneyHeld= money;
      document.getElementById("money").innerText= formatNumber(money);
      document.getElementById("prestigePoints").innerText= prestigePoints;
      document.getElementById("multiplier").innerText= formatNumber(multiplier);
      document.getElementById("prestigeMulti").innerText= formatNumber(prestigeMulti);

      const fact= factories[factoryIndex];
      document.getElementById("factoryName").innerText= fact.name;
      const prod= fact.products[currentProductIndex];
      document.getElementById("productName").innerText= prod.name;
      document.getElementById("productBase").innerText= formatNumber(prod.base);
      document.getElementById("productBatch").innerText= productBatch;

      // show "used/cap" for the product line (some aesthetic detail)
      // if there's no "cap," we can assume the last product is your cap? 
      // We'll just say "Used: 1 / ???" or do something minimal. 
      // For demonstration, let's say "prodUsed" is always totalProductsProduced?
      // We'll do a fun aesthetic "Used: totalProductsProduced / ???"
      // This is purely decorative, not a real limit
      document.getElementById("prodUsed").innerText= totalProductsProduced;
      document.getElementById("prodCap").innerText= "∞";

      // Selling UI
      if (sellingUnlocked) {
        document.getElementById("sellingArea").style.display= "block";
        document.getElementById("backpackCapacity").innerText= backpackCapacity;
        document.getElementById("backpackUsed").innerText= backpackUsed;
        renderSellingUpgrades();
      } else {
        document.getElementById("sellingArea").style.display= "none";
      }

      const produceBtn= document.getElementById("produce");
      if (sellingUnlocked && backpackUsed>= backpackCapacity) {
        produceBtn.classList.add("disabled");
        produceBtn.disabled= true;
      } else {
        produceBtn.classList.remove("disabled");
        produceBtn.disabled= false;
      }

      renderUpgrades();
      renderEmployees();
      renderEmployeeTraining();
      updatePrestigeMenu();
      updateBackground();
      saveGame();
    }

    /* ============================
       6. UPGRADES
    ============================ */
    function renderUpgrades() {
      const container= document.getElementById("upgrades");
      container.innerHTML= "";
      upgrades.forEach((u,i)=>{
        const btn= document.createElement("button");
        btn.className= "button upgrade";

        if (u.name==="Product Upgrade") {
          btn.classList.add("gold-button");
          const f = factories[factoryIndex];
          const nextProd= f.products[currentProductIndex+1];
          if (!nextProd) {
            btn.innerText= `${u.name} (Max)`;
            btn.disabled= true;
          } else {
            btn.innerText= `${u.name} ($${formatNumber(u.cost)})`;
          }
        } else {
          btn.innerText= `${u.name} ($${formatNumber(u.cost)})`;
        }
        btn.title= u.description;
        btn.onclick= ()=> purchaseUpgrade(i);
        container.appendChild(btn);
      });
    }
    function purchaseUpgrade(i) {
      const upg= upgrades[i];
      if (shiftDown|| spaceDown) {
        let done=0;
        while (money>= upg.cost) {
          if (!attemptUpgradePurchase(upg)) break;
          done++;
        }
        if (done>0) updateUI();
      } else {
        attemptUpgradePurchase(upg);
        updateUI();
      }
    }
    function attemptUpgradePurchase(upg) {
      if (money>= upg.cost) {
        money-= upg.cost;
        upg.purchased++;
        if (upg.name==="⚙️ Speedy Assembly") {
          cooldownTime*= upg.effect;
        } else if (upg.name==="🏭 Factory Expansion") {
          cooldownTime*= upg.effect;
        } else if (upg.name==="Product Upgrade") {
          let f= factories[factoryIndex];
          if (currentProductIndex< f.products.length-1) {
            currentProductIndex++;
          }
        } else if (upg.effect==="increaseBatch") {
          productBatch++;
        } else {
          multiplier*= upg.effect;
        }
        if (upg.purchased<5) {
          upg.cost= Math.round(upg.cost*1.6);
        } else {
          upg.cost= Math.round(upg.cost*2.5);
        }
        return true;
      }
      return false;
    }

    /* ============================
       7. EMPLOYEES
    ============================ */
    function renderEmployees() {
      const container= document.getElementById("employees");
      container.innerHTML= "";
      employees.forEach((emp,i)=>{
        const btn= document.createElement("button");
        btn.className= "button employee";
        let desc= emp.description;
        if (!sellingUnlocked) {
          desc= desc.replace(/(selling|backpack)[^.]*/gi,"(locked until after Prestige)");
        }
        btn.title= desc;
        btn.innerText= `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        btn.onclick= ()=> purchaseEmployee(i);
        container.appendChild(btn);
      });
    }
    function purchaseEmployee(i) {
      const emp= employees[i];
      if (shiftDown|| spaceDown) {
        while (money>= emp.cost) {
          if (!attemptEmployeePurchase(emp)) break;
        }
        updateUI();
      } else {
        attemptEmployeePurchase(emp);
        updateUI();
      }
    }
    function attemptEmployeePurchase(emp) {
      if (money>= emp.cost) {
        money-= emp.cost;
        emp.quantity++;
        emp.purchased++;
        if (emp.purchased<5) {
          emp.cost= Math.round(emp.cost*1.5);
        } else {
          emp.cost= Math.round(emp.cost*2.2);
        }
        return true;
      }
      return false;
    }
    function renderEmployeeTraining() {
      if (employeeTraining.unlocked && !employeeTraining.purchased) {
        const container= document.getElementById("upgrades");
        const btn= document.createElement("button");
        btn.className= "button upgrade";
        btn.innerText= `🏋️ Employee Training ($${formatNumber(employeeTraining.cost)})`;
        btn.title= employeeTraining.description;
        btn.onclick= ()=> {
          if (money>= employeeTraining.cost) {
            money-= employeeTraining.cost;
            employeeTraining.purchased= true;
            employees.forEach(e=> { e.rate= Math.round(e.rate* employeeTraining.effect); });
            updateUI();
          }
        };
        container.appendChild(btn);
      }
    }

    // Passive income from employees
    setInterval(()=>{
      let totalProd= employees.reduce((sum,e)=> sum+(e.rate* e.quantity),0);
      if (totalProd>0) {
        let earned= totalProd* multiplier* prestigeMulti;
        money+= earned;
        totalEarned+= earned;
        updateUI();
      }
    },1000);

    /* ============================
       8. PRODUCE
    ============================ */
    const produceBtn= document.getElementById("produce");
    produceBtn.addEventListener("click", ()=>{
      if (!producing) manualProduce();
    });
    function manualProduce() {
      producing= true;
      let cd= cooldownTime;
      let interval= setInterval(()=>{
        cd-=100;
        if (cd>0) {
          document.getElementById("cooldown").innerText= `⏳ Cooldown: ${formatCooldown(cd)}`;
        } else {
          clearInterval(interval);
          // if selling locked => immediate money
          if (!sellingUnlocked) {
            let f= factories[factoryIndex];
            let p= f.products[currentProductIndex];
            let val= p.base* multiplier* prestigeMulti* productBatch;
            if (Math.random()< vipChance) {
              val*= vipMultiplier;
              showNotification(`VIP order! +${vipMultiplier}x bonus`);
            }
            money+= val;
            totalEarned+= val;
          } else {
            // add to backpack
            let canFit= backpackCapacity- backpackUsed;
            let toProd= productBatch;
            if (toProd> canFit) toProd= canFit;
            backpackUsed+= toProd;
          }
          totalProductsProduced++;
          checkChallenge();
          updateUI();
          producing= false;
          document.getElementById("cooldown").innerText= "⏳ Cooldown: Ready";
        }
      },100);
    }
    function checkChallenge() {
      if (!challengeBonusApplied && totalProductsProduced>=100) {
        multiplier*=1.1;
        challengeBonusApplied= true;
        showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
      }
    }

    /* ============================
       9. SELLING
    ============================ */
    const sellOne= document.getElementById("sellOne");
    const sellAll= document.getElementById("sellAll");
    let sellingInterval= null;

    sellOne.addEventListener("click", ()=> {
      if (!selling) sellNProducts(1);
    });
    sellAll.addEventListener("click", ()=> {
      if (!selling) sellNProducts(backpackUsed);
    });

    function sellNProducts(n) {
      if (backpackUsed<=0) return;
      selling= true;
      let amt= Math.min(n, backpackUsed);
      let cd= sellingTime;
      sellingInterval= setInterval(()=>{
        cd-=100;
        document.getElementById("sellCooldown").innerText= `🕒 Selling Timer: ${formatCooldown(cd)}`;
        if (cd<=0) {
          clearInterval(sellingInterval);
          // calc money
          let p= factories[factoryIndex].products[currentProductIndex];
          let valPer= p.base* multiplier* prestigeMulti;
          let totalVal= valPer* amt;
          money+= totalVal;
          totalEarned+= totalVal;
          backpackUsed-= amt;
          showNotification(`Sold ${amt} items for $${formatNumber(totalVal)}`);
          selling= false;
          document.getElementById("sellCooldown").innerText= "🕒 Selling Timer: Ready";
          updateUI();
        }
      },100);
    }

    // Auto produce/sell if unlocked
    setInterval(()=>{
      if (autoProduce && !producing && backpackUsed<backpackCapacity) {
        manualProduce();
      }
      if (autoSell && !selling && backpackUsed>0) {
        sellNProducts(backpackUsed);
      }
    },200);

    function renderSellingUpgrades() {
      const container= document.getElementById("sellingUpgrades");
      container.innerHTML= "";
      sellingUpgrades.forEach((su,i)=>{
        const btn= document.createElement("button");
        btn.className= "button sell-upgrade";
        if (su.gold) btn.classList.add("gold-button");
        btn.innerText= `${su.name} - $${formatNumber(su.cost)}`;
        btn.title= su.desc;
        btn.onclick= ()=> {
          if (shiftDown|| spaceDown) {
            while (money>= su.cost) {
              if (!attemptSellingUpgrade(su)) break;
            }
            updateUI();
          } else {
            attemptSellingUpgrade(su);
            updateUI();
          }
        };
        container.appendChild(btn);
      });
    }
    function attemptSellingUpgrade(su) {
      if (money>= su.cost) {
        money-= su.cost;
        su.purchased++;
        backpackCapacity+= su.effect;
        // cost scaling
        if (su.infinite) {
          // for infinite ones, always scale big
          su.cost= Math.round(su.cost* 2.5);
        } else {
          if (su.purchased<5) {
            su.cost= Math.round(su.cost*1.7);
          } else {
            su.cost= Math.round(su.cost*2.5);
          }
        }
        return true;
      }
      return false;
    }

    /* ============================
       10. PRESTIGE
    ============================ */
    document.getElementById("prestige").addEventListener("click", ()=>{
      document.getElementById("prestigeMenu").style.display="block";
      updatePrestigeMenu();
    });
    document.getElementById("closePrestige").addEventListener("click", ()=>{
      document.getElementById("prestigeMenu").style.display="none";
    });
    function updatePrestigeMenu() {
      document.getElementById("livePP").innerText= prestigePoints;
      let pot= 0;
      let localEarn= totalEarned;
      let tmp= nextPPcost;
      let count=0;
      while(localEarn>= tmp){
        count++;
        localEarn-= tmp;
        tmp*=1.2;
      }
      pot= count;
      document.getElementById("earnedPP").innerText= pot;

      let fact= factories[factoryIndex];
      document.getElementById("currentFactory").innerText= fact.name;
      let nextF= factories[factoryIndex+1]? factories[factoryIndex+1].name: "None";
      document.getElementById("nextFactory").innerText= nextF;
      document.getElementById("baseValue").innerText= formatNumber(fact.products[0].base);
      document.getElementById("bestValue").innerText= formatNumber(fact.products[fact.products.length-1].base);

      renderPrestigeUpgrades();
      let req= prestigeRequirements[prestigeCount]||1e99;
      const cbtn= document.getElementById("confirmPrestige");
      if (money<req) {
        cbtn.disabled= true;
        cbtn.innerText= `Need $${formatNumber(req)} On Hand`;
      } else {
        cbtn.disabled= false;
        cbtn.innerText= "✔ Confirm";
      }
    }
    function renderPrestigeUpgrades() {
      const cont= document.getElementById("prestigeUpgradesMenu");
      cont.innerHTML= "<h3>Prestige Upgrades (Permanent)</h3>";
      prestigeUpgrades.forEach((pupg)=>{
        const btn= document.createElement("button");
        btn.className= "button";
        let maxTxt= (pupg.max>=999? "" : `/${pupg.max}`);
        if (pupg.purchased>= pupg.max) {
          btn.innerText= `${pupg.name} (MAX)`;
          btn.disabled= true;
        } else {
          btn.innerText= `${pupg.name} (Cost: ${formatNumber(pupg.cost)} PP) [${pupg.purchased}${maxTxt}]`;
        }
        btn.title= pupg.description;
        btn.onclick= ()=>{
          if (prestigePoints>= pupg.cost && pupg.purchased< pupg.max) {
            prestigePoints-= pupg.cost;
            pupg.purchased++;
            applyPrestigeUpgradeEffect(pupg);
            pupg.cost= Math.round(pupg.cost*1.5);
            updateUI();
          }
        };
        cont.appendChild(btn);
      });
    }
    function applyPrestigeUpgradeEffect(pu) {
      if (pu.name.includes("Divine Efficiency")) {
        prestigeMulti*= pu.effect;
      } else if (pu.name.includes("Temporal Mastery")) {
        cooldownTime*= pu.effect;
      } else if (pu.name.includes("Eternal Workshop")) {
        factories.forEach(fac=>{
          fac.products.forEach(pr=>{
            pr.base= Math.round(pr.base* pu.effect);
          });
        });
      } else if (pu.name.includes("Auto Tycoon")) {
        // Stage 1 => autoProduce, Stage 2 => autoSell
        if (pu.purchased===1) {
          autoProduce= true; showNotification("Auto Production Unlocked!");
        } else if (pu.purchased===2) {
          autoSell= true; showNotification("Auto Selling Unlocked!");
        }
      } else if (pu.name.includes("Prestige Pure Multi")) {
        prestigeMulti*= pu.effect;
      } else if (pu.name.includes("VIP Client Order")) {
        vipChance+= pu.effect;
        if (vipChance>0.3) vipChance=0.3;
        vipMultiplier*=1.05;
      }
    }

    document.getElementById("confirmPrestige").addEventListener("click", ()=>{
      let req= prestigeRequirements[prestigeCount]||1e99;
      if (money>=req) {
        // compute how many PP
        let localEarn= totalEarned;
        let c=0; 
        let tmp= nextPPcost;
        while(localEarn>= tmp){
          c++;
          localEarn-= tmp;
          tmp*=1.2;
        }
        prestigePoints+= c;
        nextPPcost= tmp;

        prestigeCount++;
        // reset
        money=0;
        multiplier=1;
        cooldownTime= baseCooldownTime;
        currentProductIndex=0;
        totalProductsProduced=0;
        challengeBonusApplied=false;
        productBatch=1;

        if(factoryIndex<factories.length-1){
          factoryIndex++;
        }
        // keep prestigeMulti
        upgrades= [
          { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
          { name: "⚙️ Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
          { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product to next tier.", purchased: 0 },
          { name: "🏭 Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
          { name: "📦 Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
        ];
        employees= [
          {
            name: "👷 Efficient Operator",
            cost: 75,
            rate: 1,
            quantity: 0,
            description: "Generates $1/sec. (Selling perks hidden if locked.)",
            purchased: 0
          },
          {
            name: "👨‍🔧 Skilled Worker",
            cost: 250,
            rate: 5,
            quantity: 0,
            description: "Generates $5/sec. (Backpack perks hidden if locked.)",
            purchased: 0
          },
          {
            name: "🛠️ Master Craftsman",
            cost: 1000,
            rate: 20,
            quantity: 0,
            description: "Generates $20/sec.",
            purchased: 0
          },
          {
            name: "🏆 Production Supervisor",
            cost: 4000,
            rate: 50,
            quantity: 0,
            description: "Generates $50/sec.",
            purchased: 0
          },
          {
            name: "💼 Operations Manager",
            cost: 7500,
            rate: 100,
            quantity: 0,
            description: "Generates $100/sec. (More synergy later).",
            purchased: 0
          }
        ];
        employeeTraining= {
          unlocked: false,
          cost: 150,
          effect: 1.2,
          purchased: false,
          description: "All employees +20% production."
        };
        if (prestigeCount>0) sellingUnlocked= true;
        if (prestigeCount<2) autoSell= false;

        sellingUpgrades= generateSellingUpgrades();
        backpackCapacity=10;
        backpackUsed=0;

        showNotification(`Prestige #${prestigeCount}! You gained ${c} new PP.`);
        updateUI();
      }
      document.getElementById("prestigeMenu").style.display="none";
    });

    document.getElementById("closePrestige").addEventListener("click",()=>{
      document.getElementById("prestigeMenu").style.display="none";
    });

    /* ============================
       11. STATS MENU
    ============================ */
    document.getElementById("statsBtn").addEventListener("click",()=>{
      renderStats();
      document.getElementById("statsMenu").style.display="block";
    });
    document.getElementById("closeStats").addEventListener("click",()=>{
      document.getElementById("statsMenu").style.display="none";
    });
    function renderStats(){
      const c= document.getElementById("statsContent");
      c.innerHTML= `
      <p><strong>Total Earned:</strong> $${formatNumber(totalEarned)}</p>
      <p><strong>Max Money Held:</strong> $${formatNumber(maxMoneyHeld)}</p>
      <p><strong>Total Products Produced:</strong> ${totalProductsProduced}</p>
      <p><strong>Cooldown Time:</strong> ${formatCooldown(cooldownTime)}</p>
      <p><strong>VIP Chance:</strong> ${(vipChance*100).toFixed(2)}%</p>
      <p><strong>VIP Multiplier:</strong> x${vipMultiplier.toFixed(2)}</p>
      <p><strong>Factory Index:</strong> ${factoryIndex+1} / ${factories.length}</p>
      <p><strong>Product Batch Size:</strong> ${productBatch}</p>
      <p><strong>Multiplier (Normal):</strong> x${formatNumber(multiplier)}</p>
      <p><strong>Multiplier (Prestige):</strong> x${formatNumber(prestigeMulti)}</p>
      <p><strong>Prestige Count:</strong> ${prestigeCount} / 20</p>
      <p><strong>Next PP Cost (Current):</strong> $${formatNumber(nextPPcost)}</p>
      ${sellingUnlocked?`
      <p><strong>Backpack Used/Cap:</strong> ${backpackUsed}/${backpackCapacity}</p>
      <p><strong>Auto Produce:</strong> ${autoProduce?"Yes":"No"}</p>
      <p><strong>Auto Sell:</strong> ${autoSell?"Yes":"No"}</p>
      `:""}
      `;
    }

    /* ============================
       12. SETTINGS MENU
    ============================ */
    const settingsBtn= document.getElementById("settingsBtn");
    const settingsMenu= document.getElementById("settingsMenu");
    const closeSettings= document.getElementById("closeSettings");
    const resetGameBtn= document.getElementById("resetGame");
    const resetTimer= document.getElementById("resetTimer");

    let resetTimeout= null;
    let resetCountdown=10;

    settingsBtn.addEventListener("click",()=>{
      settingsMenu.style.display="block";
    });
    closeSettings.addEventListener("click",()=>{
      settingsMenu.style.display="none";
    });
    resetGameBtn.addEventListener("click",()=>{
      if(!resetInProgress){
        resetInProgress= true;
        resetCountdown=10;
        resetTimer.innerText= `Confirm reset within ${resetCountdown}s or it will be canceled.`;
        // show confirm & undo
        const confirmBtn= document.createElement("button");
        confirmBtn.className= "button";
        confirmBtn.innerText= "Confirm Reset";
        const undoBtn= document.createElement("button");
        undoBtn.className= "button";
        undoBtn.innerText= "Undo";
        confirmBtn.onclick= ()=>{
          // finalize
          clearInterval(resetTimeout);
          localStorage.clear();
          location.reload();
        };
        undoBtn.onclick= ()=>{
          resetInProgress= false;
          clearInterval(resetTimeout);
          resetTimer.innerText= "";
          confirmBtn.remove();
          undoBtn.remove();
          showNotification("Reset canceled. Saving resumed.");
          saveGame();
        };
        settingsMenu.appendChild(confirmBtn);
        settingsMenu.appendChild(undoBtn);

        resetTimeout= setInterval(()=>{
          resetCountdown--;
          resetTimer.innerText= `Confirm reset within ${resetCountdown}s or it will be canceled.`;
          if(resetCountdown<=0){
            // auto-cancel
            clearInterval(resetTimeout);
            resetInProgress= false;
            resetTimer.innerText= "";
            confirmBtn.remove();
            undoBtn.remove();
            showNotification("Reset canceled (timeout).");
            saveGame();
          }
        },1000);
      }
    });

    /* ============================
       INIT
    ============================ */
    window.onload= ()=>{
      if(prestigeCount>0) sellingUnlocked= true;
      updateUI();
    };
  </script>
</body>
</html>
