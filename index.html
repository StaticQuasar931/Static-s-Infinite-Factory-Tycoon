<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static's Infinite Factory Tycoon ‚Äì Updated</title>
  <style>
    /* GLOBAL */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
      transition: background 0.5s ease;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
      position: relative;
    }
    .button {
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      transition: background 0.3s;
      display: inline-block;
    }
    .button:hover {
      background-color: #0056b3;
    }
    /* Gold background for special upgrades */
    .gold-button {
      background-color: #FFD700 !important;
      color: #000 !important;
      font-weight: normal;
    }
    .money-line {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .cooldown {
      font-size: 14px;
      color: #bbb;
    }
    .upgrade-container,
    .employee-container,
    .selling-container {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .upgrade,
    .employee,
    .sell-upgrade {
      flex: 1 1 45%;
      margin: 5px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .upgrade:hover,
    .employee:hover,
    .sell-upgrade:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    /* Menus (Prestige / Stats / Settings) */
    .modal-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      z-index: 1000;
      max-width: 80%;
      font-size: 14px;
    }
    .modal-menu h2 {
      margin-top: 0;
    }
    /* Notification */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 2000;
      max-width: 70%;
      font-size: 16px;
    }
    /* QR code bottom-left, 200x200 */
    .qr-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 200px;
      height: 200px;
      z-index: 1500;
    }
    .qr-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* For produce button if backpack is full */
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Notification Div -->
  <div class="notification" id="notificationBox"></div>

  <div class="container">
    <p class="money-line">
      üí∞ Money: $<span id="money">0.00</span>
      | üåü Prestige Points: <span id="prestigePoints">0</span>
    </p>
    <p>üîÑ Multiplier: x<span id="multiplier">1.00</span>
       | Prestige Multi: x<span id="prestigeMulti">1.00</span></p>

    <h2>üè≠ Factory Production</h2>
    <p>üè≠ Factory: <span id="factoryName"></span></p>
    <p>
      üì¶ Product: <span id="productName"></span> 
      (Base: <span id="productBase">0</span>,
      Batch: <span id="productBatch">1</span>)
    </p>
    <button class="button" id="produce">üöÄ Produce Product</button>
    <p class="cooldown" id="cooldown">‚è≥ Cooldown: Ready</p>

    <!-- Upgrades -->
    <div class="upgrade-container">
      <h2 style="width:100%;">üìà Upgrades</h2>
      <div id="upgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Employees -->
    <div class="employee-container">
      <h2 style="width:100%;">üë• Employees</h2>
      <div id="employees" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Selling, hidden until prestigeCount > 0 -->
    <div class="selling-container" id="sellingArea" style="display:none;">
      <h2 style="width:100%;">üíº Selling System</h2>
      <p>Backpack Capacity: <span id="backpackCapacity">0</span> | <span id="backpackUsed">0</span> used</p>
      <button class="button" id="sellOne">Sell 1 Product</button>
      <button class="button" id="sellAll">Sell All</button>
      <p class="cooldown" id="sellCooldown">üïí Selling Timer: Ready</p>

      <!-- Selling Upgrades -->
      <div id="sellingUpgrades" style="width:100%; display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <!-- Buttons for Prestige, Stats, Settings -->
    <div style="margin-top: 20px;">
      <button class="button" id="prestige">üîÑ Prestige</button>
      <button class="button" id="statsBtn">üìä Stats</button>
      <button class="button" id="settingsBtn">‚öô Settings</button>
    </div>

    <p style="margin-top: 30px;">
      Made By <a href="https://sites.google.com/view/staticquasar931" target="_blank" style="color: #00d1ff;">Static</a>
    </p>
  </div>

  <!-- QR Code (200x200) -->
  <div class="qr-container">
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
      <img 
        src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png"
        alt="Qr Code linking to Static's site"
        title="Click to visit Static's site"
      />
    </a>
  </div>

  <!-- Prestige Menu -->
  <div class="modal-menu" id="prestigeMenu">
    <h2>üîÑ Prestige Confirmation</h2>
    <p><strong>Warning:</strong> Prestiging resets your money, multiplier, normal upgrades, employees, and backpack progress.</p>
    <p>The required on-hand money grows each Prestige (1K, 50M, 50B, 50T...).</p>
    <p>Your PP are earned from total earned, but each new point costs more than the last!</p>
    <p>Current Prestige Points: <span id="livePP">0</span></p>
    <p>Potential New PP: <span id="earnedPP">0</span></p>
    <p>üè≠ Current Factory: <span id="currentFactory"></span></p>
    <p>üè≠ Next Factory: <span id="nextFactory"></span></p>
    <p>üì¶ Base Value: <span id="baseValue"></span></p>
    <p>üì¶ Best Value: <span id="bestValue"></span></p>
    <div id="prestigeUpgradesMenu"></div>

    <button class="button" id="confirmPrestige">‚úî Confirm</button>
    <button class="button" id="closePrestige">‚ùå Cancel</button>
  </div>

  <!-- Stats Menu -->
  <div class="modal-menu" id="statsMenu">
    <h2>üìä Player Stats</h2>
    <div id="statsContent"></div>
    <button class="button" id="closeStats">‚ùå Close</button>
  </div>

  <!-- Settings Menu -->
  <div class="modal-menu" id="settingsMenu">
    <h2>‚öô Game Settings</h2>
    <p>In this menu, you can see QoL details, manage resets, etc.</p>
    <h4>Quality of Life Features</h4>
    <ul style="text-align:left; max-width:400px; margin:auto;">
      <li><strong>Max Buy:</strong> Hold Shift or Space when buying upgrades to buy as many as affordable.</li>
      <li><strong>Auto Production & Auto Selling:</strong> Prestige Upgrades to automate gameplay.</li>
      <li><strong>Number Formatting:</strong> Short scale up to 1e22, then 3-decimal scientific notation.</li>
      <li><strong>Selling Lock:</strong> You only unlock the new Selling system after your 1st Prestige.</li>
    </ul>

    <h4>Reset Progress</h4>
    <p>If you reset, you will lose <em>all saved data</em>. A 10s undo window is provided. No saving occurs during that time, so refreshing will restore old data.</p>
    <button class="button" id="resetGame">Reset Progress</button>
    <p id="resetTimer" style="color:#f88;"></p>
    
    <button class="button" id="closeSettings">‚ùå Close</button>
  </div>

  <script>
    "use strict";

    /* ================================
       1. NUMBER FORMATTING (Extended)
    ================================ */
    function formatNumber(num) {
      if (num === 0) return "0.00";
      const abs = Math.abs(num);
      const sign = num < 0 ? "-" : "";

      // If extremely large, scientific
      if (abs >= 1e22) {
        // Show 3 decimals
        return sign + abs.toExponential(3);
      }

      // Otherwise short scale
      const scale = [
        { v: 1e3, l: "K" },
        { v: 1e6, l: "M" },
        { v: 1e9, l: "B" },
        { v: 1e12, l: "T" },
        { v: 1e15, l: "Q" },
        { v: 1e18, l: "Qi" },
        { v: 1e21, l: "Si" },
      ];
      for (let i = scale.length - 1; i >= 0; i--) {
        if (abs >= scale[i].v) {
          return sign + (abs / scale[i].v).toFixed(2) + " " + scale[i].l;
        }
      }
      // If < 1000
      return sign + abs.toFixed(2);
    }

    function formatCooldown(ms) {
      // Convert ms => s
      let sec = ms / 1000;
      // If sec>1, show 2 decimals
      if (sec >= 1) return sec.toFixed(2) + "s";
      // else show minimal decimals
      if (sec <= 0) return "0s";
      // strip trailing zeros
      let str = sec.toFixed(5);
      while (str.includes(".") && (str.endsWith("0") || str.endsWith("."))) {
        str = str.slice(0, -1);
      }
      return str + "s";
    }

    /* =======================
       2. GAME STATE
    ========================== */
    let money = parseFloat(localStorage.getItem("money")) || 0;
    let totalEarned = parseFloat(localStorage.getItem("totalEarned")) || 0;
    let prestigePoints = parseInt(localStorage.getItem("prestigePoints")) || 0;
    let multiplier = parseFloat(localStorage.getItem("multiplier")) || 1;
    let prestigeMulti = parseFloat(localStorage.getItem("prestigeMulti")) || 1;
    let totalProductsProduced = parseInt(localStorage.getItem("totalProductsProduced")) || 0;
    let challengeBonusApplied = localStorage.getItem("challengeBonusApplied") === "true";
    let productBatch = parseInt(localStorage.getItem("productBatch")) || 1;

    let factoryIndex = parseInt(localStorage.getItem("factoryIndex")) || 0;
    let currentProductIndex = parseInt(localStorage.getItem("currentProductIndex")) || 0;
    let producing = false;
    const baseCooldownTime = 5000;
    let cooldownTime = parseFloat(localStorage.getItem("cooldownTime")) || baseCooldownTime;
    
    let maxMoneyHeld = parseFloat(localStorage.getItem("maxMoneyHeld")) || 0;
    let vipChance = parseFloat(localStorage.getItem("vipChance")) || 0.05;
    let vipMultiplier = parseFloat(localStorage.getItem("vipMultiplier")) || 20;
    let nextPPcost = parseFloat(localStorage.getItem("nextPPcost")) || 1000;
    let prestigeCount = parseInt(localStorage.getItem("prestigeCount")) || 0;

    // On-hand money requirement for each Prestige up to 20
    const prestigeRequirements = [
      1e3, 5e7, 5e10, 5e13, 5e16, 5e19, 1e22, 1e25,
      1e28, 1e31, 1e34, 1e37, 1e40, 1e43, 1e46, 1e49,
      1e52, 1e55, 1e58, 1e61
    ];

    /* SELLING */
    let sellingUnlocked = (prestigeCount > 0);
    let backpackCapacity = parseInt(localStorage.getItem("backpackCapacity")) || 10;
    let backpackUsed = parseInt(localStorage.getItem("backpackUsed")) || 0;
    let sellingTime = 3000; 
    let selling = false;
    let autoProduce = false; 
    let autoSell = false; 

    /* =======================
       FACTORIES
    ========================== */
    const factories = [
      {
        name: "üß∏ Children's Toys Factory",
        bg: "linear-gradient(to right, #ff9a9e, #fad0c4)",
        products: [
          { name: "Wooden Blocks", base: 10 },
          { name: "Toy Cars", base: 15 },
          { name: "Stuffed Animals", base: 20 },
          { name: "Puzzle Games", base: 25 },
          { name: "Action Figures", base: 30 },
          { name: "Dollhouses", base: 35 },
          { name: "Remote Control Cars", base: 40 },
          { name: "Educational Kits", base: 45 },
          { name: "Model Trains", base: 50 },
          { name: "Custom Playsets", base: 60 }
        ]
      },
      {
        name: "üç∞ Sweet Treats Bakery",
        bg: "linear-gradient(to right, #fbc2eb, #a6c1ee)",
        products: [
          { name: "Cupcakes", base: 12 },
          { name: "Cookies", base: 18 },
          { name: "Brownies", base: 24 },
          { name: "Donuts", base: 30 },
          { name: "Muffins", base: 36 },
          { name: "Pastries", base: 42 },
          { name: "Cakes", base: 50 },
          { name: "Macarons", base: 58 },
          { name: "Eclairs", base: 66 },
          { name: "Gourmet Pies", base: 75 }
        ]
      },
      {
        name: "üé® Artisan Crafts Workshop",
        bg: "linear-gradient(to right, #a1c4fd, #c2e9fb)",
        products: [
          { name: "Handmade Cards", base: 14 },
          { name: "Ceramic Mugs", base: 20 },
          { name: "Knitted Scarves", base: 26 },
          { name: "Wooden Toys", base: 32 },
          { name: "Painted Vases", base: 38 },
          { name: "Handcrafted Jewelry", base: 44 },
          { name: "Embroidered Pillows", base: 50 },
          { name: "Custom Furniture", base: 58 },
          { name: "Vintage Clocks", base: 66 },
          { name: "Bespoke Art Pieces", base: 75 }
        ]
      },
      {
        name: "üì± Tech Gadget Studio",
        bg: "linear-gradient(to right, #a18cd1, #fbc2eb)",
        products: [
          { name: "Smartphone Cases", base: 16 },
          { name: "Wireless Earbuds", base: 22 },
          { name: "Portable Chargers", base: 28 },
          { name: "Bluetooth Speakers", base: 34 },
          { name: "Smartwatches", base: 40 },
          { name: "Tablet Accessories", base: 46 },
          { name: "VR Headsets", base: 52 },
          { name: "Drone Kits", base: 60 },
          { name: "Gaming Controllers", base: 68 },
          { name: "Advanced Gadgets", base: 78 }
        ]
      },
      {
        name: "üíé Luxury Gift Atelier",
        bg: "linear-gradient(to right, #ffecd2, #fcb69f)",
        products: [
          { name: "Artisanal Chocolates", base: 18 },
          { name: "Designer Scarves", base: 26 },
          { name: "Luxury Candles", base: 34 },
          { name: "Fine Wines", base: 42 },
          { name: "Handcrafted Jewelry", base: 50 },
          { name: "Exclusive Perfumes", base: 58 },
          { name: "Gourmet Baskets", base: 66 },
          { name: "Limited Edition Watches", base: 74 },
          { name: "Premium Leather Goods", base: 82 },
          { name: "Custom Masterpieces", base: 90 }
        ]
      },
      {
        name: "üîû Adult Toys Factory",
        bg: "linear-gradient(to right, #4f0000, #8b0000)",
        products: [
          { name: "Basic Toys", base: 200 },
          { name: "Novelty Items", base: 500 },
          { name: "Special Editions", base: 800 },
          { name: "Themed Sets", base: 1200 },
          { name: "Remote-Controlled", base: 1800 },
          { name: "Luxury Models", base: 2500 },
          { name: "Smart Devices", base: 4000 },
          { name: "Premium Kits", base: 6000 },
          { name: "Custom Orders", base: 10000 },
          { name: "Futuristic Concepts", base: 20000 }
        ]
      }
    ];

    /* UPGRADES & EMPLOYEES */
    let upgrades = JSON.parse(localStorage.getItem("upgrades")) || [
      { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
      { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
      { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product tier.", purchased: 0 },
      { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
      { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
    ];

    let employees = JSON.parse(localStorage.getItem("employees")) || [
      {
        name: "üë∑ Efficient Operator",
        cost: 75,
        rate: 1,
        quantity: 0,
        description: "Generates $1/sec. (Some selling perks hidden until unlocked)",
        purchased: 0
      },
      {
        name: "üë®‚Äçüîß Skilled Worker",
        cost: 250,
        rate: 5,
        quantity: 0,
        description: "Generates $5/sec. (Some backpack perks hidden until unlocked)",
        purchased: 0
      },
      {
        name: "üõ†Ô∏è Master Craftsman",
        cost: 1000,
        rate: 20,
        quantity: 0,
        description: "Generates $20/sec.",
        purchased: 0
      },
      {
        name: "üèÜ Production Supervisor",
        cost: 4000,
        rate: 50,
        quantity: 0,
        description: "Generates $50/sec.",
        purchased: 0
      },
      {
        name: "üíº Operations Manager",
        cost: 7500,
        rate: 100,
        quantity: 0,
        description: "Generates $100/sec. (More synergy later)",
        purchased: 0
      }
    ];

    let employeeTraining = JSON.parse(localStorage.getItem("employeeTraining")) || {
      unlocked: false,
      cost: 150,
      effect: 1.2,
      purchased: false,
      description: "All employees +20% production."
    };

    // Simplified Prestige Upgrades (no duplicates)
    let prestigeUpgrades = JSON.parse(localStorage.getItem("prestigeUpgrades")) || [
      {
        name: "Divine Efficiency ‚ú®",
        cost: 5,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999 // effectively infinite
      },
      {
        name: "Temporal Mastery ‚è≥",
        cost: 10,
        effect: 0.95,
        description: "Cooldown -5%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Eternal Workshop üè≠",
        cost: 25,
        effect: 1.25,
        description: "Product base value +25%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Auto Tycoon (Stage)",
        cost: 10,
        effect: "autoStage",
        description: "Stage 1: Auto Produce, Stage 2: Auto Sell.",
        purchased: 0,
        max: 2
      },
      {
        name: "Prestige Pure Multi",
        cost: 1,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "VIP Client Order",
        cost: 30,
        effect: 0.02,
        description: "VIP chance +2% (capped 30%), VIP multiplier +5%.",
        purchased: 0,
        max: 500
      }
    ];

    /* SELLING UPGRADES (with a "Golden Backpack" too) */
    let sellingUpgrades = JSON.parse(localStorage.getItem("sellingUpgrades")) || [
      { name: "Bigger Backpack", cost: 100, effect: 10, desc: "+10 capacity", purchased: 0, gold: false },
      { name: "Carry Suitcase", cost: 1000, effect: 25, desc: "+25 capacity", purchased: 0, gold: false },
      { name: "Storage Container", cost: 20000, effect: 100, desc: "+100 capacity", purchased: 0, gold: false },
      { name: "Abandoned School", cost: 1e6, effect: 1000, desc: "+1000 capacity", purchased: 0, gold: false },
      // A new "Golden Backpack" upgrade
      { name: "Golden Backpack", cost: 5e7, effect: 5000, desc: "A golden backpack with +5000 capacity", purchased: 0, gold: true }
    ];

    /* =======================
       SAVE
    ========================== */
    function saveGame() {
      if (resetInProgress) return; // no saving if in the 10s reset window

      localStorage.setItem("money", money);
      localStorage.setItem("totalEarned", totalEarned);
      localStorage.setItem("prestigePoints", prestigePoints);
      localStorage.setItem("multiplier", multiplier);
      localStorage.setItem("prestigeMulti", prestigeMulti);
      localStorage.setItem("cooldownTime", cooldownTime);
      localStorage.setItem("totalProductsProduced", totalProductsProduced);
      localStorage.setItem("challengeBonusApplied", challengeBonusApplied);
      localStorage.setItem("productBatch", productBatch);
      localStorage.setItem("factoryIndex", factoryIndex);
      localStorage.setItem("currentProductIndex", currentProductIndex);
      localStorage.setItem("vipChance", vipChance);
      localStorage.setItem("vipMultiplier", vipMultiplier);
      localStorage.setItem("maxMoneyHeld", maxMoneyHeld);
      localStorage.setItem("nextPPcost", nextPPcost);
      localStorage.setItem("prestigeCount", prestigeCount);
      localStorage.setItem("sellingUnlocked", sellingUnlocked);

      localStorage.setItem("upgrades", JSON.stringify(upgrades));
      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("employeeTraining", JSON.stringify(employeeTraining));
      localStorage.setItem("prestigeUpgrades", JSON.stringify(prestigeUpgrades));

      localStorage.setItem("sellingUpgrades", JSON.stringify(sellingUpgrades));
      localStorage.setItem("backpackCapacity", backpackCapacity);
      localStorage.setItem("backpackUsed", backpackUsed);
    }

    function showNotification(msg) {
      const box = document.getElementById("notificationBox");
      box.innerText = msg;
      box.style.display = "block";
      setTimeout(() => {
        box.style.display = "none";
      }, 3000);
    }

    /* =======================
       UPDATE UI
    ========================== */
    function updateUI() {
      if (money > maxMoneyHeld) {
        maxMoneyHeld = money;
      }
      document.getElementById("money").innerText = formatNumber(money);
      document.getElementById("prestigePoints").innerText = prestigePoints;
      document.getElementById("multiplier").innerText = formatNumber(multiplier);
      document.getElementById("prestigeMulti").innerText = formatNumber(prestigeMulti);

      const fact = factories[factoryIndex];
      document.getElementById("factoryName").innerText = fact.name;
      const product = fact.products[currentProductIndex];
      document.getElementById("productName").innerText = product.name;
      document.getElementById("productBase").innerText = formatNumber(product.base);
      document.getElementById("productBatch").innerText = productBatch;

      // Selling unlocked?
      if (sellingUnlocked) {
        document.getElementById("sellingArea").style.display = "block";
        document.getElementById("backpackCapacity").innerText = backpackCapacity;
        document.getElementById("backpackUsed").innerText = backpackUsed;
        renderSellingUpgrades();
      } else {
        document.getElementById("sellingArea").style.display = "none";
      }

      // If backpack is full, disable produce
      const produceBtn = document.getElementById("produce");
      if (backpackUsed >= backpackCapacity && sellingUnlocked) {
        produceBtn.classList.add("disabled");
        produceBtn.disabled = true;
      } else {
        produceBtn.classList.remove("disabled");
        produceBtn.disabled = false;
      }

      renderUpgrades();
      renderEmployees();
      renderEmployeeTraining();
      updatePrestigeMenu();
      updateBackground();
      saveGame();
    }

    function updateBackground() {
      document.body.style.background = factories[factoryIndex].bg;
    }

    /* =======================
       SHIFT/SPACE DETECTION
    ========================== */
    let shiftDown = false;
    let spaceDown = false;
    window.addEventListener("keydown", (e) => {
      if (e.key === "Shift") shiftDown = true;
      if (e.code === "Space") spaceDown = true;
    });
    window.addEventListener("keyup", (e) => {
      if (e.key === "Shift") shiftDown = false;
      if (e.code === "Space") spaceDown = false;
    });

    /* =======================
       UPGRADES
    ========================== */
    function renderUpgrades() {
      const container = document.getElementById("upgrades");
      container.innerHTML = "";
      upgrades.forEach((upg, index) => {
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        if (upg.name === "Product Upgrade") {
          btn.classList.add("gold-button");
          const fact = factories[factoryIndex];
          const nextProd = fact.products[currentProductIndex + 1];
          if (!nextProd) {
            btn.innerText = `${upg.name} (Max)`;
            btn.disabled = true;
          } else {
            btn.innerText = `${upg.name} ($${formatNumber(upg.cost)})`;
          }
        } else if (upg.effect === "increaseBatch") {
          btn.innerText = `${upg.name} ($${formatNumber(upg.cost)})`;
        } else {
          btn.innerText = `${upg.name} ($${formatNumber(upg.cost)})`;
        }
        btn.title = upg.description;

        btn.onclick = () => purchaseUpgrade(index);
        container.appendChild(btn);
      });
    }

    function purchaseUpgrade(index) {
      const upg = upgrades[index];
      if (shiftDown || spaceDown) {
        let done = 0;
        while (money >= upg.cost) {
          if (!attemptUpgradePurchase(upg, index)) break;
          done++;
        }
        if (done>0) updateUI();
      } else {
        attemptUpgradePurchase(upg, index);
        updateUI();
      }
    }

    function attemptUpgradePurchase(upg, i) {
      if (money >= upg.cost) {
        money -= upg.cost;
        upg.purchased++;
        if (upg.name === "‚öôÔ∏è Speedy Assembly") {
          cooldownTime *= upg.effect;
        } else if (upg.name === "üè≠ Factory Expansion") {
          cooldownTime *= upg.effect;
        } else if (upg.name === "Product Upgrade") {
          const fact = factories[factoryIndex];
          if (currentProductIndex < fact.products.length - 1) {
            currentProductIndex++;
          }
        } else if (upg.effect === "increaseBatch") {
          productBatch++;
        } else {
          multiplier *= upg.effect;
        }

        // Cost scaling
        if (upg.purchased < 5) {
          upg.cost = Math.round(upg.cost * 1.6);
        } else {
          upg.cost = Math.round(upg.cost * 2.5);
        }
        return true;
      }
      return false;
    }

    /* =======================
       EMPLOYEES
    ========================== */
    function renderEmployees() {
      const container = document.getElementById("employees");
      container.innerHTML = "";
      employees.forEach((emp, index) => {
        const btn = document.createElement("button");
        btn.className = "button employee";
        // Hide references to selling if selling is locked
        let desc = emp.description;
        if (!sellingUnlocked) {
          desc = desc.replace(/(selling|backpack)[^\(]*/gi, "(locked until after Prestige)");
        }
        btn.title = desc;
        btn.innerText = `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        btn.onclick = () => purchaseEmployee(index);
        container.appendChild(btn);
      });
    }

    function purchaseEmployee(index) {
      const emp = employees[index];
      if (shiftDown || spaceDown) {
        while (money >= emp.cost) {
          if (!attemptEmployeePurchase(emp)) break;
        }
        updateUI();
      } else {
        attemptEmployeePurchase(emp);
        updateUI();
      }
    }

    function attemptEmployeePurchase(emp) {
      if (money >= emp.cost) {
        money -= emp.cost;
        emp.quantity++;
        emp.purchased++;
        if (emp.purchased < 5) {
          emp.cost = Math.round(emp.cost * 1.5);
        } else {
          emp.cost = Math.round(emp.cost * 2.2);
        }
        return true;
      }
      return false;
    }

    function renderEmployeeTraining() {
      if (employeeTraining.unlocked && !employeeTraining.purchased) {
        const container = document.getElementById("upgrades");
        const btn = document.createElement("button");
        btn.className = "button upgrade";
        btn.innerText = `üèãÔ∏è Employee Training ($${formatNumber(employeeTraining.cost)})`;
        btn.title = employeeTraining.description;
        btn.onclick = () => {
          purchaseEmployeeTraining();
          updateUI();
        };
        container.appendChild(btn);
      }
    }

    function purchaseEmployeeTraining() {
      if (money >= employeeTraining.cost) {
        money -= employeeTraining.cost;
        employeeTraining.purchased = true;
        employees.forEach(emp => {
          emp.rate = Math.round(emp.rate * employeeTraining.effect);
        });
      }
    }

    // Passive Income
    setInterval(() => {
      const totalProduction = employees.reduce((sum, e) => sum + (e.rate * e.quantity), 0);
      if (totalProduction>0) {
        let earned = totalProduction * multiplier * prestigeMulti;
        money += earned;
        totalEarned += earned;
        updateUI();
      }
    }, 1000);

    /* =======================
       PRODUCE PRODUCT
    ========================== */
    document.getElementById("produce").addEventListener("click", () => {
      if (!producing) {
        manualProduce();
      }
    });

    function manualProduce() {
      producing = true;
      let cd = cooldownTime;
      const interval = setInterval(() => {
        cd -= 100;
        if (cd>0) {
          document.getElementById("cooldown").innerText = `‚è≥ Cooldown: ${formatCooldown(cd)}`;
        } else {
          clearInterval(interval);
          // If selling is unlocked, product goes to backpack
          // else, you get money instantly
          if (sellingUnlocked) {
            let canFit = backpackCapacity - backpackUsed;
            let toProduce = productBatch;
            if (toProduce>canFit) {
              toProduce = canFit;
            }
            backpackUsed += toProduce;
          } else {
            // old system: get money immediately
            let fact = factories[factoryIndex];
            let p = fact.products[currentProductIndex];
            let baseValue = p.base * multiplier * prestigeMulti * productBatch;

            // VIP check
            if (Math.random() < vipChance) {
              baseValue *= vipMultiplier;
              showNotification(`VIP order! +${vipMultiplier}x bonus`);
            }
            money += baseValue;
            totalEarned += baseValue;
          }
          totalProductsProduced++;
          checkChallenge();
          updateUI();
          producing = false;
          document.getElementById("cooldown").innerText = "‚è≥ Cooldown: Ready";
        }
      }, 100);
    }

    function checkChallenge() {
      if (!challengeBonusApplied && totalProductsProduced >= 100) {
        multiplier *= 1.1;
        challengeBonusApplied = true;
        showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
      }
    }

    /* =======================
       SELLING
    ========================== */
    const sellOneBtn = document.getElementById("sellOne");
    const sellAllBtn = document.getElementById("sellAll");
    let sellingInterval = null;

    sellOneBtn.addEventListener("click", () => {
      if (!selling) sellNProducts(1);
    });
    sellAllBtn.addEventListener("click", () => {
      if (!selling) sellNProducts(backpackUsed);
    });

    function sellNProducts(num) {
      if (backpackUsed<=0) return;
      selling = true;
      let amountToSell = Math.min(num, backpackUsed);
      let stime = sellingTime;
      let cd = stime;

      sellingInterval = setInterval(() => {
        cd -= 100;
        document.getElementById("sellCooldown").innerText = "üïí Selling Timer: " + formatCooldown(cd);
        if (cd<=0) {
          clearInterval(sellingInterval);
          // get money for "amountToSell"
          let p = factories[factoryIndex].products[currentProductIndex];
          let valPer = p.base * multiplier * prestigeMulti;
          let totalVal = valPer * amountToSell;
          money += totalVal;
          totalEarned += totalVal;
          backpackUsed -= amountToSell;
          showNotification(`Sold ${amountToSell} items for $${formatNumber(totalVal)}`);
          document.getElementById("sellCooldown").innerText = "üïí Selling Timer: Ready";
          selling = false;
          updateUI();
        }
      }, 100);
    }

    // Auto produce/sell checks
    setInterval(() => {
      if (autoProduce && !producing && backpackUsed<backpackCapacity) {
        manualProduce();
      }
      if (autoSell && !selling && backpackUsed>0) {
        sellNProducts(backpackUsed);
      }
    }, 250);

    // Selling Upgrades
    function renderSellingUpgrades() {
      const container = document.getElementById("sellingUpgrades");
      container.innerHTML = "";
      sellingUpgrades.forEach((upg) => {
        const btn = document.createElement("button");
        btn.className = "button sell-upgrade";
        if (upg.gold) btn.classList.add("gold-button"); // golden backpack

        btn.innerText = `${upg.name} - $${formatNumber(upg.cost)}`;
        btn.title = upg.desc;
        btn.onclick = () => {
          if (shiftDown || spaceDown) {
            while (money>= upg.cost) {
              if (!attemptSellingUpgrade(upg)) break;
            }
            updateUI();
          } else {
            attemptSellingUpgrade(upg);
            updateUI();
          }
        };
        container.appendChild(btn);
      });
    }

    function attemptSellingUpgrade(upg) {
      if (money>= upg.cost) {
        money -= upg.cost;
        upg.purchased++;
        backpackCapacity += upg.effect;
        // Scale cost
        if (upg.purchased<5) {
          upg.cost = Math.round(upg.cost * 1.7);
        } else {
          upg.cost = Math.round(upg.cost * 2.5);
        }
        return true;
      }
      return false;
    }

    /* =======================
       PRESTIGE
    ========================== */
    function updatePrestigeMenu() {
      document.getElementById("livePP").innerText = prestigePoints;
      let potentialPP = 0;
      let localEarn = totalEarned;
      let localCount = 0;
      let tempNextCost = nextPPcost;

      while (localEarn>=tempNextCost) {
        localCount++;
        localEarn -= tempNextCost;
        tempNextCost*=1.2;
      }
      potentialPP= localCount;
      document.getElementById("earnedPP").innerText= potentialPP;

      const fact = factories[factoryIndex];
      document.getElementById("currentFactory").innerText = fact.name;
      const nextF = factories[factoryIndex+1] ? factories[factoryIndex+1].name : "None";
      document.getElementById("nextFactory").innerText = nextF;
      document.getElementById("baseValue").innerText = formatNumber(fact.products[0].base);
      document.getElementById("bestValue").innerText = formatNumber(fact.products[fact.products.length-1].base);

      renderPrestigeUpgrades();

      let requirement = prestigeRequirements[prestigeCount] || 1e99;
      const cbtn= document.getElementById("confirmPrestige");
      if (money<requirement) {
        cbtn.disabled= true;
        cbtn.innerText= `Need $${formatNumber(requirement)} On Hand`;
      } else {
        cbtn.disabled= false;
        cbtn.innerText= "‚úî Confirm";
      }
    }

    function renderPrestigeUpgrades() {
      const cont = document.getElementById("prestigeUpgradesMenu");
      cont.innerHTML= "<h3>Prestige Upgrades (Permanent)</h3>";
      prestigeUpgrades.forEach((pupg, i) => {
        const btn= document.createElement("button");
        btn.className= "button";
        let maxTxt= pupg.max>50 ? "" : `/${pupg.max}`;
        if (pupg.max>=999) maxTxt= ""; // no displayed max if effectively infinite

        if (pupg.purchased>= pupg.max) {
          btn.innerText= `${pupg.name} (MAX)`;
          btn.disabled= true;
        } else {
          btn.innerText= `${pupg.name} (Cost: ${formatNumber(pupg.cost)} PP) [${pupg.purchased}${maxTxt}]`;
        }
        btn.title= pupg.description;
        btn.onclick= () => {
          if (prestigePoints>= pupg.cost && pupg.purchased< pupg.max) {
            prestigePoints-= pupg.cost;
            pupg.purchased++;
            applyPrestigeUpgradeEffect(pupg);
            pupg.cost= Math.round(pupg.cost*1.5);
            updateUI();
          }
        };
        cont.appendChild(btn);
      });
    }

    function applyPrestigeUpgradeEffect(pupg) {
      if (pupg.name.includes("Divine Efficiency")) {
        prestigeMulti*= pupg.effect;
      }
      else if (pupg.name.includes("Temporal Mastery")) {
        cooldownTime*= pupg.effect;
      }
      else if (pupg.name.includes("Eternal Workshop")) {
        factories.forEach(f => {
          f.products.forEach(p => {
            p.base= Math.round(p.base* pupg.effect);
          });
        });
      }
      else if (pupg.name.includes("Auto Tycoon")) {
        // stage 1 => autoProduce, stage 2 => autoSell
        if (pupg.purchased===1) {
          autoProduce= true;
          showNotification("Auto Production Unlocked!");
        } else if (pupg.purchased===2) {
          autoSell= true;
          showNotification("Auto Selling Unlocked!");
        }
      }
      else if (pupg.name.includes("Prestige Pure Multi")) {
        prestigeMulti*= pupg.effect;
      }
      else if (pupg.name.includes("VIP Client Order")) {
        vipChance+= pupg.effect; 
        if (vipChance>0.3) vipChance=0.3;
        vipMultiplier*=1.05;
      }
    }

    // Confirm Prestige
    document.getElementById("confirmPrestige").addEventListener("click", () => {
      let requirement= prestigeRequirements[prestigeCount] || 1e99;
      if (money>= requirement) {
        // find how many PP we get
        let localEarn= totalEarned;
        let localCount=0;
        let tmp= nextPPcost;
        while (localEarn>= tmp) {
          localCount++;
          localEarn-= tmp;
          tmp*=1.2;
        }
        prestigePoints+= localCount;
        nextPPcost= tmp;

        prestigeCount++;
        // do full reset
        money=0;
        multiplier=1;
        cooldownTime= baseCooldownTime;
        currentProductIndex=0;
        totalProductsProduced=0;
        challengeBonusApplied=false;
        productBatch=1;

        // keep prestigeMulti from upgrades
        if (factoryIndex< factories.length-1) {
          factoryIndex++;
        }

        // Reset normal upgrades/employees
        upgrades= [
          { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
          { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
          { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product tier.", purchased: 0 },
          { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
          { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
        ];
        employees= [
          {
            name: "üë∑ Efficient Operator",
            cost: 75,
            rate: 1,
            quantity: 0,
            description: "Generates $1/sec. (Some selling perks hidden until unlocked)",
            purchased: 0
          },
          {
            name: "üë®‚Äçüîß Skilled Worker",
            cost: 250,
            rate: 5,
            quantity: 0,
            description: "Generates $5/sec. (Some backpack perks hidden until unlocked)",
            purchased: 0
          },
          {
            name: "üõ†Ô∏è Master Craftsman",
            cost: 1000,
            rate: 20,
            quantity: 0,
            description: "Generates $20/sec.",
            purchased: 0
          },
          {
            name: "üèÜ Production Supervisor",
            cost: 4000,
            rate: 50,
            quantity: 0,
            description: "Generates $50/sec.",
            purchased: 0
          },
          {
            name: "üíº Operations Manager",
            cost: 7500,
            rate: 100,
            quantity: 0,
            description: "Generates $100/sec. (More synergy later)",
            purchased: 0
          }
        ];
        employeeTraining= {
          unlocked: false,
          cost: 150,
          effect: 1.2,
          purchased: false,
          description: "All employees +20% production."
        };
        // If we are above 0 Prestiges => selling unlocked
        if (prestigeCount>0) sellingUnlocked= true;
        if (prestigeCount<2) autoSell= false; // second stage after 2 purchases of auto upgrade

        sellingUpgrades= [
          { name: "Bigger Backpack", cost: 100, effect: 10, desc: "+10 capacity", purchased: 0, gold: false },
          { name: "Carry Suitcase", cost: 1000, effect: 25, desc: "+25 capacity", purchased: 0, gold: false },
          { name: "Storage Container", cost: 20000, effect: 100, desc: "+100 capacity", purchased: 0, gold: false },
          { name: "Abandoned School", cost: 1e6, effect: 1000, desc: "+1000 capacity", purchased: 0, gold: false },
          { name: "Golden Backpack", cost: 5e7, effect: 5000, desc: "A golden backpack with +5000 capacity", purchased: 0, gold: true }
        ];
        backpackCapacity=10;
        backpackUsed=0;

        showNotification(`Prestige #${prestigeCount}! +${localCount} PP gained.`);
        updateUI();
      }
      document.getElementById("prestigeMenu").style.display= "none";
    });

    document.getElementById("prestige").addEventListener("click", () => {
      document.getElementById("prestigeMenu").style.display="block";
      updatePrestigeMenu();
    });
    document.getElementById("closePrestige").addEventListener("click", () => {
      document.getElementById("prestigeMenu").style.display="none";
    });

    /* =======================
       STATS MENU
    ========================== */
    document.getElementById("statsBtn").addEventListener("click", () => {
      renderStats();
      document.getElementById("statsMenu").style.display="block";
    });
    document.getElementById("closeStats").addEventListener("click", () => {
      document.getElementById("statsMenu").style.display="none";
    });

    function renderStats() {
      const content= document.getElementById("statsContent");
      content.innerHTML= `
      <p><strong>Total Earned:</strong> $${formatNumber(totalEarned)}</p>
      <p><strong>Max Money Held:</strong> $${formatNumber(maxMoneyHeld)}</p>
      <p><strong>Total Produced:</strong> ${totalProductsProduced}</p>
      <p><strong>Cooldown:</strong> ${formatCooldown(cooldownTime)}</p>
      <p><strong>VIP Chance:</strong> ${(vipChance*100).toFixed(2)}%</p>
      <p><strong>VIP Multiplier:</strong> x${vipMultiplier.toFixed(2)}</p>
      <p><strong>Factory Index:</strong> ${factoryIndex+1} / ${factories.length}</p>
      <p><strong>Product Batch:</strong> ${productBatch}</p>
      <p><strong>Multiplier (Normal):</strong> x${formatNumber(multiplier)}</p>
      <p><strong>Multiplier (Prestige):</strong> x${formatNumber(prestigeMulti)}</p>
      <p><strong>Prestige Count:</strong> ${prestigeCount} / 20</p>
      <p><strong>Next PP Cost Now:</strong> $${formatNumber(nextPPcost)}</p>
      ${sellingUnlocked ? `
      <p><strong>Backpack Capacity:</strong> ${backpackCapacity}, Used: ${backpackUsed}</p>
      <p><strong>Auto Produce:</strong> ${autoProduce?"Yes":"No"}</p>
      <p><strong>Auto Sell:</strong> ${autoSell?"Yes":"No"}</p>
      ` : ""}
      `;
    }

    /* =======================
       SETTINGS MENU
    ========================== */
    const settingsBtn= document.getElementById("settingsBtn");
    const settingsMenu= document.getElementById("settingsMenu");
    const closeSettings= document.getElementById("closeSettings");
    const resetGameBtn= document.getElementById("resetGame");
    const resetTimer= document.getElementById("resetTimer");

    let resetInProgress= false;
    let resetTimeout= null;
    let countdown=10;

    settingsBtn.addEventListener("click", ()=> {
      settingsMenu.style.display= "block";
    });
    closeSettings.addEventListener("click", ()=> {
      settingsMenu.style.display= "none";
    });

    resetGameBtn.addEventListener("click", ()=> {
      if (!resetInProgress) {
        resetInProgress= true;
        countdown=10;
        resetTimer.innerText= `Reset in 10s... (Click 'Undo' or refresh to cancel)`;
        // disable saving
        // Provide an "undo" button
        let undoBtn= document.createElement("button");
        undoBtn.className= "button";
        undoBtn.innerText= "Undo Reset";
        undoBtn.onclick= () => {
          resetInProgress= false;
          clearInterval(resetTimeout);
          resetTimer.innerText= "";
          undoBtn.remove();
          showNotification("Reset canceled. Progress saved again.");
          saveGame(); 
        };
        settingsMenu.appendChild(undoBtn);

        resetTimeout= setInterval(()=>{
          countdown--;
          resetTimer.innerText= `Reset in ${countdown}s... (Click 'Undo' or refresh to cancel)`;
          if (countdown<=0) {
            clearInterval(resetTimeout);
            // wipe
            localStorage.clear();
            resetInProgress= false;
            location.reload();
          }
        },1000);
      }
    });

    /* =======================
       ON LOAD
    ========================== */
    window.onload= ()=> {
      if (prestigeCount>0) sellingUnlocked= true; 
      updateUI();
    };
  </script>
</body>
</html>
