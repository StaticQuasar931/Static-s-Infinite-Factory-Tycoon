<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static's Infinite Factory Tycoon</title>
  <style>
    /* ===========================
       GLOBAL STYLES
    ============================ */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
      transition: background 0.5s ease;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
      position: relative;
    }
    .button {
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      transition: background 0.3s;
      display: inline-block;
    }
    .button:hover {
      background-color: #0056b3;
    }
    .gold-button {
      background-color: #FFD700 !important;
      color: #000 !important;
      font-weight: normal;
    }
    .money-line {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .cooldown {
      font-size: 14px;
      color: #bbb;
    }
    .upgrade-container,
    .selling-container,
    .employee-container {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .upgrade,
    .employee {
      flex: 1 1 45%;
      margin: 5px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .upgrade:hover,
    .employee:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    /* Modals: Prestige, Stats, Settings, Sell Explanation */
    .modal-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      z-index: 10000;
      max-width: 80%;
      font-size: 14px;
    }
    .modal-menu h2 {
      margin-top: 0;
    }
    /* Notification */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 20000;
      max-width: 70%;
      font-size: 16px;
    }
    /* QR bottom-left */
    .qr-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 200px;
      height: 200px;
      z-index: 1500;
    }
    .qr-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* Disabled produce button if backpack is full */
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Notification Box -->
  <div class="notification" id="notificationBox"></div>

  <div class="container">
    <p class="money-line">
      üí∞ Money: $<span id="money">0</span>
      | üåü Prestige Points: <span id="prestigePoints">0</span>
    </p>
    <p>
      üîÑ Multiplier: x<span id="multiplier">1.00</span>
      | Prestige Multi: x<span id="prestigeMulti">1.00</span>
    </p>

    <h2>üè≠ Factory Production</h2>
    <p>üè≠ Factory: <span id="factoryName"></span></p>
    <p>
      üì¶ Product: <span id="productName"></span>
      (<span id="prodUsed"></span>/‚àû)
      (Base: <span id="productBase">0</span>, Batch: <span id="productBatch">1</span>)
    </p>
    <button class="button" id="produce" title="...">üöÄ Produce Product</button>
    <p class="cooldown" id="cooldown">‚è≥ Cooldown: Ready</p>

    <!-- SELLING SYSTEM (Hidden until after 1st Prestige) -->
    <div class="selling-container" id="sellingArea" style="display:none;">
      <h2>üíº Selling System</h2>
      <p>
        Backpack: <span id="backpackUsed">0</span> / <span id="backpackCapacity">0</span>
      </p>
      <button class="button" id="sellOne">Sell 1</button>
      <button class="button" id="sellAll">Sell All</button>
      <p class="cooldown" id="sellCooldown">üïí Selling Timer: Ready</p>
      <div id="sellingUpgrades"></div>
    </div>

    <!-- Upgrades -->
    <div class="upgrade-container">
      <h2 style="width:100%">üìà Upgrades</h2>
      <div id="upgrades"></div>
    </div>

    <!-- Employees (below selling) -->
    <div class="employee-container">
      <h2 style="width:100%">üë• Employees</h2>
      <div id="employees"></div>
    </div>

    <!-- Buttons for Prestige, Stats, Settings -->
    <div style="margin-top:20px;">
      <button class="button" id="prestige">üîÑ Prestige</button>
      <button class="button" id="statsBtn">üìä Stats</button>
      <button class="button" id="settingsBtn">‚öô Settings</button>
    </div>

    <p style="margin-top:30px;">
      Made By
      <a href="https://sites.google.com/view/staticquasar931" target="_blank" style="color:#00d1ff;">
        Static
      </a>
    </p>
  </div>

  <!-- Double-Sized QR bottom-left (200x200) -->
  <div class="qr-container">
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
      <img 
        src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png"
        alt="Qr Code linking to Static's site"
        title="Click to visit Static's site"
      />
    </a>
  </div>

  <!-- Prestige Menu -->
  <div class="modal-menu" id="prestigeMenu">
    <h2>üîÑ Prestige Confirmation</h2>
    <p>Prestiging resets your money, normal upgrades, employees, backpack, and on-hand products.</p>
    <p>Your on-hand requirement grows each Prestige (1K, 50M, 50B...). PP are gained from total earned but each new point costs more than the last.</p>
    <p>Current PP: <span id="livePP">0</span></p>
    <p>Potential New PP: <span id="earnedPP">0</span></p>
    <p>üè≠ Current Factory: <span id="currentFactory"></span></p>
    <p>üè≠ Next Factory: <span id="nextFactory"></span></p>
    <p>üì¶ Base Value: <span id="baseValue"></span></p>
    <p>üì¶ Best Value: <span id="bestValue"></span></p>
    <div id="prestigeUpgradesMenu"></div>

    <button class="button" id="confirmPrestige">‚úî Confirm</button>
    <button class="button" id="closePrestige">‚ùå Cancel</button>
  </div>

  <!-- Stats Menu -->
  <div class="modal-menu" id="statsMenu">
    <h2>üìä Player Stats</h2>
    <div id="statsContent"></div>
    <button class="button" id="closeStats">‚ùå Close</button>
  </div>

  <!-- Settings Menu -->
  <div class="modal-menu" id="settingsMenu">
    <h2>‚öô Settings</h2>
    <p>Manage various features here. Some info remains hidden until certain unlocks.</p>
    <p style="color:#f33;font-weight:bold;">
      Warning: The <em>Undo</em> may not work on some browsers if you refresh quickly.
    </p>
    <button class="button" id="resetGame">üîÅ Reset Progress</button>
    <p id="resetTimer" style="color:#f55;"></p>
    <button class="button" id="closeSettings">‚ùå Close</button>
  </div>

  <!-- Sell Explanation Popup (after 1st Prestige) -->
  <div class="modal-menu" id="sellExplain" style="display:none;">
    <h2>üåü New System Unlocked!</h2>
    <p>
      You've discovered a new <strong>Selling System</strong>!<br/>
      From now on, producing a product places it into your backpack instead of immediately earning money.<br/>
      Press "Sell 1" or "Sell All" to convert those products into cash, or buy the "Auto Tycoon" prestige upgrade to automate it!
    </p>
    <button class="button" id="closeSellExplain">Got It</button>
  </div>

  <script>
    "use strict";

    /* ======================
       1. NUMBER FORMATTING
    ======================= */
    function formatNumber(num) {
      if (num === 0) return "0.00";
      const abs = Math.abs(num);
      const sign = (num < 0) ? "-" : "";

      if (abs >= 1e22) {
        return sign + abs.toExponential(3);
      }
      const scale = [
        { v: 1e3, l: "K" },
        { v: 1e6, l: "M" },
        { v: 1e9, l: "B" },
        { v: 1e12, l: "T" },
        { v: 1e15, l: "Q" },
        { v: 1e18, l: "Qi" },
        { v: 1e21, l: "Si" }
      ];
      for (let i = scale.length - 1; i >= 0; i--) {
        if (abs >= scale[i].v) {
          return sign + (abs / scale[i].v).toFixed(2) + " " + scale[i].l;
        }
      }
      return sign + abs.toFixed(2);
    }

    function formatCooldown(ms) {
      if (ms <= 0) return "0s";
      let s = ms / 1000;
      if (s >= 1) {
        // up to 2 decimals
        let str = s.toFixed(2).replace(/\.00$/, "");
        return str + "s";
      }
      let str = s.toFixed(4).replace(/0+$/, "");
      return str + "s";
    }

    /* ======================
       2. GAME STATE
    ======================= */
    let money = parseFloat(localStorage.getItem("money")) || 0;
    let totalEarned = parseFloat(localStorage.getItem("totalEarned")) || 0;
    let prestigePoints = parseInt(localStorage.getItem("prestigePoints")) || 0;
    let multiplier = parseFloat(localStorage.getItem("multiplier")) || 1;
    let prestigeMulti = parseFloat(localStorage.getItem("prestigeMulti")) || 1;
    let totalProductsProduced = parseInt(localStorage.getItem("totalProductsProduced")) || 0;
    let productBatch = parseInt(localStorage.getItem("productBatch")) || 1;
    let factoryIndex = parseInt(localStorage.getItem("factoryIndex")) || 0;
    let currentProductIndex = parseInt(localStorage.getItem("currentProductIndex")) || 0;
    let cooldownTime = parseFloat(localStorage.getItem("cooldownTime")) || 5000;
    let lastSaveTime = parseInt(localStorage.getItem("lastSaveTime")) || Date.now();

    // track challenges
    let challengeBonusApplied = (localStorage.getItem("challengeBonusApplied") === "true");

    // max money held
    let maxMoneyHeld = parseFloat(localStorage.getItem("maxMoneyHeld")) || 0;
    // vip
    let vipChance = parseFloat(localStorage.getItem("vipChance")) || 0.05; 
    let vipMultiplier = parseFloat(localStorage.getItem("vipMultiplier")) || 20; 
    // prestige system
    let prestigeCount = parseInt(localStorage.getItem("prestigeCount")) || 0;
    let nextPPcost = parseFloat(localStorage.getItem("nextPPcost")) || 1000;

    // SELLING
    let sellingUnlocked = (prestigeCount > 0);
    let backpackCapacity = parseInt(localStorage.getItem("backpackCapacity")) || 10;
    let backpackUsed = parseInt(localStorage.getItem("backpackUsed")) || 0;
    let sellingTime = 3000;
    let selling = false;
    let autoProduce = false;
    let autoSell = false;

    // SHIFT/SPACE detection
    let shiftDown = false;
    let spaceDown = false;

    // Are we in the 10s reset window?
    let resetInProgress = false;

    // For offline progress
    const now = Date.now();
    const diffMs = now - lastSaveTime;
    const diffSec = Math.floor(diffMs / 1000);
    // We'll grant offline production from employees only:
    let offlineProduction = 0;

    /* FACTORIES & PRODUCTS */
    const factories = [
      {
        name: "üß∏ Children's Toys Factory",
        bg: "linear-gradient(to right, #ff9a9e, #fad0c4)",
        products: [
          { name: "Wooden Blocks", base: 10 },
          { name: "Toy Cars", base: 15 },
          { name: "Stuffed Animals", base: 20 },
          { name: "Puzzle Games", base: 25 },
          { name: "Action Figures", base: 30 },
          { name: "Dollhouses", base: 35 },
          { name: "Remote Control Cars", base: 40 },
          { name: "Educational Kits", base: 45 },
          { name: "Model Trains", base: 50 },
          { name: "Custom Playsets", base: 60 }
        ]
      },
      /* ... other factories (omitted for brevity) ... */
      {
        name: "üîû Adult Toys Factory",
        bg: "linear-gradient(to right, #4f0000, #8b0000)",
        products: [
          { name: "Basic Toys", base: 200 },
          { name: "Novelty Items", base: 500 },
          { name: "Special Editions", base: 800 },
          { name: "Themed Sets", base: 1200 },
          { name: "Remote-Controlled", base: 1800 },
          { name: "Luxury Models", base: 2500 },
          { name: "Smart Devices", base: 4000 },
          { name: "Premium Kits", base: 6000 },
          { name: "Custom Orders", base: 10000 },
          { name: "Futuristic Concepts", base: 20000 }
        ]
      }
    ];

    /* Upgrades & Employees, etc. */
    let upgrades = JSON.parse(localStorage.getItem("upgrades")) || [
      { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
      { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
      { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product tier.", purchased: 0 },
      { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
      { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
    ];

    let employees = JSON.parse(localStorage.getItem("employees")) || [
      {
        name: "üë∑ Worker #1",
        cost: 75,
        rate: 1,
        quantity: 0,
        // We'll keep the second perk hidden until unlocked
        description: "Generates $1/sec. ??? ???",
        purchased: 0
      },
      {
        name: "üë®‚Äçüîß Worker #2",
        cost: 250,
        rate: 5,
        quantity: 0,
        description: "Generates $5/sec. ??? ???",
        purchased: 0
      },
      {
        name: "üõ†Ô∏è Worker #3",
        cost: 1000,
        rate: 20,
        quantity: 0,
        description: "Generates $20/sec.",
        purchased: 0
      }
      // Add more employees if you want
    ];

    let employeeTraining = JSON.parse(localStorage.getItem("employeeTraining")) || {
      unlocked: false,
      cost: 150,
      effect: 1.2,
      purchased: false,
      description: "All employees +20% production."
    };

    // Prestige Upgrades (Auto Tycoon cost is much higher now, e.g. 500)
    let prestigeUpgrades = JSON.parse(localStorage.getItem("prestigeUpgrades")) || [
      {
        name: "Divine Efficiency ‚ú®",
        cost: 5,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Temporal Mastery ‚è≥",
        cost: 10,
        effect: 0.95,
        description: "Cooldown -5%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Eternal Workshop üè≠",
        cost: 25,
        effect: 1.25,
        description: "Product base value +25%.",
        purchased: 0,
        max: 999
      },
      {
        name: "Auto Tycoon (Stage)",
        cost: 500,  // increased
        effect: "autoStage",
        description: "Stage 1 => Auto Produce, Stage 2 => Auto Sell.",
        purchased: 0,
        max: 2
      },
      {
        name: "Prestige Pure Multi",
        cost: 20,
        effect: 1.1,
        description: "Prestige Multi +10%.",
        purchased: 0,
        max: 999
      },
      {
        name: "VIP Client Order",
        cost: 30,
        effect: 0.02,
        description: "VIP chance +2% (max 30%), VIP multiplier +5%.",
        purchased: 0,
        max: 500
      },
      {
        name: "Selling Speed Mastery",
        cost: 50,
        effect: 0.9,
        description: "Selling time -10%.",
        purchased: 0,
        max: 10
      }
    ];

    // Single button for backpacks
    // We'll keep an array of backpack data in code, but display them one at a time
    let backpackIndex = parseInt(localStorage.getItem("backpackIndex")) || 0;
    let backpackData = JSON.parse(localStorage.getItem("backpackData"));
    if (!backpackData) {
      // 30 items + infinite hole expansions
      backpackData = [];
      for(let i=1;i<=30;i++){
        backpackData.push({
          name: `Backpack #${i}`,
          cost: Math.round(100 * Math.pow(2.5, i)),
          effect: 10 * i
        });
      }
      backpackData.push({
        name: "A Hole",
        cost: 1e8,
        effect: 1000
      });
      backpackData.push({
        name: "A Bigger Hole",
        cost: 5e9,
        effect: 5000
      });
    }

    // Selling Upgrades: "Selling Multi," "Faster Sell," "Bulk Sell"...
    // We'll store them in a single array if you want multiple. Let's do a small approach:
    let sellingUpgrades = JSON.parse(localStorage.getItem("sellingUpgrades")) || [
      { name: "Selling Multi", cost: 1000, effect: 1.5, desc: "Earnings from selling +50%.", purchased: 0 },
      { name: "Faster Sell", cost: 5000, effect: 0.85, desc: "Selling time -15%.", purchased: 0 },
      { name: "Bulk Sell", cost: 15000, effect: 2, desc: "Double items sold at once (still WIP).", purchased: 0 }
    ];

    // Offline progress from employees only
    setTimeout(()=>{
      let eRate = employees.reduce((sum,e)=> sum+(e.rate* e.quantity),0);
      if(eRate>0 && diffSec>0){
        let earned = eRate * multiplier * prestigeMulti * diffSec;
        money+=earned;
        totalEarned+=earned;
        showNotification(`You earned $${formatNumber(earned)} while offline for ${diffSec}s!`);
        updateUI();
      }
    },50);

    /* ======================
       SAVE
    ======================= */
    function saveGame(){
      if(resetInProgress) return;
      localStorage.setItem("money", money);
      localStorage.setItem("totalEarned", totalEarned);
      localStorage.setItem("prestigePoints", prestigePoints);
      localStorage.setItem("multiplier", multiplier);
      localStorage.setItem("prestigeMulti", prestigeMulti);
      localStorage.setItem("cooldownTime", cooldownTime);
      localStorage.setItem("totalProductsProduced", totalProductsProduced);
      localStorage.setItem("challengeBonusApplied", challengeBonusApplied);
      localStorage.setItem("productBatch", productBatch);
      localStorage.setItem("factoryIndex", factoryIndex);
      localStorage.setItem("currentProductIndex", currentProductIndex);
      localStorage.setItem("maxMoneyHeld", maxMoneyHeld);
      localStorage.setItem("vipChance", vipChance);
      localStorage.setItem("vipMultiplier", vipMultiplier);
      localStorage.setItem("prestigeCount", prestigeCount);
      localStorage.setItem("nextPPcost", nextPPcost);

      localStorage.setItem("upgrades", JSON.stringify(upgrades));
      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("employeeTraining", JSON.stringify(employeeTraining));
      localStorage.setItem("prestigeUpgrades", JSON.stringify(prestigeUpgrades));

      localStorage.setItem("sellingUnlocked", sellingUnlocked);
      localStorage.setItem("backpackCapacity", backpackCapacity);
      localStorage.setItem("backpackUsed", backpackUsed);
      localStorage.setItem("backpackIndex", backpackIndex);
      localStorage.setItem("backpackData", JSON.stringify(backpackData));
      localStorage.setItem("sellingUpgrades", JSON.stringify(sellingUpgrades));
      localStorage.setItem("lastSaveTime", Date.now());
    }

    /* ======================
       SHIFT/SPACE
    ======================= */
    window.addEventListener("keydown",(e)=>{
      if(e.key==="Shift") shiftDown=true;
      if(e.code==="Space") spaceDown=true;
    });
    window.addEventListener("keyup",(e)=>{
      if(e.key==="Shift") shiftDown=false;
      if(e.code==="Space") spaceDown=false;
    });

    /* ======================
       NOTIFICATION
    ======================= */
    function showNotification(msg){
      const box= document.getElementById("notificationBox");
      box.innerText= msg;
      box.style.display="block";
      setTimeout(()=> { box.style.display="none"; },3000);
    }

    /* ======================
       BACKGROUND & UI
    ======================= */
    function updateBackground(){
      document.body.style.background= factories[factoryIndex].bg;
    }
    function updateUI(){
      if(money>maxMoneyHeld) maxMoneyHeld= money;
      document.getElementById("money").innerText= formatNumber(money);
      document.getElementById("prestigePoints").innerText= prestigePoints;
      document.getElementById("multiplier").innerText= formatNumber(multiplier);
      document.getElementById("prestigeMulti").innerText= formatNumber(prestigeMulti);

      // product info
      const fact= factories[factoryIndex];
      document.getElementById("factoryName").innerText= fact.name;
      const prod= fact.products[currentProductIndex];
      document.getElementById("productName").innerText= prod.name;
      document.getElementById("productBase").innerText= formatNumber(prod.base);
      document.getElementById("productBatch").innerText= productBatch;
      document.getElementById("prodUsed").innerText= totalProductsProduced;

      // produce button tooltip => how much you get + cd
      let potentialMoney=  prod.base * multiplier * prestigeMulti * productBatch;
      if(Math.random()< vipChance){
        // can't exactly do random. We'll do an average or simply mention possible VIP
        potentialMoney*= vipMultiplier; 
      }
      let tip= `Potential Earn: ~$${formatNumber(potentialMoney)} per batch\nCooldown: ${formatCooldown(cooldownTime)}`;
      if(shiftDown|| spaceDown){
        tip+= "\n(Mass Buy Mode)";
      }
      document.getElementById("produce").title= tip;

      // selling
      if(sellingUnlocked){
        document.getElementById("sellingArea").style.display="block";
        document.getElementById("backpackUsed").innerText= backpackUsed;
        document.getElementById("backpackCapacity").innerText= backpackCapacity;
      }else{
        document.getElementById("sellingArea").style.display="none";
      }

      // if backpack is full => disable produce
      const produceBtn= document.getElementById("produce");
      if(sellingUnlocked && backpackUsed>= backpackCapacity){
        produceBtn.classList.add("disabled");
        produceBtn.disabled= true;
      } else {
        produceBtn.classList.remove("disabled");
        produceBtn.disabled= false;
      }

      renderUpgrades();
      renderSellingUpgrades();
      renderEmployees();
      renderEmployeeTraining();
      updatePrestigeMenu();
      updateBackground();
      saveGame();
    }

    /* ======================
       3. RENDER UPGRADES
    ======================= */
    function renderUpgrades(){
      const cont= document.getElementById("upgrades");
      cont.innerHTML="";
      upgrades.forEach((upg,i)=>{
        const btn= document.createElement("button");
        btn.className="button upgrade";
        if(upg.name==="Product Upgrade") btn.classList.add("gold-button");

        let label= upg.name;
        if(shiftDown|| spaceDown) label+= " (Mass Buy)";
        label+= ` ($${formatNumber(upg.cost)})`;
        btn.innerText= label;
        btn.title= upg.description;

        if(upg.name==="Product Upgrade"){
          // if product is max => disable
          const f= factories[factoryIndex];
          if(currentProductIndex>= f.products.length-1){
            btn.disabled= true;
            btn.innerText= `${upg.name} (Max)`;
          }
        }
        btn.onclick= ()=> purchaseUpgrade(i);
        cont.appendChild(btn);
      });
    }
    function purchaseUpgrade(i){
      const upg= upgrades[i];
      if(shiftDown|| spaceDown){
        let done=0;
        while(money>= upg.cost){
          if(!attemptUpgradePurchase(upg)) break;
          done++;
        }
        if(done>0) updateUI();
      }else{
        attemptUpgradePurchase(upg);
        updateUI();
      }
    }
    function attemptUpgradePurchase(upg){
      if(money>= upg.cost){
        money-= upg.cost;
        upg.purchased++;
        if(upg.name==="‚öôÔ∏è Speedy Assembly" || upg.name==="üè≠ Factory Expansion"){
          cooldownTime*= upg.effect;
        } else if(upg.name==="Product Upgrade"){
          const f= factories[factoryIndex];
          if(currentProductIndex< f.products.length-1) currentProductIndex++;
        } else if(upg.effect==="increaseBatch"){
          productBatch++;
        } else {
          multiplier*= upg.effect;
        }
        // scale cost
        if(upg.purchased<5) upg.cost= Math.round(upg.cost*1.6);
        else upg.cost= Math.round(upg.cost*2.5);
        return true;
      }
      return false;
    }

    /* ======================
       SELLING UPGRADES
    ======================= */
    function renderSellingUpgrades(){
      const cont= document.getElementById("sellingUpgrades");
      cont.innerHTML="";

      if(!sellingUnlocked) return; // hide if not unlocked

      // Single button for backpack
      const backpackBtn= document.createElement("button");
      backpackBtn.className="button";
      let bItem= backpackData[backpackIndex];
      let label= `${bItem.name} (Cost: $${formatNumber(bItem.cost)})`;
      if(shiftDown|| spaceDown) label+= " (Mass Buy)";
      backpackBtn.innerText= label;
      backpackBtn.title= `Upgrade your storage (+${bItem.effect} capacity)`;
      backpackBtn.onclick= ()=>{
        if(shiftDown|| spaceDown){
          while(money>= bItem.cost){
            if(!purchaseBackpack(bItem)) break;
          }
          updateUI();
        } else {
          purchaseBackpack(bItem);
          updateUI();
        }
      };
      cont.appendChild(backpackBtn);

      // Next: some standard ‚ÄúSelling Multi,‚Äù ‚ÄúFaster Sell,‚Äù etc.
      sellingUpgrades.forEach((su,i)=>{
        const btn= document.createElement("button");
        btn.className="button upgrade";
        let label= su.name+ ` ($${formatNumber(su.cost)})`;
        if(shiftDown|| spaceDown) label+= " (Mass Buy)";
        btn.innerText= label;
        btn.title= su.desc;
        btn.onclick= ()=>{
          if(shiftDown|| spaceDown){
            while(money>= su.cost){
              if(!attemptSellingUpgrade(su)) break;
            }
            updateUI();
          } else {
            attemptSellingUpgrade(su);
            updateUI();
          }
        };
        cont.appendChild(btn);
      });
    }
    function purchaseBackpack(bItem){
      if(money>= bItem.cost){
        money-= bItem.cost;
        backpackCapacity+= bItem.effect;
        // move to next index if < length
        if(backpackIndex< backpackData.length-1) backpackIndex++;
        return true;
      }
      return false;
    }
    function attemptSellingUpgrade(su){
      if(money>= su.cost){
        money-= su.cost;
        su.purchased++;
        if(su.name.includes("Selling Multi")){
          multiplier*= su.effect;  // or you can do "selling multi" => a separate variable for selling
        } else if(su.name.includes("Faster Sell")){
          sellingTime*= su.effect;
        } else if(su.name.includes("Bulk Sell")){
          // some effect
          productBatch= Math.round(productBatch* su.effect);
        }
        // scale cost
        su.cost= Math.round(su.cost*1.6);
        return true;
      }
      return false;
    }

    /* ======================
       EMPLOYEES
    ======================= */
    function renderEmployees(){
      const cont= document.getElementById("employees");
      cont.innerHTML="";
      employees.forEach((emp,i)=>{
        const btn= document.createElement("button");
        btn.className="button employee";
        let label= `${emp.name} (x${emp.quantity}) - $${formatNumber(emp.cost)}`;
        if(shiftDown|| spaceDown) label+= " (Mass Buy)";
        let desc= emp.description;
        // if we have unlocked selling => reveal the second perk
        if(sellingUnlocked && desc.includes("???")){
          desc= desc.replace("??? ???","Has special synergy with Selling/Backpack!");
        }
        btn.innerText= label;
        btn.title= desc;
        btn.onclick= ()=>{
          if(shiftDown|| spaceDown){
            while(money>=emp.cost){
              if(!attemptEmployeePurchase(emp)) break;
            }
            updateUI();
          } else {
            attemptEmployeePurchase(emp);
            updateUI();
          }
        };
        cont.appendChild(btn);
      });
    }
    function attemptEmployeePurchase(emp){
      if(money>= emp.cost){
        money-= emp.cost;
        emp.quantity++;
        emp.purchased++;
        if(emp.purchased<5){
          emp.cost= Math.round(emp.cost*1.5);
        } else{
          emp.cost= Math.round(emp.cost*2.2);
        }
        return true;
      }
      return false;
    }
    function renderEmployeeTraining(){
      if(employeeTraining.unlocked && !employeeTraining.purchased){
        const cont= document.getElementById("upgrades");
        const btn= document.createElement("button");
        btn.className="button upgrade";
        let label= `Employee Training ($${formatNumber(employeeTraining.cost)})`;
        if(shiftDown|| spaceDown) label+= " (Mass Buy)";
        btn.innerText= label;
        btn.title= employeeTraining.description;
        btn.onclick= ()=>{
          if(money>= employeeTraining.cost){
            money-= employeeTraining.cost;
            employeeTraining.purchased= true;
            employees.forEach(e=> e.rate= Math.round(e.rate* employeeTraining.effect));
            updateUI();
          }
        };
        cont.appendChild(btn);
      }
    }

    /* Passive Income from employees (1-second intervals). We'll do 1 second, no problem. */
    setInterval(()=>{
      let totalEmpProd= employees.reduce((sum,e)=> sum+(e.rate* e.quantity),0);
      if(totalEmpProd>0){
        let earned= totalEmpProd* multiplier* prestigeMulti;
        money+=earned;
        totalEarned+=earned;
        updateUI();
      }
    },1000);

    /* ======================
       PRODUCE
    ======================= */
    let producing=false;
    let produceInterval=null;
    document.getElementById("produce").addEventListener("click", ()=>{
      if(!producing) doProduce();
    });
    function doProduce(){
      producing=true;
      let cd= cooldownTime;
      if(produceInterval) clearInterval(produceInterval);
      produceInterval= setInterval(()=>{
        cd-=50; // update every 50ms for more frequent UI
        if(cd>0){
          document.getElementById("cooldown").innerText= `‚è≥ Cooldown: ${formatCooldown(cd)}`;
        } else{
          clearInterval(produceInterval);
          // produce done
          const f= factories[factoryIndex];
          const p= f.products[currentProductIndex];
          let totalVal= p.base* multiplier* prestigeMulti* productBatch;

          if(!sellingUnlocked){
            // immediate money
            if(Math.random()<vipChance){
              totalVal*= vipMultiplier;
              showNotification(`VIP order! +${vipMultiplier}x bonus`);
            }
            money+=totalVal;
            totalEarned+=totalVal;
          }else{
            // goes to backpack
            let spaceLeft= backpackCapacity- backpackUsed;
            let actual= productBatch> spaceLeft? spaceLeft: productBatch;
            backpackUsed+= actual;
          }
          totalProductsProduced++;
          if(!challengeBonusApplied && totalProductsProduced>=100){
            multiplier*=1.1;
            challengeBonusApplied=true;
            showNotification("Challenge Completed: Production Mastery! +10% multiplier.");
          }
          producing=false;
          document.getElementById("cooldown").innerText= "‚è≥ Cooldown: Ready";
          updateUI();
        }
      },50);
    }

    /* ======================
       SELLING
    ======================= */
    let sellingInterval=null;
    document.getElementById("sellOne").addEventListener("click", ()=>{
      if(!selling) sellN(1);
    });
    document.getElementById("sellAll").addEventListener("click", ()=>{
      if(!selling) sellN(backpackUsed);
    });
    function sellN(n){
      if(backpackUsed<=0) return;
      selling=true;
      let cd= sellingTime;
      let amt= Math.min(backpackUsed,n);
      if(sellingInterval) clearInterval(sellingInterval);
      sellingInterval= setInterval(()=>{
        cd-=50;
        document.getElementById("sellCooldown").innerText= `üïí Selling Timer: ${formatCooldown(cd)}`;
        if(cd<=0){
          clearInterval(sellingInterval);
          // get money
          const f= factories[factoryIndex];
          const p= f.products[currentProductIndex];
          let val= p.base* multiplier* prestigeMulti;
          // we can incorporate the new "Selling Multi" if we wanted to store it separately
          // but for now, we just do the standard approach
          let totalVal= val* amt;
          money+= totalVal;
          totalEarned+= totalVal;
          backpackUsed-= amt;
          showNotification(`Sold ${amt} items for $${formatNumber(totalVal)}`);
          selling=false;
          document.getElementById("sellCooldown").innerText= "üïí Selling Timer: Ready";
          updateUI();
        }
      },50);
    }

    // auto produce/sell
    setInterval(()=>{
      if(autoProduce && !producing && backpackUsed< backpackCapacity){
        doProduce();
      }
      if(autoSell && !selling && backpackUsed>0){
        sellN(backpackUsed);
      }
    },200);

    /* ======================
       PRESTIGE
    ======================= */
    const prestigeMenu= document.getElementById("prestigeMenu");
    document.getElementById("prestige").addEventListener("click", ()=>{
      prestigeMenu.style.display="block";
      updatePrestigeMenu();
    });
    document.getElementById("closePrestige").addEventListener("click", ()=>{
      prestigeMenu.style.display="none";
    });
    function updatePrestigeMenu(){
      document.getElementById("livePP").innerText= prestigePoints;
      let pot=0;
      let localEarn= totalEarned;
      let tmp= nextPPcost;
      while(localEarn>=tmp){
        pot++;
        localEarn-=tmp;
        tmp*=1.2;
      }
      document.getElementById("earnedPP").innerText= pot;

      let f= factories[factoryIndex];
      document.getElementById("currentFactory").innerText= f.name;
      let nextF= factories[factoryIndex+1]? factories[factoryIndex+1].name:"None";
      document.getElementById("nextFactory").innerText= nextF;
      document.getElementById("baseValue").innerText= formatNumber(f.products[0].base);
      document.getElementById("bestValue").innerText= formatNumber(f.products[f.products.length-1].base);

      renderPrestigeUpgrades();
      // check requirement
      let reqList= [1e3,5e7,5e10,5e13,5e16,5e19,1e22,1e25,1e28,1e31,1e34,1e37,1e40,1e43,1e46,1e49,1e52,1e55,1e58,1e61];
      let needed= reqList[prestigeCount]||1e99;
      const cbtn= document.getElementById("confirmPrestige");
      if(money< needed){
        cbtn.disabled=true;
        cbtn.innerText= `Need $${formatNumber(needed)}`;
      } else{
        cbtn.disabled=false;
        cbtn.innerText= "‚úî Confirm";
      }
    }
    function renderPrestigeUpgrades(){
      const cont= document.getElementById("prestigeUpgradesMenu");
      cont.innerHTML= "<h3>Permanent Prestige Upgrades</h3>";
      prestigeUpgrades.forEach((p)=>{
        const btn= document.createElement("button");
        btn.className="button";
        let maxTxt= (p.max>=999)?"":`/${p.max}`;
        if(p.purchased>=p.max){
          btn.innerText= `${p.name} (MAX)`;
          btn.disabled=true;
        } else {
          btn.innerText= `${p.name} ($${formatNumber(p.cost)} PP) [${p.purchased}${maxTxt}]`;
        }
        btn.title= p.description;
        btn.onclick= ()=>{
          if(prestigePoints>= p.cost && p.purchased< p.max){
            prestigePoints-= p.cost;
            p.purchased++;
            applyPrestigeUpgradeEffect(p);
            p.cost= Math.round(p.cost*1.6);
            updateUI();
          }
        };
        cont.appendChild(btn);
      });
    }
    function applyPrestigeUpgradeEffect(p){
      if(p.name.includes("Divine Efficiency")){
        prestigeMulti*= p.effect;
      } else if(p.name.includes("Temporal Mastery")){
        cooldownTime*= p.effect;
      } else if(p.name.includes("Eternal Workshop")){
        factories.forEach(fac=>{
          fac.products.forEach(prod=> prod.base= Math.round(prod.base* p.effect));
        });
      } else if(p.name.includes("Auto Tycoon")){
        if(p.purchased===1){
          autoProduce=true;
          showNotification("Stage 1 Unlocked: Auto Produce");
        } else if(p.purchased===2){
          autoSell=true;
          showNotification("Stage 2 Unlocked: Auto Sell");
        }
      } else if(p.name.includes("Prestige Pure Multi")){
        prestigeMulti*= p.effect;
      } else if(p.name.includes("VIP Client Order")){
        vipChance+= p.effect;
        if(vipChance>0.3) vipChance=0.3;
        vipMultiplier*=1.05;
      } else if(p.name.includes("Selling Speed Mastery")){
        sellingTime*= p.effect;
      }
    }

    document.getElementById("confirmPrestige").addEventListener("click", ()=>{
      // check requirement
      let reqList= [1e3,5e7,5e10,5e13,5e16,5e19,1e22,1e25,1e28,1e31,1e34,1e37,1e40,1e43,1e46,1e49,1e52,1e55,1e58,1e61];
      let needed= reqList[prestigeCount]||1e99;
      if(money>= needed){
        // find PP
        let localEarn= totalEarned;
        let c=0;
        let tmp= nextPPcost;
        while(localEarn>=tmp){
          c++;
          localEarn-=tmp;
          tmp*=1.2;
        }
        prestigePoints+= c;
        nextPPcost= tmp;
        prestigeCount++;

        // reset
        money=0;
        multiplier=1;
        cooldownTime=5000;
        currentProductIndex=0;
        totalProductsProduced=0;
        challengeBonusApplied=false;
        productBatch=1;
        if(factoryIndex< factories.length-1) factoryIndex++;

        // keep prestigeMulti
        // reset normal upgrades & employees
        upgrades= [
          { name: "Quality Increase", cost: 25, effect: 1.5, description: "Production multiplier +50%.", purchased: 0 },
          { name: "‚öôÔ∏è Speedy Assembly", cost: 50, effect: 0.9, description: "Cooldown -10%.", purchased: 0 },
          { name: "Product Upgrade", cost: 250, effect: "upgradeProduct", description: "Upgrade product tier.", purchased: 0 },
          { name: "üè≠ Factory Expansion", cost: 200, effect: 0.95, description: "Cooldown -5%.", purchased: 0 },
          { name: "üì¶ Batch Production", cost: 400, effect: "increaseBatch", description: "Batch size +1.", purchased: 0 },
        ];
        employees= [
          {
            name: "üë∑ Worker #1",
            cost: 75,
            rate: 1,
            quantity: 0,
            description: "Generates $1/sec. ??? ???",
            purchased: 0
          },
          {
            name: "üë®‚Äçüîß Worker #2",
            cost: 250,
            rate: 5,
            quantity: 0,
            description: "Generates $5/sec. ??? ???",
            purchased: 0
          },
          {
            name: "üõ†Ô∏è Worker #3",
            cost: 1000,
            rate: 20,
            quantity: 0,
            description: "Generates $20/sec.",
            purchased: 0
          }
        ];
        employeeTraining= {
          unlocked: false,
          cost: 150,
          effect: 1.2,
          purchased: false,
          description: "All employees +20% production."
        };

        // reset selling
        if(prestigeCount>0) sellingUnlocked=true;
        if(prestigeCount<2) autoSell=false;
        backpackCapacity=10;
        backpackUsed=0;
        backpackIndex=0;
        // reset single button backpack data
        backpackData= [];
        for(let i=1;i<=30;i++){
          backpackData.push({
            name: `Backpack #${i}`,
            cost: Math.round(100*Math.pow(2.5,i)),
            effect: 10*i
          });
        }
        backpackData.push({ name: "A Hole", cost:1e8, effect:1000});
        backpackData.push({ name: "A Bigger Hole", cost:5e9, effect:5000});
        // sellingUpgrades
        sellingUpgrades= [
          { name: "Selling Multi", cost: 1000, effect: 1.5, desc: "Earnings from selling +50%.", purchased: 0 },
          { name: "Faster Sell", cost: 5000, effect: 0.85, desc: "Selling time -15%.", purchased: 0 },
          { name: "Bulk Sell", cost: 15000, effect: 2, desc: "Double items sold at once (still WIP).", purchased: 0 }
        ];

        showNotification(`Prestige #${prestigeCount}! Gained ${c} new PP.`);

        // If we just unlocked selling => show explanation popup
        if(prestigeCount===1){
          document.getElementById("sellExplain").style.display="block";
        }
        updateUI();
      }
      prestigeMenu.style.display="none";
    });

    // The new selling explanation
    document.getElementById("closeSellExplain").addEventListener("click", ()=>{
      document.getElementById("sellExplain").style.display="none";
    });

    /* ======================
       STATS
    ======================= */
    document.getElementById("statsBtn").addEventListener("click", ()=>{
      renderStats();
      document.getElementById("statsMenu").style.display="block";
    });
    document.getElementById("closeStats").addEventListener("click", ()=>{
      document.getElementById("statsMenu").style.display="none";
    });
    function renderStats(){
      const c= document.getElementById("statsContent");
      let out= `
      <p><strong>Total Earned:</strong> $${formatNumber(totalEarned)}</p>
      <p><strong>Max Money Held:</strong> $${formatNumber(maxMoneyHeld)}</p>
      <p><strong>Total Products Produced:</strong> ${totalProductsProduced}</p>
      <p><strong>Cooldown Time:</strong> ${formatCooldown(cooldownTime)}</p>
      <p><strong>VIP Chance:</strong> ${(vipChance*100).toFixed(2)}%</p>
      <p><strong>VIP Multiplier:</strong> x${vipMultiplier.toFixed(2)}</p>
      <p><strong>Factory Index:</strong> ${factoryIndex+1} / ${factories.length}</p>
      <p><strong>Product Batch Size:</strong> ${productBatch}</p>
      <p><strong>Multiplier (Normal):</strong> x${formatNumber(multiplier)}</p>
      <p><strong>Multiplier (Prestige):</strong> x${formatNumber(prestigeMulti)}</p>
      <p><strong>Prestige Count:</strong> ${prestigeCount}</p>
      <p><strong>Next PP Cost:</strong> $${formatNumber(nextPPcost)}</p>
      `;
      if(sellingUnlocked){
        out+= `<p><strong>Backpack Used/Cap:</strong> ${backpackUsed}/${backpackCapacity}</p>`;
        out+= `<p><strong>Auto Produce:</strong> ${autoProduce?"Yes":"No"}</p>`;
        out+= `<p><strong>Auto Sell:</strong> ${autoSell?"Yes":"No"}</p>`;
      }
      c.innerHTML= out;
    }

    /* ======================
       SETTINGS MENU
    ======================= */
    const settingsMenu= document.getElementById("settingsMenu");
    document.getElementById("settingsBtn").addEventListener("click", ()=>{
      settingsMenu.style.display="block";
    });
    document.getElementById("closeSettings").addEventListener("click", ()=>{
      settingsMenu.style.display="none";
    });

    let resetTimer= document.getElementById("resetTimer");
    document.getElementById("resetGame").addEventListener("click", ()=>{
      if(!resetInProgress){
        resetInProgress= true;
        resetTimer.innerText= "Confirm reset? You have 10s to undo after confirming.";
        // show confirm & undo
        const confirmBtn= document.createElement("button");
        confirmBtn.className="button";
        confirmBtn.innerText="Confirm Reset";
        const undoBtn= document.createElement("button");
        undoBtn.className="button";
        undoBtn.innerText="Undo";
        settingsMenu.appendChild(confirmBtn);
        settingsMenu.appendChild(undoBtn);

        confirmBtn.onclick= ()=>{
          // once confirmed => 10s countdown
          resetTimer.innerText= "Reset in 10s. Refreshing won't save progress now.";
          let cd=10;
          let interval= setInterval(()=>{
            cd--;
            resetTimer.innerText= `Reset in ${cd}s. Press Undo to cancel.`;
            if(cd<=0){
              clearInterval(interval);
              localStorage.clear();
              location.reload();
            }
          },1000);

          // remove confirmBtn so they can't double confirm
          confirmBtn.remove();
        };
        undoBtn.onclick= ()=>{
          resetInProgress= false;
          resetTimer.innerText="";
          confirmBtn.remove();
          undoBtn.remove();
          showNotification("Reset canceled. Progress saving resumed.");
          saveGame();
        };
      }
    });

    /* ======================
       INIT
    ======================= */
    function init(){
      // if we have >0 prestige => sellingUnlocked= true
      if(prestigeCount>0) sellingUnlocked= true;
      updateUI();
    }
    window.onload= init;

    // auto save
    setInterval(()=> updateUI(),10000);
  </script>
</body>
</html>
